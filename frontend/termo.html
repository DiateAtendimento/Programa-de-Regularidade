<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Termo de Regularidade Previdenci√°ria ‚Äì CRP</title>

  <!-- Webfonts (todos os pesos usados) -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=block" rel="stylesheet">

  <link rel="stylesheet" href="termo.css" />
</head>
<body>

  <!-- Bot√£o de download -->
  <div class="download-wrap">
    <button id="btn-download" class="btn-download">üì• Baixar PDF</button>
  </div>

  <!-- Raiz do conte√∫do a ser convertido -->
  <main id="pdf-root" class="term-wrap">

    <!-- Cabe√ßalho (logo na tela + t√≠tulo em 1 linha) -->
    <header class="page-head">
      <h1 id="term-title" class="term-title" title="TERMO DE REGULARIDADE PREVIDENCI√ÅRIA ‚Äì CRP">
        TERMO DE REGULARIDADE PREVIDENCI√ÅRIA ‚Äì CRP
      </h1>

      <!-- Logo para a TELA (SVG). Escondido no momento de gerar o PDF -->
      <img id="logoScreen" class="mps-logo screen-only"
           src="imagens/logo-termo-mps.svg"
           alt="Minist√©rio da Previd√™ncia Social" />
    </header>

    <section class="term-section">
      <h2>IDENTIFICA√á√ÉO</h2>
      <p><strong>1.1. Ente Federativo:</strong> {{ente}}</p>
      <p><strong>1.2. CNPJ:</strong> {{cnpj}}</p>
      <p><strong>1.3. Unidade da Federa√ß√£o:</strong> {{uf}}</p>
    </section>

    <section class="term-section">
      <h2>DADOS PESSOAIS</h2>
      <p><strong>2.1. CPF:</strong> {{cpf}}</p>
      <p><strong>2.2. Nome:</strong> {{nome}}</p>
      <p><strong>2.3. Cargo:</strong> {{cargo}}</p>
      <p><strong>2.4. Telefone:</strong> {{telefone}}</p>
      <p><strong>2.5. Email:</strong> {{email}}</p>
      <p><strong>2.6. Endere√ßo:</strong> {{endereco}}</p>
    </section>

    <section class="term-section keep-together" id="sec-5">
      <h2>CRIT√âRIOS</h2>
      <ul id="criterios-list"><!-- preenchido via JS --></ul>
    </section>

    <section class="term-section">
      <h2>DO OBJETO</h2>
      <p>
        O presente Termo tem por objeto atestar a regularidade previdenci√°ria do
        Regime Pr√≥prio de Previd√™ncia Social (RPPS) referido no item 1, com vistas
        √† emiss√£o da Certid√£o de Regularidade Previdenci√°ria (CRP), conforme disposto
        no art. 8¬∫, ¬ß 1¬∫, da Lei 10.887/2004 e na Portaria MPS n¬∫ 403/2016.
      </p>
    </section>

    <section class="term-section">
      <h2>FUNDAMENTA√á√ÉO LEGAL</h2>
      <ul>
        <li>Constitui√ß√£o Federal, art. 40, ¬ß 1¬∫, inciso III, al√≠neas ‚Äúa‚Äù e ‚Äúb‚Äù.</li>
        <li>Lei Complementar n¬∫ 101/2000 (Lei de Responsabilidade Fiscal), art. 55.</li>
        <li>Lei n¬∫ 10.887/2004, art. 8¬∫ e seguintes.</li>
        <li>Portaria MPS n¬∫ 403/2016, arts. 2¬∫ e 3¬∫.</li>
      </ul>
    </section>

    <!-- For√ßa nova p√°gina ANTES da se√ß√£o 6 e reserva espa√ßo para a logo do PDF -->
    <div class="logo-guard break-before" aria-hidden="true"></div>

    <section class="term-section" id="sec-6">
      <h2>DAS DECLARA√á√ïES</h2>
      <ul>
        <li>
          Est√° adimplente com todas as obriga√ß√µes previdenci√°rias relativas ao RPPS,
          inclusive recolhimento de contribui√ß√µes patronais e repasses destinados
          √† manuten√ß√£o do Fundo Previdenci√°rio;
        </li>
        <li>
          Encontra-se em dia com a apresenta√ß√£o dos Demonstrativos de Informa√ß√µes
          Previdenci√°rias (DIP) e dos Demonstrativos de Repasses (DPR) exigidos
          pelos √≥rg√£os de controle, na forma e nos prazos legais;
        </li>
        <li>
          N√£o possui passivos previdenci√°rios em aberto que impe√ßam a concess√£o
          da Certid√£o de Regularidade Previdenci√°ria.
        </li>
      </ul>
    </section>

    <section class="term-section">
      <h2>VIG√äNCIA DA CERTID√ÉO</h2>
      <p>
        A Certid√£o de Regularidade Previdenci√°ria (CRP) emitida com base neste Termo
        ter√° validade de 90 (noventa) dias, contados da data de sua assinatura.
      </p>
    </section>

    <section class="term-section">
      <h2>DISPOSI√á√ïES GERAIS</h2>
      <ul>
        <li>
          O presente Termo n√£o exime o Ente Federativo de futuras obriga√ß√µes, tampouco
          de cumprir requisitos adicionais exigidos por legisla√ß√£o ou instru√ß√µes
          normativas supervenientes.
        </li>
        <li>
          Eventuais irregularidades constatadas poder√£o ensejar a cassa√ß√£o ou n√£o
          renova√ß√£o da Certid√£o de Regularidade Previdenci√°ria.
        </li>
      </ul>
    </section>

    <section class="term-section">
      <h2>FORO</h2>
      <p>
        Para dirimir quaisquer d√∫vidas ou controv√©rsias decorrentes deste Termo, fica
        eleito o Foro da Comarca de {{cidade}}, renunciando as partes a
        qualquer outro, por mais privilegiado que seja.
      </p>
    </section>

    <!-- Rodap√©: data e assinatura -->
    <footer class="term-footer">
      <p class="place-date">{{cidade}}, {{dia}} de {{mes}} de {{ano}}.</p>
      <div class="signature-line" aria-hidden="true"></div>
      <p class="signature-caption">Respons√°vel Legal do Aderente ou Representante do RPPS</p>
      <p class="signature-name">{{responsavel}}</p>
    </footer>
  </main>

  <!-- Logo PNG usada para carimbar no PDF -->
  <img id="logoPng" src="imagens/logo-termo-mps.png" alt="" crossOrigin="anonymous" style="display:none" />

  <!-- libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>

  <script>
    // ======= util: substitui {{chaves}} e lista de crit√©rios =======
    (function hydrateFromQuery() {
      const params = new URLSearchParams(window.location.search);
      // placeholders
      document.querySelectorAll('.term-wrap p, .term-wrap li, .term-wrap h2').forEach(el => {
        el.innerHTML = el.innerHTML.replace(/\{\{([^{}]+)\}\}/g, (_, key) => {
          return (params.get(key) || '').toString();
        });
      });
      // crit√©rios
      const ul = document.getElementById('criterios-list');
      const criterios = params.getAll('criterios');
      criterios.forEach(text => {
        const li = document.createElement('li');
        li.textContent = text;
        ul.appendChild(li);
      });
    })();

    // ======= deixa o H1 sempre em uma linha (reduzindo fonte se necess√°rio) =======
    function fitTitleOneLine() {
      const title = document.getElementById('term-title');
      const maxPx = 28; // topo
      const minPx = 18; // piso de legibilidade
      title.style.whiteSpace = 'nowrap';
      title.style.fontSize = maxPx + 'px';
      // reduz at√© caber
      while (title.scrollWidth > title.clientWidth && parseFloat(title.style.fontSize) > minPx) {
        title.style.fontSize = (parseFloat(title.style.fontSize) - 0.5) + 'px';
      }
    }
    window.addEventListener('load', fitTitleOneLine);
    window.addEventListener('resize', fitTitleOneLine);

    // ======= helper: converte <img> em dataURL para jsPDF.addImage =======
    function imgToDataURL(imgEl) {
      return new Promise((resolve) => {
        if (imgEl.complete) {
          const canvas = document.createElement('canvas');
          canvas.width = imgEl.naturalWidth;
          canvas.height = imgEl.naturalHeight;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(imgEl, 0, 0);
          resolve(canvas.toDataURL('image/png'));
        } else {
          imgEl.onload = () => resolve(imgToDataURL(imgEl));
        }
      });
    }

    // ======= gerar PDF, centralizado e com logo em TODAS as p√°ginas =======
    document.getElementById('btn-download').addEventListener('click', async () => {
      fitTitleOneLine();

      const root = document.getElementById('pdf-root');

      // aguarda as webfonts para n√£o ‚Äútrocar‚Äù peso no PDF
      try { await document.fonts.ready; } catch {}

      // oculta a logo SVG de tela para n√£o duplicar no PDF
      root.classList.add('pdf-export');

      // carrega a logo PNG como dataURL para carimbar via jsPDF
      const logoImg = document.getElementById('logoPng');
      const logoDataUrl = await imgToDataURL(logoImg);
      const logoRatio = logoImg.naturalHeight / logoImg.naturalWidth;

      const opt = {
        margin: 0, // margens controladas pela pr√≥pria .term-wrap (padding em mm)
        filename: 'termo_crp.pdf',
        html2canvas: {
          scale: 2,
          letterRendering: 1,
          useCORS: true,
          backgroundColor: '#ffffff',
          scrollX: 0,
          scrollY: 0
        },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
        pagebreak: { mode: ['css', 'legacy'] }
      };

      // pipeline: gera PDF -> injeta logo em cada p√°gina -> salva
      const worker = html2pdf().set(opt).from(root).toPdf();

      worker.get('pdf').then(pdf => {
        const getPages = pdf.getNumberOfPages ? pdf.getNumberOfPages() : pdf.internal.getNumberOfPages();
        const pageW = pdf.internal.pageSize.getWidth();

        // mesma posi√ß√£o/tamanho em todas as p√°ginas
        const rightPadding = 15;     // mm (mesma da .term-wrap)
        const topPadding   = 15;     // mm
        const logoWmm      = 25;     // mm
        const logoHmm      = logoWmm * logoRatio;

        for (let i = 1; i <= getPages; i++) {
          pdf.setPage(i);
          pdf.addImage(logoDataUrl, 'PNG', pageW - rightPadding - logoWmm, topPadding, logoWmm, logoHmm, undefined, 'FAST');
        }
      }).save().then(() => {
        root.classList.remove('pdf-export');
      }).catch(() => {
        root.classList.remove('pdf-export');
      });
    });

    // ----- Modo autom√°tico -----
    (async function init() {
      hydrateFromQuery();
      window.addEventListener('load', fitTitleOneLine);
      window.addEventListener('resize', fitTitleOneLine);

      document.getElementById('btn-download').addEventListener('click', generatePdf);

      const auto = new URLSearchParams(location.search).get('auto');
      if (auto !== null) {
        document.documentElement.classList.add('auto-download'); // esconde enquanto gera
        await generatePdf();
        try { window.close(); } catch {}
      }
    })();

  </script>
</body>
</html>
