<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Termo de Adesão ao Programa de Regularidade Previdenciária</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=block" rel="stylesheet">
  <link href="https://fonts.cdnfonts.com/css/rawline" rel="stylesheet">
  <link rel="stylesheet" href="termo.css" />
</head>
<body>
  <main id="pdf-root" class="term-wrap">
    <header class="page-head">
      <div class="logos-wrap" aria-label="Identidade visual MPS">
        <img class="logo-sec" src="imagens/logo-secretaria-complementar.svg"
             alt="Secretaria de Regimes Próprios e Complementar" />
        <img class="logo-mps" src="imagens/logo-termo-drpps.svg"
             alt="Ministério da Previdência Social - MPS" />
        <div class="logo-rule" aria-hidden="true"></div>
      </div>

      <h1 id="term-title" class="term-title">
        FORMULÁRIO PARA GERAÇÃO DO TERMO DE ADESÃO AO PROGRAMA DE REGULARIDADE PREVIDENCIÁRIA
      </h1>
    </header>

    <!-- 1. IDENTIFICAÇÃO DO ENTE FEDERATIVO -->
    <section class="term-section">
      <h2>1. IDENTIFICAÇÃO DO ENTE FEDERATIVO</h2>

      <p><strong>1.1 Esfera de Governo</strong></p>
      <ul>
        <!-- será preenchido dinamicamente com 1.1.1 OU 1.1.2 -->
        <li id="li-esfera"></li>
      </ul>

      <p class="mt"><strong>1.2 Ente Federativo</strong></p>
      <ul>
        <li><strong>1.2.1 Ente:</strong> <span data-k="ente"></span>/<span data-k="uf"></span></li>
        <li><strong>1.2.2 CNPJ:</strong> <span data-k="cnpj_ente"></span></li>
        <li><strong>1.2.3 E-mail oficial para recebimento de comunicações do Programa:</strong> <span data-k="email_ente"></span></li>
      </ul>

      <p class="mt"><strong>1.3 Regime Próprio de Previdência Social (RPPS)</strong></p>
      <ul>
        <li><strong>1.3.1 Unidade Gestora:</strong> <span data-k="ug"></span></li>
        <li><strong>1.3.2 CNPJ:</strong> <span data-k="cnpj_ug"></span></li>
        <li><strong>1.3.3 E-mail oficial para recebimento de comunicações do Programa:</strong> <span data-k="email_ug"></span></li>
      </ul>
    </section>

    <!-- 2. RESPONSÁVEIS -->
    <section class="term-section">
      <h2>2. IDENTIFICAÇÃO DOS RESPONSÁVEIS</h2>

      <p><strong>2.1 Representante legal do ente federativo</strong></p>
      <ul>
        <li><strong>2.1.1 Nome:</strong> <span data-k="nome_rep_ente"></span></li>
        <li><strong>2.1.2 Cargo/Função:</strong> <span data-k="cargo_rep_ente"></span></li>
        <li><strong>2.1.3 CPF:</strong> <span data-k="cpf_rep_ente"></span></li>
        <li><strong>2.1.4 E-mail institucional para recebimento de comunicações do Programa:</strong> <span data-k="email_rep_ente"></span></li>
      </ul>

      <p class="mt"><strong>2.2 Representante legal do RPPS</strong></p>
      <ul>
        <li><strong>2.2.1 Nome:</strong> <span data-k="nome_rep_ug"></span></li>
        <li><strong>2.2.2 Cargo/Função:</strong> <span data-k="cargo_rep_ug"></span></li>
        <li><strong>2.2.3 CPF:</strong> <span data-k="cpf_rep_ug"></span></li>
        <li><strong>2.2.4 E-mail institucional para recebimento de comunicações do Programa:</strong> <span data-k="email_rep_ug"></span></li>
      </ul>
    </section>

    <!-- 3. CRP -->
    <section class="term-section">
      <h2>3. IDENTIFICAÇÃO DA SITUAÇÃO RELATIVA AO CERTIFICADO DE REGULARIDADE PREVIDENCIÁRIA (CRP)</h2>
      <ul>
        <li><strong>3.1 Data de vencimento do último CRP obtido:</strong> <span data-k="venc_ult_crp"></span></li>
        <li><strong>3.2 Tipo de emissão do último CRP:</strong> <span data-k="tipo_emissao_crp"></span></li>
      </ul>

      <div class="keep-together" id="sec-criterios">
        <p class="mt"><strong>3.3 Critério(s) irregular(es) no extrato previdenciário:</strong></p>
        <ul id="criterios-list"></ul>
      </div>
    </section>

    <!-- 4. FINALIDADES -->
    <section class="term-section">
      <h2>4. FINALIDADE(S) INICIAL(IS) DA ADESÃO AO PROGRAMA DE REGULARIDADE PREVIDENCIÁRIA</h2>

      <p>
        <strong>Finalidade Inicial da Adesão:</strong>
        <span id="finalidades-iniciais"></span>
      </p>

      <p class="mt"><strong>4.1 Celebração de termos de parcelamento de débitos</strong></p>
      <ul id="opt-4-1">
        <li data-code="4.1.1">4.1.1 em até sessenta parcelas, com base nas regras previstas nos arts. 14 e 15 do Ato das Disposições Constitucionais Transitórias, com a redação dada pela Emenda Constitucional nº XXX, de xxxx de 2025.</li>
        <li data-code="4.1.2">4.1.2 em até trezentas parcelas, com base nas regras previstas nos arts. 115 e 117 do Ato das Disposições Constitucionais Transitórias, com a redação dada pela Emenda Constitucional nº XXX, de xxxx de 2025, conforme disposto nos arts. 4º a 11 do Anexo XVII da Portaria MTP nº 1.467/2022.</li>
      </ul>

      <p class="mt"><strong>4.2 Regularização de pendências para a emissão administrativa e regular do CRP</strong></p>
      <ul id="opt-4-2">
        <li data-code="4.2.1">4.2.1 para entes sem decisão judicial.</li>
        <li data-code="4.2.2">4.2.2 para entes com decisão judicial, tendo em vista o disposto no acórdão do STF no RE nº 1.007.271 (Tema 968).</li>
      </ul>

      <p class="mt"><strong>4.3 Equacionamento de déficit atuarial do RPPS</strong></p>
      <ul id="opt-4-3">
        <li data-code="4.3.1">4.3.1 implementação de plano de equacionamento do déficit atuarial do RPPS.</li>
        <li data-code="4.3.2">4.3.2 prazos adicionais para comprovação de medidas visando ao equilíbrio financeiro e atuarial do RPPS e à sua adequação orçamentária, financeira e fiscal.</li>
        <li data-code="4.3.3">4.3.3 plano de equacionamento de déficit atuarial alternativo aos previstos na Portaria MTP nº 1.467/2022 (art. 55, § 7º).</li>
      </ul>

      <p class="mt"><strong>4.4 Organização do RPPS conforme os critérios estruturantes estabelecidos nas normas gerais</strong></p>
      <ul id="opt-4-4">
        <li data-code="4.4.1">4.4.1 adequação da Unidade Gestora Única do RPPS ao disposto no art. 40, § 20, da Constituição Federal.</li>
        <li data-code="4.4.2">4.4.2 cumprimento de outro critério que apresente maior complexidade.</li>
      </ul>

      <!-- 4.5 embrulhado para não quebrar -->
      <div class="keep-together" id="sec-45">
        <p class="mt"><strong>4.5 Manutenção da conformidade do RPPS às normas gerais</strong></p>
        <ul><li><span data-k="manutencao_normas"></span></li></ul>

        <p class="small mt">
          Obs.: Acesso às fases específicas/Manutenção conforme requisitos do Anexo XVIII da Portaria MTP nº 1.467/2022, certificação Pró-Gestão RPPS/ISP-RPPS e medidas dos arts. 67 a 69. Nesta fase, caso necessário, poderão ser apresentados planos de ação para CRP emergenciais.
        </p>
      </div>
    </section>

    <!-- 5. COMPROMISSOS -->
    <section class="term-section">
      <h2>5. COMPROMISSOS FIRMADOS NA ADESÃO AO PROGRAMA DE REGULARIDADE PREVIDENCIÁRIA</h2>
      <ul id="opt-5">
        <li data-code="5.1">5.1 Regularidade nos repasses e nas parcelas de acordos (art. 14 e 15, Portaria MTP nº 1.467/2022).</li>
        <li data-code="5.2">5.2 Regularidade no encaminhamento de documentos e atendimento às solicitações (art. 241).</li>
        <li data-code="5.3">5.3 Utilização dos recursos previdenciários conforme Lei nº 9.796/1999.</li>
        <li data-code="5.4">5.4 Aplicação dos recursos segundo normas do CMN.</li>
        <li data-code="5.5">5.5 Adequações na legislação do RPPS quando identificadas pela Secretaria.</li>
        <li data-code="5.6">5.6 Cumprimento dos Planos de Ação das fases Específica e de Manutenção.</li>
      </ul>
    </section>

    <!-- 6. PROVIDÊNCIAS -->
    <section class="term-section">
      <h2>6. PROVIDÊNCIAS NECESSÁRIAS PARA ADESÃO AO PROGRAMA</h2>
      <ul id="opt-6">
        <li data-code="6.1">6.1 Inclusão, no Cadprev, de todos os débitos de contribuições/valores até a data da adesão; ou</li>
        <li data-code="6.2">6.2 Declaração de inexistência de débitos (ou já regularizados) até a adesão.</li>
      </ul>
    </section>

    <!-- 7. CONDIÇÕES -->
    <section class="term-section">
      <h2>7. CONDIÇÕES PARA VIGÊNCIA DO PROGRAMA DE REGULARIDADE PREVIDENCIÁRIA</h2>
      <ul>
        <li>I – atendimento aos requisitos do art. 3º do Anexo XVIII;</li>
        <li>II – cumprimento dos planos de ação do art. 4º do Anexo XVIII;</li>
        <li>III – observância de prazos/condições do art. 6º do Anexo XVII (para parcelamentos – EC xx/2025); e/ou</li>
        <li>IV – não ingresso com ação judicial para obter CRP ou para descumprimento do Programa.</li>
      </ul>
      <p><strong>Declaração informada:</strong> <span data-k="condicao_vigencia"></span></p>
    </section>

    <!-- Assinaturas -->
    <footer class="term-footer">
      <p class="place-date"><span data-k="ente"></span>/<span data-k="uf"></span>, <span data-k="data_termo"></span>.</p>

      <div class="signature-block">
        <div class="signature-line" aria-hidden="true"></div>
        <p class="signature-caption">
          <strong><span data-k="nome_rep_ente"></span></strong><br>
          <span id="sig-cap-ente">Representante legal do Município de <span data-k="ente"></span>/<span data-k="uf"></span></span>
        </p>
      </div>

      <div class="signature-block">
        <div class="signature-line" aria-hidden="true"></div>
        <p class="signature-caption">
          <strong><span data-k="nome_rep_ug"></span></strong><br>
          Representante legal do <span data-k="ug"></span>
        </p>
      </div>
    </footer>
  </main>

  <!-- libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" referrerpolicy="no-referrer"></script>

  <script>
    window.addEventListener('load', () => {
      // ---- Comunicação com a janela que abriu (form.html) para controlar o modal "Gerando PDF"
      function sendStatus(status, extra = {}) {
        try {
          if (window.opener && typeof window.opener.postMessage === 'function') {
            window.opener.postMessage({ source: 'termo.html', kind: 'pdf', status, ...extra }, '*');
          }
        } catch(e) { /* silencioso */ }
      }

      async function waitFonts(){ try{ if(document.fonts && document.fonts.ready) await document.fonts.ready; }catch{} }
      const p = new URLSearchParams(location.search);

      function setTextAll(k, v){
        document.querySelectorAll(`[data-k="${k}"]`).forEach(el=> el.textContent = v);
      }

      function hydrate(){
        const map = {
          uf:'uf', ente:'ente', esfera:'esfera',
          cnpj_ente:'cnpj_ente', email_ente:'email_ente',
          ug:'ug', cnpj_ug:'cnpj_ug', email_ug:'email_ug',
          nome_rep_ente:'nome_rep_ente', cargo_rep_ente:'cargo_rep_ente', cpf_rep_ente:'cpf_rep_ente', email_rep_ente:'email_rep_ente',
          nome_rep_ug:'nome_rep_ug', cargo_rep_ug:'cargo_rep_ug', cpf_rep_ug:'cpf_rep_ug', email_rep_ug:'email_rep_ug',
          venc_ult_crp:'venc_ult_crp', tipo_emissao_crp:'tipo_emissao_crp',
          celebracao:'celebracao', regularizacao:'regularizacao', deficit:'deficit',
          criterios_estrut:'criterios_estrut', manutencao_normas:'manutencao_normas',
          condicao_vigencia:'condicao_vigencia', data_termo:'data_termo'
        };
        Object.entries(map).forEach(([q,k])=> setTextAll(k, (p.get(q)||'').toString()));

        // 1.1 – mostra só a opção escolhida
        const esfera = (p.get('esfera')||'').toLowerCase();
        const liEsfera = document.getElementById('li-esfera');
        if (liEsfera){
          if (esfera.includes('municip')) liEsfera.textContent = '1.1.1 RPPS Municipal';
          else if (esfera.includes('estadual') || esfera.includes('distrital')) liEsfera.textContent = '1.1.2 Estadual/Distrital';
          else liEsfera.innerHTML = '<em>Não informado.</em>';
        }

        // 3.3 – lista de critérios marcados
        const ul = document.getElementById('criterios-list'); ul.innerHTML = '';
        const criterios = [];
        for (const [k,v] of p.entries()){
          if (/^criterio\d+$/i.test(k) && v) criterios.push(v);
        }
        if (!criterios.length){
          const li = document.createElement('li'); li.innerHTML = '<em>Não informado.</em>'; ul.appendChild(li);
        } else {
          criterios.forEach(c => { const li=document.createElement('li'); li.textContent=c; ul.appendChild(li); });
        }

        // 4 – Finalidade Inicial da Adesão (mostrar rótulos completos A/B)
        const hasA = !!(p.get('celebracao')||'').trim();
        const hasB = !!(p.get('regularizacao')||'').trim();
        const labels = [];
        if (hasA) labels.push('A - Parcelamento de débitos.');
        if (hasB) labels.push('B - Regularização de pendências para emissão administrativa e regular do CRP. Detalhamento da(s) finalidade(s)');
        document.getElementById('finalidades-iniciais').textContent =
          labels.length ? labels.join(' e/ou ') : 'Não informado.';

        // 4.x – manter apenas as opções selecionadas
        filterOptions('celebracao', 'opt-4-1', [
          {code:'4.1.1', test:/4\.1\.1|sessent|60\b/i},
          {code:'4.1.2', test:/4\.1\.2|trezent|300\b/i},
        ]);
        filterOptions('regularizacao', 'opt-4-2', [
          {code:'4.2.1', test:/4\.2\.1|sem\s+decis/i},
          {code:'4.2.2', test:/4\.2\.2|com\s+decis/i},
        ]);
        filterOptions('deficit', 'opt-4-3', [
          {code:'4.3.1', test:/4\.3\.1|implementa/i},
          {code:'4.3.2', test:/4\.3\.2|prazo/i},
          {code:'4.3.3', test:/4\.3\.3|altern/i},
        ]);
        filterOptions('criterios_estrut', 'opt-4-4', [
          {code:'4.4.1', test:/4\.4\.1|unidade\s+gestora|\§\s*20/i},
          {code:'4.4.2', test:/4\.4\.2|outro\s+crit/i},
        ]);

        // 5 – mostrar somente os subitens marcados (5.1–5.6)
        filterOptionsFlexible('compromissos', 'opt-5', [
          {code:'5.1', test:/5\.?1\b|repasses|parcelas\b/i},
          {code:'5.2', test:/5\.?2\b|encaminhamento|solicita/i},
          {code:'5.3', test:/5\.?3\b|9\.796|utiliza(?:ç|c)ão dos recursos/i},
          {code:'5.4', test:/5\.?4\b|CMN|aplica(?:ç|c)ão dos recursos/i},
          {code:'5.5', test:/5\.?5\b|adequa(?:ç|c)(?:ões|ao)\s+legisla/i},
          {code:'5.6', test:/5\.?6\b|planos?\s+de\s+a(?:ç|c)[aã]o/i},
        ]);

        // 6 – mostrar somente 6.1 ou 6.2, conforme seleção
        filterOptionsFlexible('providencias', 'opt-6', [
          {code:'6.1', test:/6\.?1\b|inclus[aã]o|incluir|cadprev/i},
          {code:'6.2', test:/6\.?2\b|inexist[eê]ncia|j[aá]\s*regulariz/i},
        ]);
      }

      function filterOptions(paramKey, listId, rules){
        const raw = (p.get(paramKey)||'').toString();
        const list = document.getElementById(listId);
        if (!list) return;
        const picked = rules.filter(r => r.test.test(raw)).map(r=>r.code);
        [...list.querySelectorAll('li')].forEach(li=>{
          const code = li.getAttribute('data-code');
          if (!picked.length){ li.remove(); return; }
          if (!picked.includes(code)) li.remove();
        });
        if (!list.children.length){
          const li = document.createElement('li'); li.innerHTML = '<em>Não informado.</em>'; list.appendChild(li);
        }
      }

      // versão flexível (compromissos/providências)
      function filterOptionsFlexible(paramKey, listId, rules){
        const rawParam = (p.get(paramKey)||'').toString();
        const rawAllPairs = [...p.entries()].map(([k,v]) => `${k}=${v}`).join(' ');
        const raw = `${rawParam} ${rawAllPairs}`;

        const pickedFromQuery = new Set();
        for (const [k,v] of p.entries()) {
          if (k === 'comp' && /^5\.[1-6]$/.test(v)) pickedFromQuery.add(v);
        }

        const list = document.getElementById(listId);
        if (!list) return;

        let picked = rules.filter(r => r.test.test(raw)).map(r=>r.code);
        if (pickedFromQuery.size) {
          picked = rules.map(r=>r.code).filter(code => pickedFromQuery.has(code));
        }

        [...list.querySelectorAll('li')].forEach(li=>{
          const code = li.getAttribute('data-code');
          if (!picked.length){ li.remove(); return; }
          if (!picked.includes(code)) li.remove();
        });
        if (!list.children.length){
          const li = document.createElement('li'); li.innerHTML = '<em>Não informado.</em>'; list.appendChild(li);
        }
      }

      function fitTitle(){ const t=document.getElementById('term-title'); if (t) t.style.whiteSpace='normal'; }

      // Cabeçalho (snapshot) — usado só no fallback (html2pdf)
      async function captureHeaderDataURL(){
        const el = document.querySelector('.logos-wrap');
        const canvas = await html2canvas(el, {
          scale: 3, backgroundColor:'#fff', useCORS:true, imageTimeout:0,
          scrollX:0, scrollY:0, removeContainer:true
        });
        return { dataURL: canvas.toDataURL('image/png'), w: canvas.width, h: canvas.height };
      }

      (function adaptSignatureCaption(){
        const esfera = (p.get('esfera')||'').toLowerCase();
        const el = document.getElementById('sig-cap-ente');
        if (!el) return;
        if (esfera.includes('estadual') || esfera.includes('distrital')){
          el.innerHTML = 'Representante legal do Estado/Distrito de <span data-k="ente"></span>/<span data-k="uf"></span>';
        }
      })();

      function sanitizeFilename(s){ return String(s||'Sem município').replace(/[\\/:*?"<>|]+/g,'').trim(); }

      /* ========= Gerador PDF (fallback no navegador) ========= */
      async function generatePdfClient(){
        await waitFonts(); fitTitle();

        // Nome do arquivo
        const municipio = sanitizeFilename(p.get('ente')||'');
        const ufSafe    = sanitizeFilename(p.get('uf')||'');
        const muniUF    = municipio ? `${municipio}${ufSafe ? `-${ufSafe}` : ''}` : 'Sem municipio';
        const filename  = `Form_Prog_Reg_Prev - ${muniUF}.pdf`;

        // Cabeçalho (logos)
        const header = await captureHeaderDataURL();
        const ratio  = header.h / header.w;

        // Layout A4 em mm
        const PAGE_W_MM   = 210;
        const SIDE_PAD_MM = 15;
        const HEAD_TOP_MM = 2;
        const headerWmm   = PAGE_W_MM - 2*SIDE_PAD_MM;
        const headerHmm   = headerWmm * ratio;
        const GAP_BELOW   = 6;

        // ===== Footer inteligente: quebra só se não couber =====
        (function decideFooterBreak(){
          const root   = document.getElementById('pdf-root');
          const footer = root?.querySelector('.term-footer');
          if (!root || !footer) return;

          footer.classList.remove('footer-force-break');

          const mmToPx = v => v * (window.devicePixelRatio || 1) * 3.78;
          const pageHpx     = mmToPx(297);
          const topMarginPx = mmToPx(HEAD_TOP_MM + headerHmm + GAP_BELOW);
          const bottomPx    = mmToPx(SIDE_PAD_MM);

          const contentHpx  = pageHpx - topMarginPx - bottomPx;

          const rectRoot   = root.getBoundingClientRect();
          const rectFooter = footer.getBoundingClientRect();
          const footerTopInRoot = rectFooter.top - rectRoot.top;
          const footerHeight    = rectFooter.height;

          const fitsFirstPage = (footerTopInRoot + footerHeight) <= contentHpx;
          if (!fitsFirstPage) footer.classList.add('footer-force-break');
        })();

        // Força modo exportação também no <html> e <body> (fundo branco 100%)
        document.documentElement.classList.add('pdf-export');
        document.body.classList.add('pdf-export');
        document.getElementById('pdf-root').classList.add('pdf-export');

        const opt = {
          margin: [HEAD_TOP_MM + headerHmm + GAP_BELOW, SIDE_PAD_MM, SIDE_PAD_MM, SIDE_PAD_MM],
          filename,
          html2canvas: { scale:2, letterRendering:1, useCORS:true, backgroundColor:'#fff', scrollX:0, scrollY:0 },
          jsPDF: { unit:'mm', format:'a4', orientation:'portrait' },
          pagebreak: { mode:['css','legacy'] }
        };

        const root   = document.getElementById('pdf-root');
        const worker = html2pdf().set(opt).from(root).toPdf();

        sendStatus('start', { filename });

        await worker.get('pdf').then(pdf=>{
          const pages = pdf.getNumberOfPages ? pdf.getNumberOfPages() : pdf.internal.getNumberOfPages();
          for(let i=1;i<=pages;i++){
            pdf.setPage(i);
            pdf.addImage(header.dataURL, 'PNG', SIDE_PAD_MM, HEAD_TOP_MM, headerWmm, headerHmm, undefined, 'FAST');
          }
        }).save();

        sendStatus('done', { filename });

        document.getElementById('pdf-root').classList.remove('pdf-export');
        document.body.classList.remove('pdf-export');
        document.documentElement.classList.remove('pdf-export');
      }

      /* ========= Gerador PDF (servidor / Puppeteer) ========= */
      function buildServerPayloadFromQuery(){
        const payload = {
          UF: p.get('uf') || '',
          ENTE: p.get('ente') || '',
          CNPJ_ENTE: p.get('cnpj_ente') || '',
          EMAIL_ENTE: p.get('email_ente') || '',
          UG: p.get('ug') || '',
          CNPJ_UG: p.get('cnpj_ug') || '',
          EMAIL_UG: p.get('email_ug') || '',
          ESFERA: p.get('esfera') || '',
          NOME_REP_ENTE: p.get('nome_rep_ente') || '',
          CPF_REP_ENTE: p.get('cpf_rep_ente') || '',
          CARGO_REP_ENTE: p.get('cargo_rep_ente') || '',
          EMAIL_REP_ENTE: p.get('email_rep_ente') || '',
          NOME_REP_UG: p.get('nome_rep_ug') || '',
          CPF_REP_UG: p.get('cpf_rep_ug') || '',
          CARGO_REP_UG: p.get('cargo_rep_ug') || '',
          EMAIL_REP_UG: p.get('email_rep_ug') || '',
          DATA_VENCIMENTO_ULTIMO_CRP: p.get('venc_ult_crp') || '',
          TIPO_EMISSAO_ULTIMO_CRP: p.get('tipo_emissao_crp') || '',
          CELEBRACAO_TERMO_PARCELA_DEBITOS: p.get('celebracao') || '',
          REGULARIZACAO_PENDEN_ADMINISTRATIVA: p.get('regularizacao') || '',
          DEFICIT_ATUARIAL: p.get('deficit') || '',
          CRITERIOS_ESTRUT_ESTABELECIDOS: p.get('criterios_estrut') || '',
          MANUTENCAO_CONFORMIDADE_NORMAS_GERAIS: p.get('manutencao_normas') || '',
          // aceitamos tanto 'compromisso' quanto 'compromissos'
          COMPROMISSO_FIRMADO_ADESAO: p.get('compromisso') || p.get('compromissos') || '',
          PROVIDENCIA_NECESS_ADESAO: p.get('providencias') || '',
          CONDICAO_VIGENCIA: p.get('condicao_vigencia') || '',
          DATA_TERMO_GERADO: p.get('data_termo') || ''
        };

        // critérios irregulares em array
        const crit = [];
        for (const [k,v] of p.entries()){
          if (/^criterio\d+$/i.test(k) && v) crit.push(v);
        }
        payload.CRITERIOS_IRREGULARES = crit;
        return payload;
      }

      async function generatePdfServer(){
        await waitFonts(); fitTitle();

        // nome de fallback
        const municipio = sanitizeFilename(p.get('ente')||'');
        const ufSafe    = sanitizeFilename(p.get('uf')||'');
        const muniUF    = municipio ? `${municipio}${ufSafe ? `-${ufSafe}` : ''}` : 'Sem municipio';
        let filename    = `Form_Prog_Reg_Prev - ${muniUF}.pdf`;

        sendStatus('start', { filename });

        try{
          const resp = await fetch('/api/termo-pdf', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            mode: 'cors',
            body: JSON.stringify(buildServerPayloadFromQuery())
          });

          if (!resp.ok) {
            // tenta ler JSON de erro
            let errText = 'Falha ao gerar PDF no servidor.';
            try { const j = await resp.json(); if (j && j.error) errText = j.error; } catch {}
            throw new Error(errText);
          }

          // tenta extrair filename do Content-Disposition
          const cd = resp.headers.get('Content-Disposition') || '';
          const m = cd.match(/filename\*?=(?:UTF-8''|")?([^\";]+)/i);
          if (m && m[1]) {
            try { filename = decodeURIComponent(m[1].replace(/"/g,'')); } catch { filename = m[1].replace(/"/g,''); }
          }

          const blob = await resp.blob();
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url; a.download = filename;
          document.body.appendChild(a); a.click();
          setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 500);

          sendStatus('done', { filename });
        } catch (err){
          sendStatus('error', { message: (err && err.message) ? err.message : String(err) });
          // fallback automático para o gerador no navegador
          try { await generatePdfClient(); } catch(e){ /* último recurso: log */ console.error(e); }
        }
      }

      // init
      (function init(){
        hydrate(); fitTitle();
        sendStatus('ready'); // página pronta

        const auto = new URLSearchParams(location.search).get('auto');
        const engine = (new URLSearchParams(location.search).get('engine') || 'server').toLowerCase();

        if (auto !== null){
          document.documentElement.classList.add('auto-download');
          // prioriza servidor (Puppeteer com SVG no header). Se engine=client, força fallback.
          if (engine === 'client') {
            generatePdfClient()
              .then(()=>{ try{ window.close(); }catch{} })
              .catch(err=>{
                sendStatus('error', { message: (err && err.message) ? err.message : String(err) });
                try{ console.error(err); }catch{}
              });
          } else {
            generatePdfServer()
              .then(()=>{ try{ window.close(); }catch{} })
              .catch(err=>{
                sendStatus('error', { message: (err && err.message) ? err.message : String(err) });
                try{ console.error(err); }catch{}
              });
          }
        }
      })();
    });
  </script>
</body>
</html>
