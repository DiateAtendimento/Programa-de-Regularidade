<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Termo de Adesão ao Programa de Regularidade Previdenciária</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=block" rel="stylesheet">
  <link rel="stylesheet" href="termo.css" />
</head>
<body>
  <main id="pdf-root" class="term-wrap">
    <header class="page-head">
      <div class="logos-wrap" aria-label="Identidade visual MPS">
        <img class="logo-sec" src="imagens/logo-secretaria-complementar.svg"
             alt="Secretaria de Regimes Próprios e Complementar" crossorigin="anonymous" />
        <img class="logo-mps" src="imagens/logo-termo-drpps.svg"
             alt="Ministério da Previdência Social - MPS" crossorigin="anonymous" />
        <div class="logo-rule" aria-hidden="true"></div>
      </div>

      <h1 id="term-title" class="term-title">
        TERMO DE ADESÃO AO PROGRAMA DE REGULARIDADE PREVIDENCIÁRIA DOS REGIMES PRÓPRIOS DE PREVIDÊNCIA SOCIAL (RPPS)
      </h1>
    </header>

    <section class="term-section small">
      <h2>FORMULÁRIO PARA GERAÇÃO DO TERMO DE ADESÃO AO PROGRAMA DE REGULARIDADE PREVIDENCIÁRIA</h2>
      <p>O presente Termo de Adesão do Programa de Regularidade Previdenciária terá validade a partir da data do seu encaminhamento ao Ministério da Previdência Social por meio do Sistema de Gestão de Consultas e Normas – Gescon-RPPS.</p>
      <p>A solicitação de CRP emergencial na vigência do Programa deverá ser efetuada por meio de Termo específico de Solicitação de CRP Emergencial.</p>
    </section>

    <section class="term-section">
      <h2>1. IDENTIFICAÇÃO</h2>
      <ul>
        <li><strong>Ente Federativo:</strong> <span data-k="ente"></span></li>
        <li><strong>UF:</strong> <span data-k="uf"></span></li>
        <li><strong>CNPJ do Ente:</strong> <span data-k="cnpj_ente"></span></li>
        <li><strong>UG:</strong> <span data-k="ug"></span></li>
        <li><strong>CNPJ da UG:</strong> <span data-k="cnpj_ug"></span></li>
      </ul>
    </section>

    <section class="term-section">
      <h2>2. REPRESENTANTES</h2>
      <p><strong>2.1. Do Ente</strong></p>
      <ul>
        <li><strong>Nome:</strong> <span data-k="nome_rep_ente"></span></li>
        <li><strong>CPF:</strong> <span data-k="cpf_rep_ente"></span></li>
        <li><strong>Cargo:</strong> <span data-k="cargo_rep_ente"></span></li>
        <li><strong>E-mail:</strong> <span data-k="email_rep_ente"></span></li>
      </ul>

      <p class="mt"><strong>2.2. Da Unidade Gestora (UG)</strong></p>
      <ul>
        <li><strong>Nome:</strong> <span data-k="nome_rep_ug"></span></li>
        <li><strong>CPF:</strong> <span data-k="cpf_rep_ug"></span></li>
        <li><strong>Cargo:</strong> <span data-k="cargo_rep_ug"></span></li>
        <li><strong>E-mail:</strong> <span data-k="email_rep_ug"></span></li>
      </ul>
    </section>

    <section class="term-section">
      <h2>3. INFORMAÇÕES SOBRE O CRP</h2>
      <ul>
        <li><strong>Data de vencimento do último CRP:</strong> <span data-k="venc_ult_crp"></span></li>
        <li><strong>Tipo de emissão do último CRP:</strong> <span data-k="tipo_emissao_crp"></span></li>
      </ul>
    </section>

    <section class="term-section keep-together" id="sec-criterios">
      <h2>4. CRITÉRIOS COM IRREGULARIDADES</h2>
      <ul id="criterios-list"></ul>
      <p class="small"><em>Obs.: os critérios listados acima foram informados no formulário no momento da geração do termo.</em></p>
    </section>

    <section class="term-section">
      <h2>5. CLÁUSULAS E COMPROMISSOS</h2>
      <ul>
        <li><strong>Celebração de termo / parcelamento de débitos:</strong> <span data-k="celebracao"></span></li>
        <li><strong>Regularização de pendências administrativas:</strong> <span data-k="regularizacao"></span></li>
        <li><strong>Déficit atuarial:</strong> <span data-k="deficit"></span></li>
        <li><strong>Critérios estruturantes:</strong> <span data-k="criterios_estrut"></span></li>
        <li><strong>Manutenção de conformidade:</strong> <span data-k="manutencao_normas"></span></li>
        <li><strong>Compromisso firmado:</strong> <span data-k="compromisso"></span></li>
        <li><strong>Providências necessárias:</strong> <span data-k="providencias"></span></li>
        <li><strong>Condição de vigência:</strong> <span data-k="condicao_vigencia"></span></li>
      </ul>
    </section>

    <div class="logo-guard break-before" aria-hidden="true"></div>

    <section class="term-section">
      <h2>6. DISPOSIÇÕES GERAIS</h2>
      <p>O presente Termo tem por finalidade registrar a adesão ao Programa de Regularidade Previdenciária.</p>
      <p>Eventuais pendências deverão ser tratadas no âmbito do ente federativo, adotando-se medidas para o seu saneamento nos prazos estabelecidos.</p>
    </section>

    <footer class="term-footer">
      <p class="place-date"><span data-k="ente"></span>/<span data-k="uf"></span>, <span data-k="data_termo"></span>.</p>

      <div class="signature-line" aria-hidden="true"></div>
      <p class="signature-caption">
        <strong>Prefeito do Município de</strong>
        &nbsp;<span data-k="ente"></span>/<span data-k="uf"></span><strong>/Governador</strong>
      </p>

      <div class="signature-line" aria-hidden="true" style="margin-top:10mm"></div>
      <p class="signature-caption">
        <strong>Representante legal do</strong> &nbsp;<span data-k="ug"></span>
      </p>
    </footer>
  </main>

  <!-- Único bundle necessário (inclui jsPDF + html2canvas) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>

  <script>
    async function waitFonts(){try{if(document.fonts&&document.fonts.ready)await document.fonts.ready;}catch{}}

    function hydrate(){
      const p=new URLSearchParams(location.search);
      const map={
        uf:'uf',ente:'ente',cnpj_ente:'cnpj_ente',ug:'ug',cnpj_ug:'cnpj_ug',
        nome_rep_ente:'nome_rep_ente',cpf_rep_ente:'cpf_rep_ente',cargo_rep_ente:'cargo_rep_ente',email_rep_ente:'email_rep_ente',
        nome_rep_ug:'nome_rep_ug',cpf_rep_ug:'cpf_rep_ug',cargo_rep_ug:'cargo_rep_ug',email_rep_ug:'email_rep_ug',
        venc_ult_crp:'venc_ult_crp',tipo_emissao_crp:'tipo_emissao_crp',
        celebracao:'celebracao',regularizacao:'regularizacao',deficit:'deficit',
        criterios_estrut:'criterios_estrut',manutencao_normas:'manutencao_normas',compromisso:'compromisso',
        providencias:'providencias',condicao_vigencia:'condicao_vigencia',data_termo:'data_termo'
      };
      Object.entries(map).forEach(([q,k])=>{
        const val=(p.get(q)||'').toString();
        document.querySelectorAll(`[data-k="${k}"]`).forEach(el=>el.textContent=val);
      });

      const ul=document.getElementById('criterios-list'); ul.innerHTML='';
      const criterios=[]; for(const [k,v] of p.entries()){ if(/^criterio\d+$/i.test(k) && v) criterios.push(v); }
      if(!criterios.length){const li=document.createElement('li'); li.innerHTML='<em>Não informado.</em>'; ul.appendChild(li);}
      else criterios.forEach(c=>{ const li=document.createElement('li'); li.textContent=c; ul.appendChild(li); });
    }

    function fitTitle(){
      const t=document.getElementById('term-title');
      if(!t) return;
      t.style.whiteSpace='normal';
    }

    // Converte SVG/PNG local em PNG base64 com proporção
    function loadAsPNG(url, targetWpx=1000){
      return new Promise(async (resolve,reject)=>{
        try{
          const resp = await fetch(url, {cache:'force-cache'});
          const blob = await resp.blob();
          const objUrl = URL.createObjectURL(blob);
          const img = new Image();
          img.crossOrigin = 'anonymous';
          img.onload = () => {
            const ratio = img.naturalHeight / (img.naturalWidth || 1);
            const w = targetWpx;
            const h = Math.max(1, Math.round(w * ratio));
            const canvas = document.createElement('canvas');
            canvas.width = w;
            canvas.height = h;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, w, h);
            URL.revokeObjectURL(objUrl);
            const dataURL = canvas.toDataURL('image/png'); // sempre PNG
            resolve({ dataURL, ratio });
          };
          img.onerror = reject;
          img.src = objUrl;
        }catch(e){ reject(e); }
      });
    }

    async function generatePdf(){
      await waitFonts(); fitTitle();

      // prepara logos como PNG (evita "UNKNOWN")
      const [secPNG, mpsPNG] = await Promise.all([
        loadAsPNG('imagens/logo-secretaria-complementar.svg', 1400),
        loadAsPNG('imagens/logo-termo-drpps.svg', 900)
      ]);

      // medidas
      const pageW = 210;
      const padMM = 15;
      const contentW = pageW - 2*padMM;

      const wSec = 82;   // mm
      const wMps = 48;   // mm
      const gap  = 6;    // mm
      const hSec = wSec * secPNG.ratio;
      const hMps = wMps * mpsPNG.ratio;
      const headerHmm = Math.max(hSec, hMps);
      const gapBelowHeader = 4;

      // esconder visualmente o cabeçalho original durante a exportação
      document.getElementById('pdf-root').classList.add('pdf-export');

      const opt={
        margin: [padMM + headerHmm + gapBelowHeader, 0, padMM, 0],
        filename:'termo_adesao_prp.pdf',
        html2canvas:{scale:2,letterRendering:1,useCORS:true,backgroundColor:'#fff',scrollX:0,scrollY:0},
        jsPDF:{unit:'mm',format:'a4',orientation:'portrait'},
        pagebreak:{mode:['css','legacy']}
      };

      const root=document.getElementById('pdf-root');
      const worker = html2pdf().set(opt).from(root).toPdf();

      await worker.get('pdf').then(pdf=>{
        const pages = pdf.getNumberOfPages ? pdf.getNumberOfPages() : pdf.internal.getNumberOfPages();
        const totalW = wSec + gap + wMps;
        const startX = padMM + (contentW - totalW)/2;
        const y = padMM;

        for(let i=1;i<=pages;i++){
          pdf.setPage(i);
          pdf.addImage(secPNG.dataURL, 'PNG', startX, y, wSec, hSec, undefined, 'FAST');
          pdf.addImage(mpsPNG.dataURL, 'PNG', startX + wSec + gap, y, wMps, hMps, undefined, 'FAST');

          // traço
          pdf.setDrawColor(215,222,232);
          pdf.setLineWidth(0.4);
          pdf.line(padMM, y + headerHmm + 1, pageW - padMM, y + headerHmm + 1);
        }
      }).save();

      document.getElementById('pdf-root').classList.remove('pdf-export');
    }

    (function init(){
      hydrate(); fitTitle();
      const auto=new URLSearchParams(location.search).get('auto');
      if(auto!==null){
        document.documentElement.classList.add('auto-download');
        generatePdf().then(()=>{ try{window.close();}catch{} });
      }
    })();
  </script>
</body>
</html>
