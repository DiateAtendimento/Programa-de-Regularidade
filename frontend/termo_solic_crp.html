<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Termo de Solicitação de CRP Emergencial</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Montserrat:wght@600;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="./termo_solic_crp.css">
</head>
<body>
  <header class="prp-header" aria-hidden="true">
    <div class="logos-wrap">
      <img src="./imagens/logo-secretaria-complementar.svg" alt="Secretaria" loading="eager" />
      <img src="./imagens/logo-termo-drpps.svg" alt="Departamento de RPPS" loading="eager" />
    </div>
  </header>

  <main class="prp-page">
    <div class="header-content">
      <h1 class="prp-title">Termo de Solicitação de CRP Emergencial</h1>
      <p class="prp-subtitle">Programa de Regularidade Previdenciária dos Regimes Próprios de Previdência Social - RPPS</p>
    </div>

    <section class="prp-section">
      <h2 class="prp-section-title">Dados da Solicitação</h2>
      <div class="prp-data-box prp-grid-1">
        <div class="prp-data-item">
          <span class="prp-label">Data da Solicitação</span>
          <span class="prp-value" data-k="DATA_SOLICITACAO"></span>
        </div>
      </div>
    </section>

    <section class="prp-section">
      <h2 class="prp-section-title">Ente Federativo Solicitante</h2>
      <div class="prp-data-box prp-grid-3">
        <div class="prp-data-item">
          <span class="prp-label">CNPJ (Ente)</span>
          <span class="prp-value" data-k="CNPJ_ENTE"></span>
        </div>
        <div class="prp-data-item">
          <span class="prp-label">Ente Federativo</span>
          <span class="prp-value" data-k="ENTE"></span>
        </div>
        <div class="prp-data-item">
          <span class="prp-label">UF</span>
          <span class="prp-value" data-k="UF"></span>
        </div>
        <div class="prp-data-item prp-span-2">
          <span class="prp-label">Esfera de Governo</span>
          <span class="prp-value" data-k="ESFERA_GOVERNO"></span>
        </div>
        <div class="prp-data-item">
          <span class="prp-label">E-mail</span>
          <span class="prp-value" data-k="EMAIL_ENTE"></span>
        </div>
      </div>
    </section>

    <section class="prp-section">
      <h2 class="prp-section-title">Unidade Gestora do RPPS</h2>
      <div class="prp-data-box prp-grid-3">
        <div class="prp-data-item">
          <span class="prp-label">CNPJ (Unidade Gestora)</span>
          <span class="prp-value" data-k="CNPJ_UG"></span>
        </div>
        <div class="prp-data-item">
          <span class="prp-label">Unidade Gestora</span>
          <span class="prp-value" data-k="UG"></span>
        </div>
        <div class="prp-data-item">
          <span class="prp-label">Situação do RPPS</span>
          <span class="prp-value" data-k="rpps_situacao"></span>
        </div>
        <div class="prp-data-item prp-span-2">
          <span class="prp-label">Órgão de vinculação</span>
          <span class="prp-value" data-k="ORGAO_VINCULACAO_UG"></span>
        </div>
        <div class="prp-data-item">
          <span class="prp-label">E-mail</span>
          <span class="prp-value" data-k="EMAIL_UG"></span>
        </div>
      </div>
    </section>

    <section class="prp-section">
      <h2 class="prp-section-title">Representantes</h2>

      <h3 class="prp-subsection-title">Representante Legal do Ente Federativo</h3>
      <div class="prp-data-box prp-grid-3">
        <div class="prp-data-item">
          <span class="prp-label">CPF</span>
          <span class="prp-value" data-k="CPF_REP_ENTE"></span>
        </div>
        <div class="prp-data-item prp-span-2">
          <span class="prp-label">Nome</span>
          <span class="prp-value" data-k="NOME_REP_ENTE"></span>
        </div>
        <div class="prp-data-item prp-span-2">
          <span class="prp-label">Cargo</span>
          <span class="prp-value" data-k="CARGO_REP_ENTE"></span>
        </div>
        <div class="prp-data-item">
          <span class="prp-label">Telefone</span>
          <span class="prp-value" data-k="TEL_REP_ENTE"></span>
        </div>
        <div class="prp-data-item prp-span-3">
          <span class="prp-label">E-mail</span>
          <span class="prp-value" data-k="EMAIL_REP_ENTE"></span>
        </div>
      </div>

      <h3 class="prp-subsection-title">Representante da Unidade Gestora</h3>
      <div class="prp-data-box prp-grid-3">
        <div class="prp-data-item">
          <span class="prp-label">CPF</span>
          <span class="prp-value" data-k="CPF_REP_UG"></span>
        </div>
        <div class="prp-data-item prp-span-2">
          <span class="prp-label">Nome</span>
          <span class="prp-value" data-k="NOME_REP_UG"></span>
        </div>
        <div class="prp-data-item prp-span-2">
          <span class="prp-label">Cargo</span>
          <span class="prp-value" data-k="CARGO_REP_UG"></span>
        </div>
        <div class="prp-data-item">
          <span class="prp-label">Telefone</span>
          <span class="prp-value" data-k="TEL_REP_UG"></span>
        </div>
        <div class="prp-data-item prp-span-3">
          <span class="prp-label">E-mail</span>
          <span class="prp-value" data-k="EMAIL_REP_UG"></span>
        </div>
      </div>
    </section>

    <section class="prp-section" data-show-if="DATA_VENC_ULTIMO_CRP">
      <h2 class="prp-section-title">Certificado de Regularidade Previdenciária (CRP) Anterior</h2>
      <div class="prp-data-box prp-grid-2">
        <div class="prp-data-item">
          <span class="prp-label">Data de Vencimento do Último CRP</span>
          <span class="prp-value" data-k="DATA_VENC_ULTIMO_CRP"></span>
        </div>
        <div class="prp-data-item">
          <span class="prp-label">Tipo de Emissão</span>
          <span class="prp-value" data-k="TIPO_EMISSAO_ULTIMO_CRP"></span>
        </div>
      </div>
    </section>

    <section class="prp-section" data-show-if="CRITERIOS_IRREGULARES">
      <h2 class="prp-section-title">Critérios Irregulares</h2>
      <p class="prp-text">Os seguintes critérios de conformidade foram identificados como irregulares:</p>
      <ul class="prp-list-items" data-k="CRITERIOS_IRREGULARES"></ul>
    </section>

    <section class="prp-section">
      <h2 class="prp-section-title">Fase do Programa Solicitada</h2>
      <div class="prp-data-box prp-grid-1">
        <div class="prp-data-item">
          <span class="prp-label">Fase</span>
          <span class="prp-value" data-k="FASE_PROGRAMA"></span>
        </div>
        <div class="prp-data-item prp-span-1" data-show-if="PRAZO_ADICIONAL_3_4">
          <span class="prp-label">Justificativa para Prazo Adicional (Item 3.4)</span>
          <span class="prp-value" data-k="PRAZO_ADICIONAL_3_4"></span>
        </div>
      </div>
    </section>

    <section class="prp-section" data-fase="4.1">
      <h3 class="prp-subsection-title">4.1 FASE GERAL/INTRODUTÓRIA – 1º CRP EMERGENCIAL</h3>
      <div class="prp-data-box prp-grid-1">
        <div class="prp-data-item">
          <span class="prp-label">Opção Selecionada</span>
          <span class="prp-value" data-k="F41_OPCAO"></span>
        </div>
      </div>
    </section>

    <section class="prp-section" data-fase="4.2" data-show-if="F42_ITENS">
      <h3 class="prp-subsection-title">4.2 FASE GERAL/INTRODUTÓRIA – 2º CRP EMERGENCIAL</h3>
      <p class="prp-text">Os seguintes critérios foram incluídos no plano de ação ou regularizados:</p>
      <ul class="prp-list-items" data-k="F42_ITENS"></ul>
    </section>

    <section class="prp-section" data-fase="4.3" data-show-if="F43_ITENS,F43_INCLUIR,F43_PLANO,F43_DESC_PLANOS">
      <h3 class="prp-subsection-title">4.3 FASE INTERMEDIÁRIA/PREPARATÓRIA – 3º CRP EMERGENCIAL</h3>

      <div class="prp-sub-section" data-show-if="F43_ITENS">
        <p class="prp-text">Os seguintes critérios do Plano de Ação foram cumpridos/regularizados:</p>
        <ul class="prp-list-items" data-k="F43_ITENS"></ul>
      </div>

      <div class="prp-sub-section" data-show-if="F4310_OPCAO">
        <p class="prp-text">4.3.10 Opção selecionada:</p>
        <p class="prp-value" data-k="F4310_OPCAO"></p>
        <div class="prp-data-item" data-show-if="F4310_LEGISLACAO">
          <span class="prp-label">Legislação Adotada</span>
          <p class="prp-value" data-k="F4310_LEGISLACAO" id="f4310-legislacao"></p>
        </div>
        <div class="prp-data-item" data-show-if="F4310_DOCS">
          <span class="prp-label">Documentos Encaminhados</span>
          <p class="prp-value" data-k="F4310_DOCS" id="f4310-docs"></p>
        </div>
      </div>

      <div class="prp-sub-section" data-show-if="F43_PLANO">
        <p class="prp-text">4.3.11 Descrição do Plano de Ação:</p>
        <p class="prp-value" data-k="F43_PLANO" id="f43-plano"></p>
      </div>

      <div class="prp-sub-section" data-show-if="F43_INCLUIR">
        <p class="prp-text">4.3.12 Solicitação de inclusão de critérios nos Planos de Ação da Fase Específica:</p>
        <p class="prp-text-bold">Critérios a serem incluídos:</p>
        <ul class="prp-list-items" id="f43-incluir" data-k="F43_INCLUIR"></ul>
        <div class="prp-data-item" data-show-if="F43_DESC_PLANOS">
          <span class="prp-label">Descrição Adicional dos Planos</span>
          <p class="prp-value" data-k="F43_DESC_PLANOS" id="f43-desc-planos"></p>
        </div>
      </div>
    </section>

    <section class="prp-section" data-fase="4.4" data-show-if="F44_CONDICOES,F44_FINALIDADES,F44_CRITERIOS,F44_ANEXOS,F445_DESC_PLANOS">
      <h3 class="prp-subsection-title">4.4 FASE ESPECÍFICA/FOCALIZADA – 4º CRP EMERGENCIAL</h3>

      <div class="prp-sub-section" data-show-if="F44_CONDICOES">
        <p class="prp-text">Condições Cumpridas:</p>
        <ul class="prp-list-items" data-k="F44_CONDICOES"></ul>
        <div class="prp-data-item" data-show-if="F441_LEGISLACAO">
          <span class="prp-label">Legislação Adotada (Condição d)</span>
          <p class="prp-value" data-k="F441_LEGISLACAO" id="f441-legislacao"></p>
        </div>
      </div>

      <div class="prp-sub-section" data-show-if="F44_FINALIDADES">
        <p class="prp-text">Finalidades do Plano de Ação:</p>
        <ul class="prp-list-items" data-k="F44_FINALIDADES"></ul>
      </div>

      <div class="prp-sub-section" data-show-if="F44_CRITERIOS">
        <p class="prp-text">Critérios Irregulares Objeto do Plano de Ação:</p>
        <ul class="prp-list-items" data-k="F44_CRITERIOS"></ul>
        <div class="prp-data-item" data-show-if="F44_ANEXOS">
          <span class="prp-label">Anexos Encaminhados</span>
          <p class="prp-value" data-k="F44_ANEXOS" id="f44-anexos"></p>
        </div>
      </div>

      <div class="prp-sub-section" data-show-if="F445_DESC_PLANOS,F446_DOCS,F446_EXEC_RES">
        <div class="prp-data-item" data-show-if="F445_DESC_PLANOS">
          <span class="prp-label">Descrição Detalhada dos Planos de Ação (4.4.5)</span>
          <p class="prp-value" data-k="F445_DESC_PLANOS" id="f445-desc-planos"></p>
        </div>
        <div class="prp-data-item" data-show-if="F446_DOCS">
          <span class="prp-label">Documentos (4.4.6)</span>
          <p class="prp-value" data-k="F446_DOCS" id="f446-docs"></p>
        </div>
        <div class="prp-data-item" data-show-if="F446_EXEC_RES">
          <span class="prp-label">Execução e Resultados (4.4.6)</span>
          <p class="prp-value" data-k="F446_EXEC_RES" id="f446-exec-res"></p>
        </div>
      </div>
    </section>

    <section class="prp-section" data-fase="4.5" data-show-if="F45_CONDICOES,F45_DOCS,F45_JUST,F453_EXEC_RES">
      <h3 class="prp-subsection-title">4.5 FASE ESPECÍFICA/FOCALIZADA – 5º CRP EMERGENCIAL</h3>

      <div class="prp-sub-section" data-show-if="F45_CONDICOES">
        <p class="prp-text">Condições Cumpridas:</p>
        <ul class="prp-list-items" data-k="F45_CONDICOES"></ul>
      </div>

      <div class="prp-sub-section" data-show-if="F45_DOCS,F45_JUST,F453_EXEC_RES">
        <div class="prp-data-item" data-show-if="F45_DOCS">
          <span class="prp-label">Documentos (4.5.2)</span>
          <p class="prp-value" data-k="F45_DOCS" id="f45-docs"></p>
        </div>
        <div class="prp-data-item" data-show-if="F45_JUST">
          <span class="prp-label">Justificativa (4.5.2)</span>
          <p class="prp-value" data-k="F45_JUST" id="f45-just"></p>
        </div>
        <div class="prp-data-item" data-show-if="F453_EXEC_RES">
          <span class="prp-label">Execução e Resultados (4.5.3)</span>
          <p class="prp-value" data-k="F453_EXEC_RES" id="f453-exec-res"></p>
        </div>
      </div>
    </section>

    <section class="prp-section" data-fase="4.6" data-show-if="F46_CONDICOES,F462_FINALIDADES,F462F_CRITERIOS,F46_PROGESTAO,F46_PORTE">
      <h3 class="prp-subsection-title">4.6 FASE DE MANUTENÇÃO DA CONFORMIDADE</h3>

      <div class="prp-sub-section" data-show-if="F46_CONDICOES">
        <p class="prp-text">Condições Cumpridas:</p>
        <ul class="prp-list-items" data-k="F46_CONDICOES"></ul>

        <div class="prp-grid-2">
          <div class="prp-data-item">
            <span class="prp-label">Nível PROGESTAO (4.6.1 b)</span>
            <p class="prp-value" data-k="F46_PROGESTAO" id="f46-progestao"></p>
          </div>
          <div class="prp-data-item">
            <span class="prp-label">Porte ISP-RPPS (4.6.1 c)</span>
            <p class="prp-value" data-k="F46_PORTE" id="f46-porte"></p>
          </div>
        </div>

        <div class="prp-data-item" data-show-if="F46_JUST_D">
          <span class="prp-label">Justificativa para Melhora (Condição d)</span>
          <p class="prp-value" data-k="F46_JUST_D" id="f46-just-d"></p>
        </div>
        <div class="prp-data-item" data-show-if="F46_DOCS_D">
          <span class="prp-label">Documentos Comprobatórios (Condição d)</span>
          <p class="prp-value" data-k="F46_DOCS_D" id="f46-docs-d"></p>
        </div>

        <div class="prp-data-item" data-show-if="F46_JUST_E">
          <span class="prp-label">Justificativa para Medidas de Acompanhamento (Condição e)</span>
          <p class="prp-value" data-k="F46_JUST_E" id="f46-just-e"></p>
        </div>
        <div class="prp-data-item" data-show-if="F46_DOCS_E">
          <span class="prp-label">Documentos Comprobatórios (Condição e)</span>
          <p class="prp-value" data-k="F46_DOCS_E" id="f46-docs-e"></p>
        </div>
      </div>

      <div class="prp-sub-section" data-show-if="F462_FINALIDADES">
        <p class="prp-text">4.6.2 Finalidades do Plano de Ação:</p>
        <ul class="prp-list-items" data-k="F462_FINALIDADES"></ul>
      </div>

      <div class="prp-sub-section" data-show-if="F462F_CRITERIOS">
        <p class="prp-text">4.6.3 Critérios Irregulares Objeto do Plano de Ação:</p>
        <ul class="prp-list-items" data-k="F462F_CRITERIOS"></ul>
        <div class="prp-data-item" data-show-if="F466_DOCS">
          <span class="prp-label">4.6.6 Documentos (Finalidade f)</span>
          <p class="prp-value" data-k="F466_DOCS" id="f466-docs"></p>
        </div>
        <div class="prp-data-item" data-show-if="F466_EXEC_RES">
          <span class="prp-label">4.6.6 Execução e Resultados (Finalidade f)</span>
          <p class="prp-value" data-k="F466_EXEC_RES" id="f466-exec-res"></p>
        </div>
      </div>
    </section>

    <section class="prp-section" data-show-if="JUSTIFICATIVAS_GERAIS">
      <h2 class="prp-section-title">Justificativas Gerais</h2>
      <p class="prp-text" data-k="JUSTIFICATIVAS_GERAIS"></p>
    </section>

    <div class="prp-footer">
      <p class="prp-text-center">Termo de Solicitação de CRP Emergencial. Gerado em <span data-k="DATA_GERACAO"></span>.</p>
    </div>

  </main>

  <script>
    /* =================================================================
       SCRIPT DE RENDERIZAÇÃO DO TERMO (PDF/HTML)
       ================================================================= */

    // Fallback/ajuste para toDateBR em ambientes que não têm solicit_crp.js
    function toDateBR(dt){
      if (!dt) return '—';
      const d = dt.split('T')[0];
      const parts = d.split('-');
      if (parts.length < 3) return dt;
      return `${parts[2]}/${parts[1]}/${parts[0]}`;
    }

    // Variáveis globais para "Não Informado"
    const __NA_LABEL__ = 'Não Informado';
    const __NA_ALL__   = '—';

    /**
     * Helper para popular campos de valor único (text, input, select).
     * @param {string} sel Seletor CSS do elemento (ex: '#nome').
     * @param {string | array} value Valor a ser inserido.
     */
    function val(sel, value){
      const el = document.querySelector(sel);
      if (!el) return;
      
      const v = Array.isArray(value) ? value.join('; ') : (String(value || '').trim() || __NA_ALL__);
      
      el.textContent = v;
      
      if (v === __NA_ALL__ && el.matches('.prp-value')){
        el.classList.add('prp-na');
      } else {
        el.classList.remove('prp-na');
      }
      
      // Controla a visibilidade da seção pai
      const parentSection = el.closest('[data-show-if]');
      if (parentSection) {
        checkSectionVisibility(parentSection);
      }
    }

    /**
     * Helper para popular listas de itens (ul/ol).
     * @param {string} sel Seletor CSS da lista.
     * @param {array<string>} items Array de strings para os itens <li>.
     */
    function liList(sel, items){
      const el = document.querySelector(sel);
      if (!el) return;
      
      const list = Array.isArray(items) ? items.filter(Boolean) : [];
      
      if (list.length === 0) {
        el.innerHTML = `<li class="prp-na">${__NA_LABEL__}</li>`;
      } else {
        el.innerHTML = list.map(item => `<li>${item}</li>`).join('');
      }
      
      // Controla a visibilidade da seção pai
      const parentSection = el.closest('[data-show-if]');
      if (parentSection) {
        checkSectionVisibility(parentSection);
      }
    }

    /**
     * Checa e ajusta a visibilidade da seção baseada nos data-show-if
     * @param {HTMLElement} section Elemento que contém data-show-if
     */
    function checkSectionVisibility(section) {
        const keys = section.getAttribute('data-show-if').split(',').map(k => k.trim()).filter(Boolean);
        const hasContent = keys.some(key => {
            const el = document.querySelector(`[data-k="${key}"]`);
            if (!el) return false;

            // Para listas (ul/ol), verifica se o conteúdo é apenas a label 'Não Informado'
            if (el.matches('ul, ol')) {
                return !el.querySelector('.prp-na');
            }
            
            // Para valores de texto, verifica se o conteúdo é o placeholder '—'
            return el.textContent.trim() !== __NA_ALL__ && el.textContent.trim() !== __NA_LABEL__;
        });

        section.style.display = hasContent ? '' : 'none';
    }


    /**
     * Ajustes finais no payload antes de renderizar (garante arrays/strings, formatação)
     * @param {object} p O payload de entrada.
     * @returns {object} O payload normalizado.
     */
    function normalizePayload(p){
      if (!p) return {};

      // 1. Coerção de datas
      p.DATA_VENC_ULTIMO_CRP = toDateBR(p.DATA_VENC_ULTIMO_CRP);
      p.DATA_SOLICITACAO     = toDateBR(p.DATA_SOLIC_GERADA) || toDateBR(new Date().toISOString().split('T')[0]);
      p.DATA_GERACAO         = toDateBR(new Date().toISOString().split('T')[0]);

      // 2. Coerção de campos de checkbox únicos que a API pode mandar como array
      if (Array.isArray(p.ESFERA_GOVERNO)) p.ESFERA_GOVERNO = p.ESFERA_GOVERNO.join('; ');
      if (Array.isArray(p.rpps_situacao))  p.rpps_situacao  = p.rpps_situacao.join('; ');

      // 3. Formatação da fase
      const faseMap = {
        'fase_41': '4.1 Fase Geral/Introdutória – 1º CRP Emergencial',
        'fase_42': '4.2 Fase Geral/Introdutória – 2º CRP Emergencial',
        'fase_43': '4.3 Fase Intermediária/Preparatória – 3º CRP Emergencial',
        'fase_44': '4.4 Fase Específica/Focalizada – 4º CRP Emergencial',
        'fase_45': '4.5 Fase Específica/Focalizada – 5º CRP Emergencial',
        'fase_46': '4.6 Fase de Manutenção da Conformidade',
      };
      // Prioriza FASE_PROGRAMA (select ou radio) mas fallback para id se só ele for enviado
      const faseStr = p.FASE_PROGRAMA || faseMap[p.FASE_PROGRAMA_ID];
      p.FASE_PROGRAMA = faseStr || __NA_ALL__;

      // --- FAZER COERÇÕES PARA ARRAYS QUE DEVEM SER STRINGS NO PDF ---
      // (A coerção para array já foi feita via `zArrStr` no Schema)

      // Junta as duas listas de inclusão F43 (se existir F43_INCLUIR_B)
      p.F43_INCLUIR = [...(p.F43_INCLUIR || []), ...(p.F43_INCLUIR_B || [])];
      
      // 4. Se a Fase for 4.1, força o valor do CNPJ_ENTE no F41_OPCAO
      if (p.FASE_PROGRAMA?.startsWith('4.1') && p.F41_OPCAO?.startsWith('4.1.1')) {
         p.F41_OPCAO = p.F41_OPCAO.replace(/\(até a data da adesão\)\./, `(até a data da adesão, CNPJ: ${p.CNPJ_ENTE}).`);
      }

      // 5. Normaliza o campo ORGAO_VINCULACAO_UG
      if (p.ORGAO_VINCULACAO_UG === 'T' || p.ORGAO_VINCULACAO_UG === 'U') {
        p.ORGAO_VINCULACAO_UG = {
          'T': 'Unidade Gestora de Regime Próprio (RPPS)',
          'U': 'Unidade Gestora de Regime Único (RU)',
        }[p.ORGAO_VINCULACAO_UG] || p.ORGAO_VINCULACAO_UG;
      }

      return p;
    }

    /**
     * Função principal de renderização.
     * @param {object} rawPayload O payload de entrada.
     */
    function run(rawPayload){
      const p = normalizePayload(rawPayload);

      // ------------------------------------------
      // 1. POPULANDO OS CAMPOS DE VALOR ÚNICO E LISTAS
      // ------------------------------------------

      // --- Dados da Solicitação ---
      val('[data-k="DATA_SOLICITACAO"]', p.DATA_SOLICITACAO);

      // --- Ente Federativo Solicitante ---
      val('[data-k="CNPJ_ENTE"]', p.CNPJ_ENTE);
      val('[data-k="ENTE"]', p.ENTE);
      val('[data-k="UF"]', p.UF);
      val('[data-k="ESFERA_GOVERNO"]', p.ESFERA_GOVERNO);
      val('[data-k="EMAIL_ENTE"]', p.EMAIL_ENTE);

      // --- Unidade Gestora do RPPS ---
      val('[data-k="CNPJ_UG"]', p.CNPJ_UG);
      val('[data-k="UG"]', p.UG);
      val('[data-k="rpps_situacao"]', p.rpps_situacao);
      val('[data-k="ORGAO_VINCULACAO_UG"]', p.ORGAO_VINCULACAO_UG);
      val('[data-k="EMAIL_UG"]', p.EMAIL_UG);

      // --- Representantes ---
      val('[data-k="CPF_REP_ENTE"]', p.CPF_REP_ENTE);
      val('[data-k="NOME_REP_ENTE"]', p.NOME_REP_ENTE);
      val('[data-k="CARGO_REP_ENTE"]', p.CARGO_REP_ENTE);
      val('[data-k="TEL_REP_ENTE"]', p.TEL_REP_ENTE);
      val('[data-k="EMAIL_REP_ENTE"]', p.EMAIL_REP_ENTE);

      val('[data-k="CPF_REP_UG"]', p.CPF_REP_UG);
      val('[data-k="NOME_REP_UG"]', p.NOME_REP_UG);
      val('[data-k="CARGO_REP_UG"]', p.CARGO_REP_UG);
      val('[data-k="TEL_REP_UG"]', p.TEL_REP_UG);
      val('[data-k="EMAIL_REP_UG"]', p.EMAIL_REP_UG);

      // --- CRP Anterior ---
      val('[data-k="DATA_VENC_ULTIMO_CRP"]', p.DATA_VENC_ULTIMO_CRP);
      val('[data-k="TIPO_EMISSAO_ULTIMO_CRP"]', p.TIPO_EMISSAO_ULTIMO_CRP);
      liList('[data-k="CRITERIOS_IRREGULARES"]', p.CRITERIOS_IRREGULARES);

      // --- Fase do Programa Solicitada ---
      val('[data-k="FASE_PROGRAMA"]', p.FASE_PROGRAMA);
      val('[data-k="PRAZO_ADICIONAL_3_4"]', p.PRAZO_ADICIONAL_3_4);

      // --- FASE 4.1 ---
      val('[data-k="F41_OPCAO"]', p.F41_OPCAO);

      // --- FASE 4.2 ---
      liList('[data-k="F42_ITENS"]', p.F42_ITENS);

      // --- FASE 4.3 ---
      liList('[data-k="F43_ITENS"]', p.F43_ITENS);
      val('[data-k="F4310_OPCAO"]', p.F4310_OPCAO);
      // F43_INCLUIR é a lista mesclada (INCLUIR + INCLUIR_B)
      liList('#f43-incluir', p.F43_INCLUIR);
      
      // --- FASE 4.4 ---
      liList('[data-k="F44_CONDICOES"]', p.F44_CONDICOES);
      liList('[data-k="F44_FINALIDADES"]', p.F44_FINALIDADES);
      liList('[data-k="F44_CRITERIOS"]', p.F44_CRITERIOS);

      // --- FASE 4.5 ---
      liList('[data-k="F45_CONDICOES"]', p.F45_CONDICOES);
      
      // --- FASE 4.6 ---
      liList('[data-k="F46_CONDICOES"]', p.F46_CONDICOES);
      liList('[data-k="F462_FINALIDADES"]', p.F462_FINALIDADES);
      liList('[data-k="F462F_CRITERIOS"]', p.F462F_CRITERIOS);

      // --- Justificativas Gerais ---
      val('[data-k="JUSTIFICATIVAS_GERAIS"]', p.JUSTIFICATIVAS_GERAIS);

      // --- Data de Geração (Rodapé) ---
      val('[data-k="DATA_GERACAO"]', p.DATA_GERACAO);


      // ------------------------------------------
      // 2. POPULANDO OS CAMPOS ANINHADOS E ESPECÍFICOS (CORREÇÃO DE EXIBIÇÃO)
      // ------------------------------------------
      
      // Esta seção garante que campos de texto e selects dentro dos modais
      // sejam corretamente preenchidos, pois não são tratados pelas listas liList.

      // --- FASE 4.3 (Campos Aninhados: Legislacao, Docs, Plano, Desc Planos) ---
      val('#f4310-legislacao', p.F4310_LEGISLACAO);
      val('#f4310-docs', p.F4310_DOCS);
      val('#f43-plano', p.F43_PLANO);
      val('#f43-desc-planos', p.F43_DESC_PLANOS);

      // --- FASE 4.4 (Campos Aninhados: Legislacao, Anexos, Planos, Docs/Execução) ---
      val('#f441-legislacao', p.F441_LEGISLACAO);
      val('#f44-anexos', p.F44_ANEXOS);
      val('#f445-desc-planos', p.F445_DESC_PLANOS);
      val('#f446-docs', p.F446_DOCS);
      val('#f446-exec-res', p.F446_EXEC_RES);

      // --- FASE 4.5 (Campos Aninhados: Docs, Justificativa, Execução) ---
      val('#f45-docs', p.F45_DOCS);
      val('#f45-just', p.F45_JUST);
      val('#f453-exec-res', p.F453_EXEC_RES);

      // --- FASE 4.6 (Campos Aninhados e Selects: Porte/ProGestão, Justificativas, Docs) ---
      val('#f46-progestao', p.F46_PROGESTAO);
      val('#f46-porte', p.F46_PORTE);
      val('#f46-just-d', p.F46_JUST_D);
      val('#f46-docs-d', p.F46_DOCS_D);
      val('#f46-just-e', p.F46_JUST_E);
      val('#f46-docs-e', p.F46_DOCS_E);
      val('#f466-docs', p.F466_DOCS);
      val('#f466-exec-res', p.F466_EXEC_RES);


      // ------------------------------------------
      // 3. VISIBILIDADE DE SEÇÕES POR FASE
      // ------------------------------------------
      
      const fase = p.FASE_PROGRAMA?.split(' ')[0] || '';
      document.querySelectorAll('[data-fase]').forEach(el => {
        el.style.display = (el.getAttribute('data-fase') === fase) ? '' : 'none';
      });

      // 4. Checagem final de visibilidade (caso alguma seção só tenha data-show-if)
      document.querySelectorAll('[data-show-if]').forEach(checkSectionVisibility);

      // Marca a página como pronta (usado por ferramentas de PDF)
      document.body.classList.add('ready');
      document.dispatchEvent(new Event('TERMO_READY'));
      
      // Tenta forçar a impressão após um breve delay (para uso em iframes)
      setTimeout(() => {
        try { window.print(); } catch (_) {}
      }, 500);
    }

    // ------------------------------------------
    // INICIALIZAÇÃO
    // ------------------------------------------
    (function init() {
      // 1. Tenta carregar dados do URL (payload_b64)
      const hash = window.location.hash.substring(1);
      const urlParams = new URLSearchParams(hash);
      const b64 = urlParams.get('payload_b64');
      
      if (b64) {
        try {
          const json = decodeURIComponent(escape(atob(b64)));
          window.__TERMO_DATA__ = JSON.parse(json);
          urlParams.delete('payload_b64'); // Limpa a hash
          window.location.hash = urlParams.toString();
        } catch(e) {
          console.error('Erro ao decodificar payload B64', e);
        }
      }

      // 2. Tenta carregar dados do sessionStorage (fallback para preview)
      if (!window.__TERMO_DATA__) {
        const previewData = sessionStorage.getItem('TERMO_SOLIC_CRP_PAYLOAD');
        if (previewData) {
          try {
            window.__TERMO_DATA__ = JSON.parse(previewData);
          } catch(e) {
            console.error('Erro ao ler payload do sessionStorage', e);
          }
        }
      }

      // 3. Execução
      if (window.__TERMO_DATA__) { try { run(window.__TERMO_DATA__); } catch {} }
      document.addEventListener('TERMO_DATA_READY', () => { try { run(window.__TERMO_DATA__ || {}); } catch {} });
      document.addEventListener('TERMO_DATA',       () => { try { run(window.__TERMO_DATA__ || {}); } catch {} });
      window.addEventListener('message', (ev) => {
        const d = ev && ev.data;
        if (!d) return;
        if (d.type === 'TERMO_DATA' || d.type === 'TERMO_DATA_READY' || d.type === 'TERMO_PREVIEW_DATA') {
          try { run(d.payload || {}); } catch (_) {}
        }
      });

      (function spinWait(maxMs=4000, step=120){
        const t0 = Date.now();
        const iv = setInterval(() => {
          if (window.__TERMO_DATA__) {
            try { run(window.__TERMO_DATA__); } catch {}
            clearInterval(iv);
          } else if (Date.now() - t0 > maxMs) {
            clearInterval(iv);
          }
        }, step);
      })();

      document.addEventListener('DOMContentLoaded', () => {
        // Fallback caso não haja injeção externa
        if (!window.__TERMO_DATA__) {
          if (window.__DEBUG_SOLIC_CRP__) console.warn('termo_solic_crp.html: Nenhum payload encontrado (URL, Session ou PostMessage).');
        }
      });
    })();
  </script>
</body>
</html>