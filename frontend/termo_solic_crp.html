<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Termo de Solicitação de CRP Emergencial</title>

  <!-- Fonte apenas para PREVIEW em tela (o PDF usa Rawline do CSS local) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Montserrat:wght@600;700&display=swap" rel="stylesheet">

  <!-- Estilos oficiais do termo (usa Rawline no PDF) -->
  <link rel="stylesheet" href="./termo_solic_crp.css">
</head>
<body>
  <!-- Cabeçalho FIXO (anti-sobreposição em 2+ páginas) -->
  <header class="prp-header" aria-hidden="true">
    <div class="logos-wrap">
      <img src="./imagens/logo-secretaria-complementar.svg" alt="Secretaria" loading="eager" />
      <img src="./imagens/logo-termo-drpps.svg" alt="Departamento de RPPS" loading="eager" />
    </div>
  </header>

  <div id="pdf-root">
    <main class="term-wrap prp-content">
      <h1 class="term-title">
        <br>TERMO DE SOLICITAÇÃO DE CRP EMERGENCIAL<br>
        PROGRAMA DE REGULARIDADE PREVIDENCIÁRIA<br>
      </h1>

      <p class="term-meta">
        Ente: <strong data-k="ente"></strong> / UF: <strong data-k="uf"></strong> • UG: <strong data-k="ug"></strong>
      </p>
      <!-- 1. IDENTIFICAÇÃO -->
      <section class="term-section avoid-break" id="sec-1">
        <h2><br>1. IDENTIFICAÇÃO DO ENTE FEDERATIVO E DA UNIDADE GESTORA</h2>

        <h3><span class="label">1.1 Esfera de Governo</span></h3>
        <div class="linha">
          <div class="titulo"></div>
          <div class="valor" data-esfera></div>
        </div>

        <h3><strong>1.2 Ente Federativo</strong></h3>
        <div class="grid grid-num">
          <div class="field"><span class="label"><strong>1.2.1 Ente</strong></span><span class="value" data-k="ente"></span></div>
          <div class="field"><span class="label"><strong>1.2.2 CNPJ</strong></span><span class="value" data-k="cnpj_ente"></span></div>
          <div class="field"><span class="label"><strong>1.2.3 E-mail oficial</strong></span><span class="value" data-k="email_ente"></span></div>
        </div>

        <h3 id="sec-1-3"><strong>1.3 Regime Próprio de Previdência Social (RPPS)</strong></h3>
        <div class="grid grid-num">
          <div class="field"><span class="label"><strong>1.3.1 Unidade Gestora</strong></span><span class="value" data-k="ug"></span></div>
          <div class="field"><span class="label"><strong>1.3.2 CNPJ</strong></span><span class="value" data-k="cnpj_ug"></span></div>
          <div class="field"><span class="label"><strong>1.3.3 E-mail oficial</strong></span><span class="value" data-k="email_ug"></span></div>
          <div class="field"><span class="label"><strong>1.3.4 Órgão de vinculação da UG</strong></span><span class="value" data-k="ORGAO_VINCULACAO_UG"></span></div>
        </div>
      </section>

      <!-- 2. IDENTIFICAÇÃO DOS RESPONSÁVEIS -->
      <section class="term-section avoid-break">
        <h2>2. IDENTIFICAÇÃO DOS RESPONSÁVEIS</h2>

        <h3><strong>2.1 Representante legal do ente federativo</strong></h3>
        <div class="grid grid-num">
          <div class="field"><span class="label"><strong>2.1.1 Nome</strong></span><span class="value" data-k="nome_rep_ente"></span></div>
          <div class="field"><span class="label"><strong>2.1.2 Cargo/Função</strong></span><span class="value" data-k="cargo_rep_ente"></span></div>
          <div class="field"><span class="label"><strong>2.1.3 CPF</strong></span><span class="value" data-k="cpf_rep_ente"></span></div>
          <div class="field"><span class="label"><strong>2.1.4 E-mail</strong></span><span class="value" data-k="email_rep_ente"></span></div>
          <div class="field"><span class="label"><strong>2.1.5 Telefone</strong></span><span class="value" data-k="tel_rep_ente"></span></div>
        </div>

        <h3>2.2 Representante legal do RPPS</h3>
        <div class="grid grid-num">
          <div class="field"><span class="label"><strong>2.2.1 Nome</strong></span><span class="value" data-k="nome_rep_ug"></span></div>
          <div class="field"><span class="label"><strong>2.2.2 Cargo/Função</strong></span><span class="value" data-k="cargo_rep_ug"></span></div>
          <div class="field"><span class="label"><strong>2.2.3 CPF</strong></span><span class="value" data-k="cpf_rep_ug"></span></div>
          <div class="field"><span class="label"><strong>2.2.4 E-mail</strong></span><span class="value" data-k="email_rep_ug"></span></div>
          <div class="field"><span class="label"><strong>2.2.5 Telefone</strong></span><span class="value" data-k="tel_rep_ug"></span></div>
        </div>
      </section>
      <!-- 3. SITUAÇÃO RELATIVA AO CRP -->
      <section class="term-section avoid-break page-break" id="sec-3">
        <h2>3. SITUAÇÃO RELATIVA AO CERTIFICADO DE REGULARIDADE PREVIDENCIÁRIA (CRP)</h2>

        <!-- 3.1 Data de vencimento do último CRP -->
        <div class="linha">
          <div class="rotulo">3.1 Data de vencimento do último CRP</div>
          <div class="valor">
            <span data-k="data_vencimento_ultimo_crp" data-fallback="DATA_VENC_ULTIMO_CRP" data-na="—"></span>
          </div>
        </div>

        <!-- 3.2 Tipo de emissão do último CRP -->
        <div class="linha">
          <div class="rotulo">3.2 Tipo de emissão do último CRP</div>
          <div class="valor">
            <span data-k="tipo_emissao_ult_crp" data-fallback="TIPO_EMISSAO_ULTIMO_CRP" data-na="—"></span>
          </div>
        </div>

        <h3>3.3 Critério(s) atualmente irregular(es) no extrato previdenciário</h3>
        <p class="small">Selecione todos os itens apontados como irregulares no extrato.</p>
        <ul id="criterios-list"
            data-empty="Sem irregularidades informadas.">
        </ul>

        <!-- 3.4 -->
        <div class="linha">
          <h2>3.4 Solicitação de Prazo Adicional</h2>
          <div class="valor">
            <div data-3_4="3.4.1">3.4.1 Manutenção da conformidade</div>
            <div data-3_4="3.4.2">3.4.2 Equacionamento do déficit atuarial (ou necessidade de prazo adicional para implementar)</div>
            <div data-3_4="3.4.3">3.4.3 Organização do RPPS conforme critérios estruturantes (inclui art. 40, § 20, CF)</div>
            <div data-3_4="3.4.4">3.4.4 Outro critério que apresente (ou possa apresentar) maior complexidade</div>
            <div data-k="PRAZO_ADICIONAL_TEXTO" class="d-none"></div>
          </div>
        </div>
      </section>
      <!-- 4. FASE DO PROGRAMA -->
      <section class="term-section avoid-break" id="sec-fase">
        <h2>4. IDENTIFICAÇÃO DA FASE DO PROGRAMA DE REGULARIDADE PREVIDENCIÁRIA</h2>
        
        <p class="small">
          Fase selecionada:
          <strong id="fase-escolhida" data-k="FASE_PROGRAMA"></strong>
        </p>
        <p class="small mt"><strong>Campos adicionais desta fase:</strong></p>
        <div id="fase-extra-campos"></div>

        <div class="avoid-break phase-block" id="fase-41" hidden>
          <h3>4.1 Fase Geral/Introdutória – 1º CRP Emergencial</h3>
          <ul id="f41-itens" class="clean-list" data-empty="Não preenchido"></ul>
        </div>

        <div class="avoid-break phase-block" id="fase-42" hidden>
          <h3>4.2 Fase Geral/Introdutória – 2º CRP Emergencial</h3>
          <p class="small"><strong>4.2.1</strong> Regularidade nos seguintes critérios do extrato previdenciário:</p>
          <ul id="f42-itens" class="styled-list" data-empty="Não preenchido"></ul>
        </div>

        <div class="avoid-break phase-block" id="fase-43" hidden>
          <h3>4.3 Fase Intermediária/Preparatória – 3º CRP Emergencial</h3>
          
          <div class="sub-section" id="f43-sub-1">
            <p class="small"><strong>4.3.1 Manutenção de regularidade nos critérios relativos a repasses, aportes e parcelamento:</strong></p>
            <ul id="f43-itens-1" class="styled-list" data-empty="Não preenchido"></ul>
          </div>
          
          <div class="sub-section" id="f43-sub-2">
            <p class="small"><strong>4.3.2 Regularidade quanto à utilização de recursos previdenciários:</strong></p>
            <ul id="f43-itens-2" class="styled-list" data-empty="Não preenchido"></ul>
          </div>

          <div class="sub-section" id="f43-sub-3">
            <p class="small"><strong>4.3.3 Regularidade quanto à aplicação dos recursos previdenciários no mercado financeiro:</strong></p>
            <ul id="f43-itens-3" class="styled-list" data-empty="Não preenchido"></ul>
          </div>
          
          <div class="sub-section" id="f43-sub-4">
            <p class="small"><strong>4.3.4 Regularidade quanto aos limites de contribuição (EC 103/2019 e Lei 9.717/1998):</strong></p>
            <ul id="f43-itens-4" class="styled-list" data-empty="Não preenchido"></ul>
          </div>
          
          <div class="sub-section" id="f43-sub-5">
            <p class="small"><strong>4.3.5 Regularidade quanto à limitação do rol de benefícios (EC 103/2019):</strong></p>
            <ul id="f43-itens-5" class="styled-list" data-empty="Não preenchido"></ul>
          </div>
          
          <div class="sub-section" id="f43-sub-6">
            <p class="small"><strong>4.3.6 Regularidade quanto à instituição por lei do Regime de Previdência Complementar – RPC:</strong></p>
            <ul id="f43-itens-6" class="styled-list" data-empty="Não preenchido"></ul>
          </div>
          
          <div class="sub-section" id="f43-sub-7">
            <p class="small"><strong>4.3.7 Regularidade quanto ao envio de dados e informações do RPPS:</strong></p>
            <ul id="f43-itens-7" class="styled-list" data-empty="Não preenchido"></ul>
          </div>
          
          <div class="sub-section" id="f43-sub-8">
            <p class="small"><strong>4.3.8 Regularidade quanto à operacionalização da compensação previdenciária:</strong></p>
            <ul id="f43-itens-8" class="styled-list" data-empty="Não preenchido"></ul>
          </div>
          
          <div class="sub-section" id="f43-sub-9">
            <p class="small"><strong>4.3.9 Regularidade quanto aos requisitos dos dirigentes e colegiados (art. 8º-B da Lei 9.717/1998):</strong></p>
            <ul id="f43-itens-9" class="styled-list" data-empty="Não preenchido"></ul>
          </div>

          <div class="sub-section" id="f43-sub-10">
              <p class="small"><strong>4.3.10 – Em relação à adequação das regras de benefícios do RPPS à Emenda Constitucional nº 103/2019:</strong></p>
              <div id="f43-opcao-a" class="field-group" hidden>
                  <p>a) Foram adotadas regras de elegibilidade, de cálculo e de reajustamento dos benefícios do RPPS (reforma das regras de benefícios)...</p>
                  <p class="label-like">Relacionar a legislação que adequou as regras de benefícios do RPPS à Emenda Constitucional nº 103/2019:</p>
                  <div class="value-block" data-k="F4310_LEGISLACAO"></div>
              </div>
              <div id="f43-opcao-b" class="field-group" hidden>
                  <p>b) Comprovamos o encaminhamento, pelo ente ao Poder Legislativo, de propostas de alteração...</p>
                  <p class="label-like">Lista de documentos anexados, que comprovam o encaminhamento dos projetos de alteração das regras de benefícios:</p>
                  <div class="value-block" data-k="F4310_DOCS"></div>
              </div>
          </div>

          <div class="sub-section" id="f43-sub-11">
              <p class="small"><strong>4.3.11 - Solicitação de inclusão de critérios nos Planos de Ação da Fase Específica</strong></p>
              <p class="label-like">a) Critérios do extrato que o ente deseja incluir no Plano de Ação da Fase Específica:</p>
              <ul id="f43-crit-incluir" class="styled-list" data-empty="Não preenchido"></ul> <p class="label-like">b) Justificativas/Informações apresentadas relativas a essa inclusão (anexos podem ser citados abaixo):</p>
              <div class="value-block" id="f43-just-11" data-field="F43_JUST" data-empty="Não informado"></div> <p class="small text-muted small">Obs.: A solicitação de inclusão no Plano de Ação não se aplica aos seguintes critérios: “DIPR - Consistência e Caráter Contributivo”; “Caráter contributivo - Repasse (objeto de PAP)” e “Utilização dos recursos previdenciários (objeto de PAP)”.</p>
          </div>

          <div class="sub-section" id="f43-sub-12">
              <p class="small"><strong>4.3.12 Solicitação de inclusão de critérios nos Planos de Ação da Fase Específica</strong></p>
              <p class="small text-muted small">Só aparecerão os critérios para assinalar se marcada a opção acima. Apresentar todos os critérios do Extrato.</p>
              <p class="label-like">a) Critérios do extrato que o ente, comprovadamente, precisará incluir em Plano de Ação:</p>
              <ul id="f43-crit-incluir-12" class="styled-list" data-empty="Não preenchido"></ul> <p class="label-like">b) Justificativas/informações apresentadas relativas à solicitação de inclusão (anexos podem ser citados abaixo):</p>
              <div class="value-block" id="f43-just-12" data-field="F4312_JUST" data-empty="Não informado"></div> <p class="label-like">c) Descrever sucintamente o(s) Plano(s) de Ação apresentado(s)</p>
              <div class="value-block" id="f43-desc-planos-12" data-field="F4312_DESC_PLANOS" data-empty="Não informado"></div> <p class="small text-muted small">Obs.: A solicitação de inclusão no Plano de Ação não se aplica aos seguintes critérios: “DIPR - Consistência e Caráter Contributivo”; “Caráter contributivo - Repasse (objeto de PAP)” e “Utilização dos recursos previdenciários (objeto de PAP)”.</p>
          </div>
        </div>

        <div class="avoid-break phase-block" id="fase-44" hidden>
          <h3>4.4 Fase Específica/Focalizada – 4º CRP Emergencial</h3>

          <div class="sub-section" id="f44-sub-1">
            <p class="small"><strong>4.4.1 Declaro ter cumprido as seguintes condições:</strong></p>
            <ul id="f44-decls" class="styled-list" data-empty="Não preenchido"></ul>
            <div id="f44-leg-wrap" class="field-group" hidden>
              <p class="label-like">Relacionar a legislação que adequou as regras de benefícios do RPPS à EC 103/2019:</p>
              <div class="value-block" data-k="F441_LEGISLACAO"></div>
            </div>
          </div>
          
          <div class="sub-section" id="f44-sub-2">
            <p class="small"><strong>4.4.2 Finalidade do(s) Plano(s) de Ação apresentado(s)</strong></p>
            <ul id="f44-finalidades" class="styled-list" data-empty="Não preenchido"></ul>
          </div>
          
          <div class="sub-section" id="f44-sub-3">
            <p class="small"><strong>4.4.3 Critério(s) do extrato previdenciário objeto do(s) Plano(s) de Ação</strong></p>
            <ul id="f44-criterios" class="styled-list" data-empty="Não preenchido"></ul>
          </div>
          
          <div class="sub-section" id="f44-sub-4">
            <p class="small"><strong>4.4.4 Anexos (obrigatório o encaminhamento de Planos de Ação e documentação comprobatória)</strong></p>
            <div class="value-block" data-k="F44_ANEXOS"></div>
          </div>
          
          <div class="sub-section" id="f44-sub-5">
            <p class="small"><strong>4.4.5 Descrever sucintamente o(s) Plano(s) de Ação apresentado(s):</strong></p>
            <div class="value-block" data-k="F445_DESC_PLANOS"></div>
          </div>
          
          <div class="sub-section" id="f44-sub-6">
            <p class="small"><strong>4.4.6 Em caso de Plano(s) de Ação apresentado(s) na Fase Intermediária:</strong></p>
            <p class="label-like">a) Comprovação do cumprimento do(s) Plano(s) de Ação (relacione os documentos, um por linha)</p>
            <div class="value-block" data-k="F446_DOCS"></div>
            <p class="label-like">b) Descrever sucintamente a execução do(s) Plano(s) de Ação e os resultados alcançados</p>
            <div class="value-block" data-k="F446_EXEC_RES"></div>
          </div>
        </div>

        <div class="avoid-break phase-block" id="fase-45" hidden>
          <h3>4.5 Fase Específica/Focalizada – 5º CRP Emergencial</h3>
          <ul id="f45-decls" class="styled-list" data-empty="Não preenchido">
            </ul>
          
          <div class="sub-section" id="f45-sub-2">
            <p class="small"><strong>4.5.2 Comprovação do cumprimento do(s) Plano(s) de Ação</strong></p>
            <div class="value-block" data-k="F45_DOCS"></div>
          </div>
          
          <div class="sub-section" id="f45-sub-4">
            <p class="small"><strong>4.5.4 Justificativas</strong></p>
            <div class="value-block" data-k="F45_JUST"></div>
          </div>
          
          <div class="sub-section" id="f45-sub-3">
            <p class="small"><strong>4.5.3 Descrever sucintamente a execução do(s) Plano(s) de Ação e os resultados alcançados</strong></p>
            <div class="value-block" data-k="F453_EXEC_RES"></div>
          </div>
        </div>

        <div class="avoid-break phase-block" id="fase-46" hidden>
          <h3>4.6 Fase de Manutenção da Conformidade</h3>

          <div class="sub-section" id="f46-sub-1">
            <p class="small"><strong>4.6.1 Declaro ter cumprido as seguintes condições:</strong></p>
            <p class="label-like">a) Demais critérios que não são objeto do Plano(s) de Ação estão regulares.</p>
            <ul id="f46-criterios" class="styled-list" data-empty="Não preenchido"></ul>
            
            <p class="label-like">b) Nível de certificação no Pró-Gestão RPPS</p>
            <div class="value-block" data-k="F46_PROGESTAO"></div>
            
            <p class="label-like">c) Grupo de Porte (ISP-RPPS)</p>
            <div class="value-block" data-k="F46_PORTE"></div>
            
            <p class="label-like">d) Houve melhora na situação financeira e atuarial do RPPS...</p>
            <p class="label-like nested">Justificativas (item d)</p>
            <div class="value-block" data-k="F46_JUST_D"></div>
            <p class="label-like nested">Documentos (item d)</p>
            <div class="value-block" data-k="F46_DOCS_D"></div>
            
            <p class="label-like">e) Medidas de acompanhamento atuarial...</p>
            <p class="label-like nested">Justificativas (item e)</p>
            <div class="value-block" data-k="F46_JUST_E"></div>
            <p class="label-like nested">Documentos (item e)</p>
            <div class="value-block" data-k="F46_DOCS_E"></div>
          </div>

          <div class="sub-section" id="f46-sub-2">
            <p class="small"><strong>4.6.2 Finalidade do(s) Plano(s) de Ação apresentado(s)</strong></p>
            <ul id="f46-finalidades" class="styled-list" data-empty="Não preenchido"></ul>
            <ul id="f46-crit-f" class="styled-list nested-list" data-empty="Não preenchido">
              </ul>
          </div>
          
          <div class="sub-section" id="f46-sub-6">
            <p class="small"><strong>4.6.6 Em caso de Plano(s) de Ação em execução ou concluído(s):</strong></p>
            <p class="label-like">a) Comprovação do cumprimento do(s) Plano(s) de Ação (relacione os documentos, um por linha)</p>
            <div class="value-block" data-k="F466_DOCS"></div>
            <p class="label-like">b) Descrever sucintamente a execução do(s) Plano(s) de Ação e os resultados alcançados</p>
            <div class="value-block" data-k="F466_EXEC_RES"></div>
          </div>
        </div>

      </section>
      <!-- 5. JUSTIFICATIVAS GERAIS -->
      <section class="term-section avoid-break">
        <h2>5. JUSTIFICATIVAS / INFORMAÇÕES ADICIONAIS</h2>
        <p data-k="justificativas_gerais"></p>
      </section>

      <!-- Força página nova antes das assinaturas -->
      <div class="break-before"></div>

      <!-- Assinaturas -->
      <footer class="term-footer">
        <p class="place-date"><span data-k="ente"></span>/<span data-k="uf"></span>, <span data-k="data_termo"></span>.</p>

        <div class="signature-block">
          <div class="signature-line" aria-hidden="true"></div>
          <p class="signature-caption">
            <strong><span data-k="nome_rep_ente"></span></strong><br>
            <span id="sig-cap-ente">Representante legal do Município de <span data-k="ente"></span>/<span data-k="uf"></span></span>
          </p>
        </div>

        <div class="signature-block">
          <div class="signature-line" aria-hidden="true"></div>
          <p class="signature-caption">
            <strong><span data-k="nome_rep_ug"></span></strong><br>
            Representante legal do <span data-k="ug"></span>
          </p>
        </div>
      </footer>
    </main>
  </div>

  <!-- Modal "Gerando PDF…" -->
  <div id="pdf-modal" class="pdf-modal" aria-hidden="true">
    <div class="pdf-modal__backdrop"></div>
    <div class="pdf-modal__box" role="dialog" aria-modal="true" aria-label="Gerando PDF">
      <div class="pdf-modal__header">Gerando PDF…</div>
      <div class="pdf-modal__body">
        <p>Aguarde, preparando o arquivo.</p>
        <div class="spinner" aria-hidden="true"></div>
      </div>
    </div>
  </div>
  <!-- Script embutido -->

  <!--
  <script>
    (function () {
      const $  = (s, r=document) => r.querySelector(s);
      const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));

      /* ===== Fallbacks “Não informado” ===== */
      const __NA_LABEL__ = () =>
        String((window.__TERMO_DATA__ && window.__TERMO_DATA__.__NA_LABEL) || 'Não informado');
      const __NA_ALL__ = () => {
        const d = window.__TERMO_DATA__;
        return (d && Object.prototype.hasOwnProperty.call(d, '__NA_ALL'))
          ? !!d.__NA_ALL : true;
      };
      function fillText(key, val){
        const raw = (val == null) ? '' : String(val);
        const trimmed = raw.trim();
        const s = trimmed || (__NA_ALL__() ? __NA_LABEL__() : '');
        $$('[data-k="'+key+'"]').forEach(el => { el.textContent = s; });
      }

      /* ===== Utilitários ===== */
      function escapeHtml(s){ return String(s||'').replace(/[&<>\"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]); }

      function asArr(v){
        if (Array.isArray(v)) return v;
        if (v == null || v === '') return [];
        if (typeof v === 'string') {
          const s = v.trim();
          if (!s) return [];
          if ((s.startsWith('[') && s.endsWith(']')) || (s.startsWith('{') && s.endsWith('}'))) {
            try {
              const j = JSON.parse(s);
              if (Array.isArray(j)) return j.filter(Boolean).map(x=>String(x).trim()).filter(Boolean);
            } catch(_) {}
          }
          return s.split(/,\s*|\n+|;/).map(s=>s.trim()).filter(Boolean);
        }
        return [String(v)].filter(Boolean);
      }

      function splitLines(s){ return String(s||'').split(/\r?\n/).map(t=>t.trim()).filter(Boolean); }

      function liList(sel, arr){
        const ul = document.querySelector(sel);
        if (!ul) return;
        const a = asArr(arr);
        const emptyMsg = ul.getAttribute('data-empty') || 'Não informado';
        if (a.length) {
          ul.innerHTML = a.map(x=>`<li>${escapeHtml(x)}</li>`).join('');
        } else {
          const useNA = (typeof __NA_ALL__ === 'function') ? __NA_ALL__() : true;
          ul.innerHTML = useNA ? `<li>${escapeHtml(emptyMsg)}</li>` : '';
        }
      }
      fillList = liList;

      // Nova função para renderizar textos longos, preservando quebras de linha
      function renderParagraphs(sel, s){
        const el = document.querySelector(sel);
        if (!el) return;
        const lines = splitLines(s);
        const useNA = (typeof __NA_ALL__ === 'function') ? __NA_ALL__() : true;
        
        if (lines.length) {
          // Renderiza cada linha como um parágrafo HTML
          el.innerHTML = lines.map(x=>`<p>${escapeHtml(x)}</p>`).join('');
        } else {
          el.innerHTML = useNA ? `<span class="muted">${escapeHtml(__NA_LABEL__())}</span>` : '—';
        }
      }

      fillBlock = renderParagraphs;

      // Função para renderizar documentos/listas em div/ul/li (similar ao original)
      function renderListDiv(sel, arr){
        const box = document.querySelector(sel);
        if (!box) return;
        const a = asArr(arr);
        const useNA = (typeof __NA_ALL__ === 'function') ? __NA_ALL__() : true;

        if (a.length) {
          box.innerHTML = '<ul>' + a.map(x=>'<li>' + escapeHtml(x) + '</li>').join('') + '</ul>';
        } else {
          box.innerHTML = useNA ? `<span class="muted">${escapeHtml(__NA_LABEL__())}</span>` : '—';
        }
      }

      // Helper simples para preencher valor em um seletor (usado em 4.3.11, 4.3.12)
      function fillValue(sel, val) {
        const el = $(sel);
        if (!el) return false;
        const s = String(val || '').trim();
        if (s) {
          // Renderiza preservando quebras de linha
          el.innerHTML = s.replace(/\r?\n/g, '<br>');
          return true;
        }
        // Garante que o elemento fique vazio se não houver valor
        el.innerHTML = ''; 
        return false;
      }

      function asYes(v){ return ['sim','s','true','1','yes','y'].includes(String(v ?? '').trim().toLowerCase()); }

      function asNo(v){  return ['nao','não','n','false','0','no'].includes(String(v ?? '').trim().toLowerCase()); }

      function show(sel, visible) {
        const el = $(sel);
        if (el) {
          el.hidden = !visible;
          el.style.display = visible ? '' : 'none';
        }
      }

      /* ===== Normalização do payload ===== */
      function normalizePayload(p0){
        const p = Object.assign({}, p0);

        // Básicos/aliases
        p.ENTE = p.ENTE ?? p.ente; p.UF = p.UF ?? p.uf; p.UG = p.UG ?? p.ug;
        p.CNPJ_ENTE = p.CNPJ_ENTE ?? p.cnpj_ente; p.CNPJ_UG = p.CNPJ_UG ?? p.cnpj_ug;
        p.EMAIL_ENTE = p.EMAIL_ENTE ?? p.email_ente; p.EMAIL_UG = p.EMAIL_UG ?? p.email_ug;
        p.SEI_PROCESSO = p.SEI_PROCESSO ?? p.sei_processo ?? p.PROC_SEI ?? p.proc_sei ?? '';
        p.PORTARIA_SRPC = p.PORTARIA_SRPC ?? p.portaria_srpc ?? p.PORTARIA_SRPC_MPS ?? '2.024/2025';

        p.ORGAO_VINCULACAO_UG = p.ORGAO_VINCULACAO_UG
          || p.orgao_vinculacao_ug 
          || p.orgao_vinc_ug 
          || p.ug_orgao_vinc 
          || '';
        // Recupera 1.3.4 de fontes auxiliares (adesão/session/parent)
        if (!p.ORGAO_VINCULACAO_UG) {
          try {
            const ss = (k) => {
              try { return (sessionStorage.getItem(k) || '').trim(); } catch(_) { return ''; }
            };
            const cand = ss('ORGAO_VINCULACAO_UG') || ss('ORGAO_VINCULACAO_UG__ADESAO');
            if (cand) p.ORGAO_VINCULACAO_UG = cand;
          } catch(_) {}
        }
        if (!p.ORGAO_VINCULACAO_UG) {
          try {
            const fromParent = (window.parent && window.parent.__TERMO_ADESAO__ && window.parent.__TERMO_ADESAO__.ORGAO_VINCULACAO_UG) || '';
            if (fromParent) p.ORGAO_VINCULACAO_UG = String(fromParent).trim();
          } catch(_) {}
        }

        p.NOME_REP_ENTE = p.NOME_REP_ENTE ?? p.nome_rep_ente;
        p.CARGO_REP_ENTE = p.CARGO_REP_ENTE ?? p.cargo_rep_ente;
        p.CPF_REP_ENTE   = p.CPF_REP_ENTE   ?? p.cpf_rep_ente;
        p.EMAIL_REP_ENTE = p.EMAIL_REP_ENTE ?? p.email_rep_ente;
        p.TEL_REP_ENTE   = p.TEL_REP_ENTE   ?? p.tel_rep_ente;

        p.NOME_REP_UG = p.NOME_REP_UG ?? p.nome_rep_ug;
        p.CARGO_REP_UG = p.CARGO_REP_UG ?? p.cargo_rep_ug;
        p.CPF_REP_UG   = p.CPF_REP_UG   ?? p.cpf_rep_ug;
        p.EMAIL_REP_UG = p.EMAIL_REP_UG ?? p.email_rep_ug;
        p.TEL_REP_UG   = p.TEL_REP_UG   ?? p.tel_rep_ug;

        // (3.1) Data vencimento CRP
        const crp = p.crp || p.CRP || {};
        p.DATA_VENC_ULTIMO_CRP = p.DATA_VENC_ULTIMO_CRP
          ?? p.data_vencimento_ultimo_crp
          ?? p.data_venc_ult_crp
          ?? crp.data_venc
          ?? crp.data_validade
          ?? crp.DATA_VALIDADE_DMY
          ?? crp.DATA_VALIDADE_ISO
          ?? crp.DATA_VALIDADE
          ?? crp.validade
          ?? crp.vencimento
          ?? '';

        // (3.2) Tipo de emissão
        p.TIPO_EMISSAO_ULTIMO_CRP = (p.TIPO_EMISSAO_ULTIMO_CRP || p.tipo_emissao_ultimo_crp || p.tipo_emissao_ult_crp || p.tipo_emissao || '').trim();
        if (!p.TIPO_EMISSAO_ULTIMO_CRP) {
          const flag = crp.e_judicial ?? crp.tipo_simnao ?? p.CRP_E_JUDICIAL ?? p.CRP_TIPO_SIMNAO ?? crp.emissao ?? crp.tipo_emissao ?? '';
          if (asYes(flag))      p.TIPO_EMISSAO_ULTIMO_CRP = 'Judicial';
          else if (asNo(flag))  p.TIPO_EMISSAO_ULTIMO_CRP = 'Administrativa';
          else {
            const txt = String(crp.tipo || crp.emissao || p.tipo || '').trim();
            if (txt) p.TIPO_EMISSAO_ULTIMO_CRP = txt;
          }
        }

        // Espelhos compat
        p.venc_ult_crp = p.venc_ult_crp
          ?? p.DATA_VENC_ULTIMO_CRP
          ?? p.DATA_VENCIMENTO_ULTIMO_CRP
          ?? '';

        // (3.2) Opção textual antiga → code
        p.OPT_3_2 = (p.OPT_3_2 || p.opt_3_2 || '').trim();
        if (!p.OPT_3_2){
          const yes = v => String(v||'').toUpperCase() === 'SIM';
          if (yes(p.FIN_3_2_MANUTENCAO_CONFORMIDADE))   p.OPT_3_2 = '3.2.1';
          else if (yes(p.FIN_3_2_DEFICIT_ATUARIAL))     p.OPT_3_2 = '3.2.2';
          else if (yes(p.FIN_3_2_CRITERIOS_ESTRUTURANTES)) p.OPT_32 = '3.2.3';
          else if (yes(p.FIN_3_2_OUTRO_CRITERIO_COMPLEXO)) p.OPT_3_2 = '3.2.4';
        }

        // (3.4) Resolve code e texto
        const _rawPrazo = String(
          p.PRAZO_ADICIONAL_COD
          || p.prazo_adicional_cod
          || p.prazo_adicional
          || p.prazo
          || p.OPT_3_4
          || p.opt_3_4
          || p.OPT_3_2
          || ''
        ).trim();
        let _prazo = _rawPrazo || '';
        if (_prazo && !/3\.4\.\d/.test(_prazo)) {
          const m = _prazo.match(/3\.(?:2|4)\.(\d)/);
          if (m) _prazo = `3.4.${m[1]}`;
          else if (/^\d$/.test(_prazo)) _prazo = `3.4.${_prazo}`;
        }
        if (!_prazo) {
          for (const k of Object.keys(p0 || p)) {
            const v = String((p0[k] ?? p[k] ?? '')).trim();
            const mv = v.match(/(3\.[24]\.\d)/);
            if (mv) { _prazo = mv[1]; break; }
            const mk = k.match(/(3[._-]?(?:2|4)[._-]?\d|3_4_\d|3_2_\d)/i);
            if (mk) {
              const codeFromKey = mk[0].replace(/_/g, '.').replace(/([^\d.])/g,'').replace(/\.\{2,}/g,'.');
              _prazo = codeFromKey.replace(/^3\.2\.(\d)$/, '3.4.$1');
              break;
            }
            if (/^[1-9]$/.test(v)) { _prazo = '3.4.' + v; break; }
          }
        }
        p.PRAZO_ADICIONAL_COD = (_prazo || '').replace(/^3\.2\.(\d)$/, '3.4.$1');
        p.PRAZO_ADICIONAL_TEXTO = p.PRAZO_ADICIONAL_TEXTO || p.prazo_adicional_texto || p.prazo_adicional_desc || '';

        // 3.3 – critérios irregulares
        const candCriterios = (p.CRITERIOS_IRREGULARES || p.CRITERIOS_LIST || p.CRIT_IRREGULARES || p.CRITERIOS || p.CODIGOS_CRITERIOS || p.codigos_criterios || '');
        p.__CRITERIOS_ARR__ = asArr(candCriterios);

        // Fase
        p.__FASE_SEL__ = String(
          p.FASE_PROGRAMA || p.fase_programa || p.FASE || p.fase || p.fase_selecionada || p.fase_codigo || p.fase_sel || ''
        ).trim();

        // Normaliza F41_OPCAO
        const f41opt = String(p.F41_OPCAO || p.f41_opcao || '').trim();
        const m41 = f41opt.match(/^(4\.1\.\d)/);
        p.F41_OPCAO_CODE = m41 ? m41[1] : '';
        p.F41_OPCAO_TEXT = f41opt;
        if (!p.F41_OPCAO_CODE && /até 60/.test(f41opt)) p.F41_OPCAO_CODE = '4.1.1';
        if (!p.F41_OPCAO_CODE && /não possui débitos/.test(f41opt)) p.F41_OPCAO_CODE = '4.1.2';
        
        // Normaliza F4310_OPCAO
        const f4310opt = String(p.F4310_OPCAO || '').trim();
        if (f4310opt.startsWith('a)')) p.F4310_OPCAO = 'a';
        if (f4310opt.startsWith('b)')) p.F4310_OPCAO = 'b';
        
        p.F42_LISTA = asArr(p.F42_LISTA || p.f42_itens || p.fase42_itens || p['F42_ITENS[]'] || '');
        p.F43_LISTA = asArr(p.F43_LISTA || p.f43_itens || p.fase43_itens || p['F43_ITENS[]'] || '');
        p.F43_INCLUIR_B = asArr(p.F43_INCLUIR_B || p['F43_INCLUIR_B[]'] || ''); // Novo campo 4.3.12
        p.F43_INCLUIR = asArr(p.F43_INCLUIR || p['F43_INCLUIR[]']); // NÃO unificar, manter separado
        p.F44_CRITERIOS = asArr(p.F44_CRITERIOS || p.f44_criterios || p.fase44_criterios || p['F44_CRITERIOS[]'] || '');
        p.F44_DECLS = asArr(p.F44_DECLS || p['F44_DECLS[]'] || p['F44_CONDICOES[]'] || p.f44_decls || '');
        p.F44_FINALIDADES = asArr(p.F44_FINALIDADES || p.f44_finalidades || p.fase44_finalidades || p['F44_FINALIDADES[]'] || '');
        p.F44_ANEXOS = p.F44_ANEXOS || p.f44_anexos || p.fase44_anexos || '';

        p.F45_DECLS = asArr(p.F45_DECLS || p['F45_CONDICOES[]'] || p.f45_decls || '');
        p.F45_DOCS  = p.F45_DOCS || p.f45_docs || '';
        p.F45_JUST  = p.F45_JUST || p.f45_just || '';
        p.F453_EXEC_RES = p.F453_EXEC_RES || ''; // Novo campo 4.5.3
        
        // Garante que a declaração 4.5.1 seja adicionada se o checkbox for marcado
        if (asYes(p.F45_OK451) || p.F45_DECLS.some(d => /4\.5\.1/.test(d))) {
          if (!p.F45_DECLS.some(d => d.startsWith('4.5.1'))) {
            p.F45_DECLS.push('4.5.1 Mantida a regularidade dos critérios exigidos nas fases anteriores.');
          }
        } else if (p.F45_DECLS.some(d => /4\.5\.1/.test(d))) {
            p.F45_OK451 = true;
        }

        p.F46_CRITERIOS = asArr(p.F46_CRITERIOS || p['F46_CRITERIOS[]'] || p.f46_criterios || '');
        p.F46_DECLS = asArr(p.F46_DECLS || p['F46_CONDICOES[]'] || p.f46_decls || '');
        
        p.F46_FINALIDADES = asArr(
          p.F46_FINALIDADES
          || p['F462_FINALIDADES[]']  // <— nome do form
          || p['F46_FINALIDADES[]']
          || p.f46_finalidades
          || ''
        );

        p.F462F_CRITERIOS = asArr(
          p.F462F_CRITERIOS
          || p['F462F_CRITERIOS[]'] // <— nome do form
          || p.f462f_criterios
          || ''
        );

        /* Unifica critérios da fase 4.6 */
        p.F46_CRITERIOS = Array.from(new Set([
          ...asArr(p.F46_CRITERIOS),
          ...asArr(p.F462F_CRITERIOS)
        ]));

        p.F46_ANEXOS      = p.F46_ANEXOS      || p.f46_anexos      || p.F466_DOCS || '';
        p.F46_JUST_PLANOS = p.F46_JUST_PLANOS || p.f46_just_planos || p.F46_JUST_D || p.F46_JUST_E || '';
        p.F46_PROGESTAO   = p.F46_PROGESTAO   || p.f46_progestao;
        p.F46_PORTE       = p.F46_PORTE       || p.f46_porte;
        p.F46_JUST_D      = p.F46_JUST_D      || p.f46_just_d;
        p.F46_DOCS_D      = p.F46_DOCS_D      || p.f46_docs_d;
        p.F46_JUST_E      = p.F46_JUST_E      || p.f46_just_e;
        p.F46_DOCS_E      = p.F46_DOCS_E      || p.f46_docs_e;

        p.F466_DOCS     = p.F466_DOCS     || p.F46_DOCS     || p.f46_docs     || p.f466_docs     || '';
        p.F466_EXEC_RES = p.F466_EXEC_RES || p.F46_EXEC_RES || p.f46_exec_res || p.f466_exec_res || '';
        p.F46_COMP_CUMPR = p.F466_EXEC_RES; // Alias

        p.DATA_TERMO_GERADO = p.DATA_TERMO_GERADO || p.DATA || p.DATA_SOLIC_GERADA || '';

        // Aliases mínimos
        const _split = v => Array.isArray(v) ? v : String(v||'').split(/[;\n\r]+/).map(s => s.trim()).filter(Boolean);
        if (!p.F42_LISTA?.length) p.F42_LISTA = _split(p.REGULARIZACAO_PENDEN_ADMINISTRATIVA || p.reg_penden_admin || '');
        if (!p.F43_LISTA?.length) p.F43_LISTA = _split(p.DEFICIT_ATUARIAL || p.deficit_atuarial || '');
        if (!p.F44_CRITERIOS?.length) p.F44_CRITERIOS = _split(p.CRITERIOS_ESTRUT_ESTABELECIDOS || p.criterios_estrut || '');
        
        // Compat extra 4.3 – se vier só como F43_LISTA[] / F43_ITENS[]
        if (!p.F43_LISTA || !p.F43_LISTA.length) {
          let arr43 = [];
          if (Array.isArray(p['F43_LISTA[]']))      arr43 = p['F43_LISTA[]'];
          else if (Array.isArray(p['F43_ITENS[]'])) arr43 = p['F43_ITENS[]'];
          else if (Array.isArray(p.F43_ITENS))      arr43 = p.F43_ITENS;
          p.F43_LISTA = arr43;
        }

        
        if (!p.F46_CRITERIOS?.length) p.F46_CRITERIOS = _split(p.MANUTENCAO_CONFORMIDADE_NORMAS_GERAIS || p.man_conformidade || '');

        return p;
      }
      function hojeBR_robusto(){
        try{
          const s = new Date().toLocaleDateString('pt-BR');
          if (s && /\d{2}\/\d{2}\/\d{4}/.test(s)) return s;
        }catch(_){}
        const d = new Date();
        const dd = String(d.getDate()).padStart(2,'0');
        const mm = String(d.getMonth()+1).padStart(2,'0');
        const yyyy = String(d.getFullYear());
        return `${dd}/${mm}/${yyyy}`;
      }

      function normalizarEsfera(txt){
        const t = String(txt||'').toLowerCase();
        if (t.includes('estadual') || t.includes('distrit')) return '1.1.2 RPPS Estadual/Distrital';
        if (t.includes('municip')) return '1.1.1 RPPS Municipal';
        return (typeof __NA_ALL__==='function' && __NA_ALL__()) ? __NA_LABEL__() : '—';
      }

      // ========= Função principal =========
      function run(payload){
        if (window.__DEBUG_SOLIC_CRP__) {
          try { console.log('[E3] template/run → payload (raw)', payload); } catch {}
        }

        const p = normalizePayload(payload || {});
        window.__TERMO_DATA__ = Object.assign({}, window.__TERMO_DATA__ || {}, p);
        if (window.__DEBUG_SOLIC_CRP__) {
          try { console.log('[E3] template/run → payload (normalized)', p); } catch {}
        }
        try { document.dispatchEvent(new Event('TERMO_DATA')); } catch {}

        // 1) Cabeçalho/meta
        fillText('ente', p.ENTE); fillText('uf', p.UF); fillText('ug', p.UG);
        fillText('cnpj_ente', p.CNPJ_ENTE); fillText('cnpj_ug', p.CNPJ_UG);
        fillText('email_ente', p.EMAIL_ENTE); fillText('email_ug', p.EMAIL_UG);
        fillText('N_GESCON', p.N_GESCON || p.n_gescon || '');
        fillText('DATA_ENC_VIA_GESCON', p.DATA_ENC_VIA_GESCON || p.data_enc_via_gescon || '');
        fillText('SEI_PROCESSO', p.SEI_PROCESSO); fillText('PORTARIA_SRPC', p.PORTARIA_SRPC);
        fillText('ORGAO_VINCULACAO_UG', p.ORGAO_VINCULACAO_UG || '');

        // 2) Responsáveis
        fillText('nome_rep_ente',  p.NOME_REP_ENTE);
        fillText('cargo_rep_ente', p.CARGO_REP_ENTE);
        fillText('cpf_rep_ente',   p.CPF_REP_ENTE);
        fillText('email_rep_ente', p.EMAIL_REP_ENTE);
        fillText('tel_rep_ente',   p.TEL_REP_ENTE);

        fillText('nome_rep_ug',  p.NOME_REP_UG);
        fillText('cargo_rep_ug', p.CARGO_REP_UG);
        fillText('cpf_rep_ug',   p.CPF_REP_UG);
        fillText('email_rep_ug', p.EMAIL_REP_UG);
        fillText('tel_rep_ug',   p.TEL_REP_UG);

        // 3) CRP
        const __venc = p.DATA_VENC_ULTIMO_CRP || p.DATA_VENCIMENTO_ULTIMO_CRP || p.venc_ult_crp || '';
        fillText('venc_ult_crp', __venc);
        fillText('data_vencimento_ultimo_crp', __venc);

        const __tipo = p.TIPO_EMISSAO_ULTIMO_CRP || p.tipo_emissao_ult_crp || '';
        fillText('tipo_emissao_ult_crp',    __tipo);
        fillText('tipo_emissao_ultimo_crp', __tipo);

        fillText('DATA_VENC_ULTIMO_CRP',  p.DATA_VENC_ULTIMO_CRP  || p.DATA_VENCIMENTO_ULTIMO_CRP || p.venc_ult_crp || '');
        fillText('TIPO_EMISSAO_ULTIMO_CRP', p.TIPO_EMISSAO_ULTIMO_CRP || p.tipo_emissao_ult_crp || '');

        // 3.4 — mostra somente a alternativa selecionada
        const __prz = String(p.PRAZO_ADICIONAL_COD || p.prazo_adicional_cod || '').trim();
        (function applyPrazoAdicional(code){
          const itens = Array.from(document.querySelectorAll('[data-3_4]'));
          let mostrou = false;
          itens.forEach(el => {
            const tag = (el.getAttribute('data-3_4') || '').trim();
            const ok  = code && tag === code;
            if (ok) { el.style.display = ''; mostrou = true; }
            else { el.remove(); }
          });
          const holder = document.querySelector('[data-k="PRAZO_ADICIONAL_TEXTO"]');
          if (holder) {
            if (mostrou) holder.classList.add('d-none');
            else {
              const txt = p.PRAZO_ADICIONAL_TEXTO || p.prazo_adicional_texto || 'Não informado';
              holder.textContent = txt;
              holder.classList.toggle('d-none', !txt.trim());
            }
          }
        })(__prz);

        // 3.3
        liList('#criterios-list', p.__CRITERIOS_ARR__);

        // 4) Fase
        let faseSel = String(p.__FASE_SEL__ || p.FASE_PROGRAMA || '').trim();
        // fallback
        if (!faseSel) {
          const has = pref => Object.keys(p||{}).some(k => k.startsWith(pref));
          if      (has('F41_')) faseSel = '4.1';
          else if (has('F42_')) faseSel = '4.2';
          else if (has('F43_')) faseSel = '4.3';
          else if (has('F44_')) faseSel = '4.4';
          else if (has('F45_')) faseSel = '4.5';
          else if (has('F46_') || has('F462F_')) faseSel = '4.6';
        }
        
        // Oculta APENAS "Fase selecionada:"
        (function hidePhaseLabel(){
          const faseTxtEl = document.getElementById('fase-escolhida');
          if (faseTxtEl && faseTxtEl.parentElement) faseTxtEl.parentElement.hidden = true;
        })();
        
        // Helper para preencher blocos de texto
        function fillBlock(sel, val) {
          const el = $(sel);
          if (!el) return false;
          const lines = splitLines(val);
          if (lines.length) {
            el.innerHTML = lines.map(x => `<p>${escapeHtml(x)}</p>`).join('');
            return true;
          }
          // CORREÇÃO (Problema 1 e 2): Garante que o elemento fique vazio em vez de ter "—"
          el.innerHTML = ''; 
          return false;
        }

        // Helper para preencher ULs
        function fillList(sel, arr) {
          const el = $(sel);
          if (!el) return false;
          const items = asArr(arr);
          if (items.length) {
            el.innerHTML = items.map(x=>`<li>${escapeHtml(x)}</li>`).join('');
            return true;
          }
          // CORREÇÃO (Problema 2): Garante que o UL fique vazio para não acionar o CSS de fallback
          el.innerHTML = ''; 
          return false;
        }

        // Helper para mostrar/esconder a seção inteira da fase
        function togglePhaseBlock(id, hasContent) {
          const el = $(id);
          if (el) {
            el.hidden = !hasContent;
            el.setAttribute('data-empty', hasContent ? 'false' : 'true');
          }
        }
        
        // --- Processa 4.1 ---
        (function run41(){
          const el = $('#f41-itens');
          const texto = (p.F41_OPCAO_CODE || p.F41_OPCAO_TEXT || '').trim();
          let has = !!texto;
          if (el) {
            el.innerHTML = texto ? `<li>${escapeHtml(texto)}</li>` : '';
          }
          togglePhaseBlock('#fase-41', has);
        })();
        
        // --- Processa 4.2 ---
        (function run42(){
          const has = fillList('#f42-itens', p.F42_LISTA);
          togglePhaseBlock('#fase-42', has);
        })();

        (function run43(){
          let hasContent = false;
          const faseEl = $('#fase-43');
          if (!faseEl) return;
          
          // 4.3.1 a 4.3.9 (O JS do form envia tudo em 'F43_LISTA')
          // Vamos dividir a lista por seção, com base no texto
          const allItens = asArr(p.F43_LISTA);
          
          const filterList = (keys) => allItens.filter(item => {
            const lowItem = (item || '').toLowerCase();
            return keys.some(k => lowItem.includes(k));
          });

          // Distribui a lista única nos 9 ULs corretos
          if (fillList('#f43-itens-1', filterList(['dipr', 'caráter contributivo', 'repasse', 'aportes', 'parcelamento']))) hasContent = true;
          if (fillList('#f43-itens-2', filterList(['utilização dos recursos']))) hasContent = true;
          if (fillList('#f43-itens-3', filterList(['aplicações financeiras', 'dair', 'dpin']))) hasContent = true;
          if (fillList('#f43-itens-4', filterList(['limites de contribuição']))) hasContent = true;
          if (fillList('#f43-itens-5', filterList(['rol de benefícios', 'plano de benefícios']))) hasContent = true;
          if (fillList('#f43-itens-6', filterList(['previdência complementar', 'rpc']))) hasContent = true;
          if (fillList('#f43-itens-7', filterList(['envio de dados', 'solicitação de legislação', 'atendimento à fiscalização', 'nta', 'draa', 'msc', 'esocial']))) hasContent = true;
          if (fillList('#f43-itens-8', filterList(['compensação previdenciária']))) hasContent = true;
          if (fillList('#f43-itens-9', filterList(['requisitos dos dirigentes', 'colegiados', 'art. 8º-b']))) hasContent = true;

          // 4.3.10
          const opt4310 = (p.F4310_OPCAO || '').trim().toLowerCase();
          // O form envia "a) Foram adotadas..." ou "b) Comprovamos..."
          const optA = opt4310.startsWith('a');
          const optB = opt4310.startsWith('b');
          
          show('#f43-opcao-a', optA);
          show('#f43-opcao-b', optB);
          
          if (optA && fillBlock('[data-k="F4310_LEGISLACAO"]', p.F4310_LEGISLACAO)) hasContent = true;
          if (optB && fillBlock('[data-k="F4310_DOCS"]', p.F4310_DOCS)) hasContent = true;
          // Mostra a seção se 'a' ou 'b' foi selecionado, mesmo que o texto esteja vazio
          if (optA || optB) hasContent = true; 

          // 4.3.11 (Lê p.F43_INCLUIR e p.F43_PLANO)
          const h11_1 = fillList('#f43-crit-incluir', p.F43_INCLUIR);
          const h11_2 = fillValue('#f43-just-11', p.F43_PLANO); // CORRIGIDO: p.F43_PLANO
          
          if (h11_1 || h11_2) {
              show('#f43-sub-11', true);
              hasContent = true;
          } else {
              show('#f43-sub-11', false);
          }

          // 4.3.12 (Lê p.F43_INCLUIR_B, p.F43_PLANO_B, p.F43_DESC_PLANOS)
          const h12_1 = fillList('#f43-crit-incluir-12', p.F43_INCLUIR_B);
          const h12_2 = fillValue('#f43-just-12', p.F43_PLANO_B); // CORRIGIDO: p.F43_PLANO_B
          const h12_3 = fillValue('#f43-desc-planos-12', p.F43_DESC_PLANOS); // CORRIGIDO: p.F43_DESC_PLANOS
          
          if (h12_1 || h12_2 || h12_3) {
              show('#f43-sub-12', true);
              hasContent = true;
          } else {
              show('#f43-sub-12', false);
          }
          
          // Se qualquer sub-item tiver conteúdo, a fase é mostrada
          togglePhaseBlock('#fase-43', hasContent);
        })();
        // --- Processa 4.4 ---
        (function run44(){
          let hasContent = false;
          if (fillList('#f44-decls', p.F44_DECLS)) hasContent = true;
          
          const hasLeg = (p.F441_LEGISLACAO || '').trim();
          if (hasLeg) {
            show('#f44-leg-wrap', true);
            if (fillBlock('[data-k="F441_LEGISLACAO"]', p.F441_LEGISLACAO)) hasContent = true;
          } else {
            show('#f44-leg-wrap', false);
            fillBlock('[data-k="F441_LEGISLACAO"]', ''); // Limpa o campo
          }

          if (fillList('#f44-finalidades', p.F44_FINALIDADES)) hasContent = true;
          if (fillList('#f44-criterios', p.F44_CRITERIOS)) hasContent = true;
          if (fillBlock('[data-k="F44_ANEXOS"]', p.F44_ANEXOS)) hasContent = true;
          if (fillBlock('[data-k="F445_DESC_PLANOS"]', p.F445_DESC_PLANOS)) hasContent = true;
          if (fillBlock('[data-k="F446_DOCS"]', p.F446_DOCS)) hasContent = true;
          if (fillBlock('[data-k="F446_EXEC_RES"]', p.F446_EXEC_RES)) hasContent = true;
          
          togglePhaseBlock('#fase-44', hasContent);
        })();

        // --- Processa 4.5 ---
        (function run45(){
          let hasContent = false;
          // 4.5.1 é especial
          const f451 = asArr(p.F45_DECLS).filter(s => s.startsWith('4.5.1'));
          if (p.F45_OK451 && f451.length === 0) {
            f451.push('4.5.1 Mantida a regularidade dos critérios exigidos nas fases anteriores.');
          }
          if (fillList('#f45-decls', f451)) hasContent = true;
          
          if (fillBlock('[data-k="F45_DOCS"]', p.F45_DOCS)) hasContent = true;
          if (fillBlock('[data-k="F45_JUST"]', p.F45_JUST)) hasContent = true;
          if (fillBlock('[data-k="F453_EXEC_RES"]', p.F453_EXEC_RES)) hasContent = true;
          
          togglePhaseBlock('#fase-45', hasContent);
        })();

        // --- Processa 4.6 ---
        (function run46(){
          let hasContent = false;
          // 4.6.1 a) Demais critérios... (O ajuste no fillBlock e fillList evita o "Não informado")
          if (fillList('#f46-criterios', p.F46_CRITERIOS)) hasContent = true;
          
          // 4.6.1 b) Nível de certificação
          if (fillBlock('[data-k="F46_PROGESTAO"]', p.F46_PROGESTAO)) hasContent = true;

          // 4.6.1 c) Grupo de Porte
          if (fillBlock('[data-k="F46_PORTE"]', p.F46_PORTE)) hasContent = true;

          // 4.6.1 d) Justificativas e Documentos
          if (fillBlock('[data-k="F46_JUST_D"]', p.F46_JUST_D)) hasContent = true;
          if (fillBlock('[data-k="F46_DOCS_D"]', p.F46_DOCS_D)) hasContent = true;
          
          // 4.6.1 e) Justificativas e Documentos
          if (fillBlock('[data-k="F46_JUST_E"]', p.F46_JUST_E)) hasContent = true;
          if (fillBlock('[data-k="F46_DOCS_E"]', p.F46_DOCS_E)) hasContent = true;

          // 4.6.2 (finais)
          const f46f = asArr(p.F462F_CRITERIOS);
          if (fillList('#f46-finalidades', p.F46_FINALIDADES)) hasContent = true;
          if (fillList('#f46-crit-f', f46f)) hasContent = true;
          
          if (fillBlock('[data-k="F466_DOCS"]', p.F466_DOCS)) hasContent = true;
          if (fillBlock('[data-k="F466_EXEC_RES"]', p.F466_EXEC_RES)) hasContent = true;
          
          togglePhaseBlock('#fase-46', hasContent);
        })();
        
        // --- CORREÇÃO: Restaurar renderFaseExtras (Campos Adicionais) ---
        (function renderFaseExtras(){
          const box = document.getElementById('fase-extra-campos');
          const boxLabel = box ? box.previousElementSibling : null; // O <p> "Campos adicionais..."
          if (!box || !boxLabel) return;

          const p = window.__TERMO_DATA__ || {};
          const fase = String(p.__FASE_SEL__ || p.FASE_PROGRAMA || '').trim();
          if (!fase) {
            boxLabel.hidden = true;
            box.hidden = true;
            return;
          }

          // Lógica original para encontrar campos "fase4_*"
          const prefList = [
            {p:`fase${fase.replace('.','_')}_`},
            {p:`fase${fase.replace('.','-')}-`},
            {p:`fase${fase}_`},
            {p:`f${fase.replace('.','')}_`}
          ];
          function hasPref(k){ return prefList.some(({p:pre}) => String(k).startsWith(pre)); }

          const useNA = (typeof __NA_ALL__ === 'function') ? __NA_ALL__() : true;
          const entries = Object.entries(p)
            .filter(([k,v]) => hasPref(k) && v != null && (String(v).trim?.() || (Array.isArray(v) && v.length)))
            .map(([k,v])=>{
              const label = k.replace(/^.*?(?:_|-)/,'').replaceAll('_',' ').replaceAll('-',' ').toUpperCase();
              const val = Array.isArray(v) ? v : String(v).trim();
              const htmlVal = Array.isArray(val) && val.length
                ? ('<ul>' + val.map(x => '<li>' + escapeHtml(String(x)) + '</li>').join('') + '</ul>')
                : (val ? escapeHtml(val) : ( useNA ? escapeHtml(__NA_LABEL__()) : '' ));
              return `<div class="linha"><div class="titulo">${escapeHtml(label)}</div><div class="valor">${htmlVal}</div></div>`;
            });

          // Decide se mostra ou esconde o bloco e o rótulo
          if (entries.length) {
            box.innerHTML = entries.join('');
            boxLabel.hidden = false; // Mostra o rótulo
            box.hidden = false;      // Mostra o bloco
          } else {
            box.innerHTML = '';
            boxLabel.hidden = true; // Esconde o rótulo
            box.hidden = true;      // Esconde o bloco
          }
        })();
        
        // 5) Justificativas gerais
        fillText('justificativas_gerais', p.JUSTIFICATIVAS_GERAIS || p.justificativas_gerais || '');
        
        // 6) Data/assinaturas
        const preferida = (p.DATA_TERMO_GERADO || p.DATA || p.DATA_SOLIC_GERADA || '').trim();
        const resolvida = preferida || hojeBR_robusto();
        window.__TERMO_DATA__ = Object.assign({}, window.__TERMO_DATA__ || {}, { data_termo: resolvida });
        fillText('data_termo', resolvida);
        try { document.dispatchEvent(new Event('TERMO_DATA')); } catch {}

        // 7) Esfera e legenda assinatura
        const esferaTxt = normalizarEsfera(p.ESFERA || p.ESFERA_GOVERNO || p.ESFERA_SUGERIDA || p.fase_esfera);
        const esferaNode = document.querySelector('[data-esfera]');
        if (esferaNode) esferaNode.textContent = esferaTxt;
        const esferaTitulo = document.querySelector('h3 .label');
        if (esferaTitulo) esferaTitulo.textContent = '1.1 Esfera de Governo';
        (function(){
          const sig = document.getElementById('sig-cap-ente');
          if (sig) {
            const isEstDistr = /Estadual\/Distrital/i.test(esferaTxt);
            sig.innerHTML = isEstDistr
              ? 'Representante legal do Estado/Distrito de <span data-k="ente"></span>/<span data-k="uf"></span>'
              : 'Representante legal do Município de <span data-k="ente"></span>/<span data-k="uf"></span>';
            fillText('ente', p.ENTE); fillText('uf', p.UF);
          }
        })();

        // Garante listas críticas antes do print + FLAG DE PRONTO
        (function ensureListsThenPrint(){
          // ... (esta função permanece como está, linhas 789-817 originais)
          const fase = String((window.__TERMO_DATA__ && (window.__TERMO_DATA__.__FASE_SEL__ || window.__TERMO_DATA__.FASE_PROGRAMA)) || '').trim();
          const mustByPhase = {
            '4.1': ['#f41-itens'],
            '4.2': ['#f42-itens'],
            '4.3': ['#f43-incluir-list', '#f43-incluir-b-list'],
            '4.4': ['#f44-criterios', '#f44-decls', '#f44-finalidades'],
            '4.5': ['#f45-decls'],
            '4.6': ['#f46-criterios','#f46-finalidades']
          };
          const mustHaveLis = mustByPhase[fase] || [];
          const ok = mustHaveLis.every(sel => {
            const el = document.querySelector(sel);
            return el && (el.querySelector('li') || el.textContent.trim().length > 0);
          });
          if (!ok) {
            document.body.offsetHeight;
            setTimeout(() => ensureListsThenPrint(), 50);
            return;
          }
          if (!window.__TERMO_READY_FIRED__) {
            window.__TERMO_READY_FIRED__ = true;
            const fontsReady = (document.fonts && document.fonts.ready) ? document.fonts.ready : Promise.resolve();
            const maxWait = new Promise(r => setTimeout(r, 1500));
            Promise.race([fontsReady, maxWait]).finally(() => {
              requestAnimationFrame(() => {
                // >>> FLAG para o gerador de PDF:
                document.documentElement.setAttribute('data-termo-ready','1');
                window.__TERMO_PRINT_READY__ = true;
                try { document.dispatchEvent(new CustomEvent('TERMO_PRINT_READY')); } catch {}
              });
            });
          }
        })();
      }
      // Modal PDF (abrir/fechar)
      window.ModalPDF = {
        open(){ document.getElementById('pdf-modal')?.classList.add('pdf-modal--open'); },
        close(){ document.getElementById('pdf-modal')?.classList.remove('pdf-modal--open'); }
      };

      // EXPOSIÇÃO: compat com postMessage
      window.__TERMO_RUN__ = run;
      window.run = run;

      // Injeção por querystring
      (function injectFromQueryIfPresent(){
        try{
          const qs = new URLSearchParams(window.location.search || '');
          if ([...qs.keys()].length) {
            const obj = {}; qs.forEach((v,k)=>{ obj[k]=v; });
            window.__TERMO_DATA__ = Object.assign({}, window.__TERMO_DATA__ || {}, obj);
            try { run(window.__TERMO_DATA__); } catch(_){ }
          }
        }catch(_){ }
      })();

      if (window.__TERMO_DATA__) { try { run(window.__TERMO_DATA__); } catch {} }
      document.addEventListener('TERMO_DATA_READY', () => { try { run(window.__TERMO_DATA__ || {}); } catch {} });
      document.addEventListener('TERMO_DATA',       () => { try { run(window.__TERMO_DATA__ || {}); } catch {} });
      window.addEventListener('message', (ev) => {
        const d = ev && ev.data;
        if (!d) return;
        if (d.type === 'TERMO_DATA' || d.type === 'TERMO_DATA_READY' || d.type === 'TERMO_PREVIEW_DATA') {
          try { run(d.payload || {}); } catch (_) {}
        }
      });

      (function spinWait(maxMs=4000, step=120){
        const t0 = Date.now();
        const iv = setInterval(() => {
          if (window.__TERMO_DATA__) {
            try { run(window.__TERMO_DATA__); } catch {}
            clearInterval(iv);
          } else if (Date.now() - t0 > maxMs) {
            clearInterval(iv);
          }
        }, step);
      })();

      document.addEventListener('DOMContentLoaded', () => {
        // Fallback caso não haja injeção externa
        if (!window.__TERMO_DATA__) {
          if (window.__DEBUG_SOLIC_CRP__) console.warn('termo_solic_crp: NO __TERMO_DATA__, using fallback');
          setTimeout(() => {
            if (!window.__TERMO_DATA__) {
              run({ __NA_ALL: true, __NA_LABEL: 'Não preenchido' });
            }
          }, 600);
        }
      });
    })();
  </script>
  -->
  <script>
    (function () {
      const $  = (s, r=document) => r.querySelector(s);
      const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));

      /* ===== Fallbacks “Não informado” ===== */
      const __NA_LABEL__ = () =>
        String((window.__TERMO_DATA__ && window.__TERMO_DATA__.__NA_LABEL) || 'Não informado');
      const __NA_ALL__ = () => {
        const d = window.__TERMO_DATA__;
        return (d && Object.prototype.hasOwnProperty.call(d, '__NA_ALL'))
          ? !!d.__NA_ALL : true;
      };
      function fillText(key, val){
        const raw = (val == null) ? '' : String(val);
        const trimmed = raw.trim();
        const s = trimmed || (__NA_ALL__() ? __NA_LABEL__() : '');
        $$('[data-k="'+key+'"]').forEach(el => { el.textContent = s; });
      }

      /* ===== Utilitários ===== */
      function escapeHtml(s){ return String(s||'').replace(/[&<>\"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]); }

      function asArr(v){
        if (Array.isArray(v)) return v;
        if (v == null || v === '') return [];
        if (typeof v === 'string') {
          const s = v.trim();
          if (!s) return [];
          // Tenta JSON primeiro (caso venha stringified)
          if ((s.startsWith('[') && s.endsWith(']'))) {
            try {
              const j = JSON.parse(s);
              if (Array.isArray(j)) return j.filter(Boolean).map(x=>String(x).trim()).filter(Boolean);
            } catch(_) {}
          }
          // CRÍTICO: Separa por ponto-e-vírgula (padrão do seu frontend) ou quebra de linha
          return s.split(/;|\r?\n/).map(t=>t.trim()).filter(Boolean);
        }
        return [String(v)].filter(Boolean);
      }

      function splitLines(s){ return String(s||'').split(/\r?\n/).map(t=>t.trim()).filter(Boolean); }

      function liList(sel, arr){
        const ul = document.querySelector(sel);
        if (!ul) return false; 
        const a = asArr(arr);
        
        // Se tiver itens, preenche e retorna true
        if (a.length) {
          ul.innerHTML = a.map(x=>`<li>${escapeHtml(x)}</li>`).join('');
          return true;
        } 
        
        // Se vazio, limpa o HTML para não ocupar espaço no PDF
        ul.innerHTML = ''; 
        return false;
      }
      const fillList = liList;

      function renderParagraphs(sel, s){
        const el = document.querySelector(sel);
        if (!el) return false;
        const lines = splitLines(s);
        
        if (lines.length) {
          el.innerHTML = lines.map(x=>`<p>${escapeHtml(x)}</p>`).join('');
          return true;
        }
        el.innerHTML = ''; 
        return false;
      }
      const fillBlock = renderParagraphs;

      function fillValue(sel, val) {
        const el = $(sel);
        if (!el) return false;
        const s = String(val || '').trim();
        if (s) {
          el.innerHTML = escapeHtml(s).replace(/\r?\n/g, '<br>');
          return true;
        }
        el.innerHTML = ''; 
        return false;
      }

      function show(sel, visible) {
        const el = $(sel);
        if (el) {
          el.hidden = !visible;
          el.style.display = visible ? '' : 'none';
        }
      }

      /* ===== Normalização do payload (AQUI ESTÁ A MÁGICA) ===== */
      function normalizePayload(p0){
        const p = Object.assign({}, p0);

        // Helper para buscar chaves de forma insensível (minúsculo, maiúsculo, array)
        const getAny = (...keys) => {
            for (const k of keys) {
                if (p[k] !== undefined && p[k] !== null && p[k] !== '') return p[k];
                // Tenta versão lowercase (comum vindo do server.js flatten)
                const lower = k.toLowerCase();
                if (p[lower] !== undefined && p[lower] !== null && p[lower] !== '') return p[lower];
            }
            return undefined;
        };

        // 3.1 e 3.2 CRP
        p.DATA_VENC_ULTIMO_CRP = getAny('DATA_VENC_ULTIMO_CRP', 'DATA_VENCIMENTO_ULTIMO_CRP', 'venc_ult_crp', 'data_vencimento_ultimo_crp') || '';
        p.TIPO_EMISSAO_ULTIMO_CRP = getAny('TIPO_EMISSAO_ULTIMO_CRP', 'tipo_emissao_ult_crp', 'tipo_emissao_ultimo_crp', 'tipo') || '';
        
        let tCrp = String(p.TIPO_EMISSAO_ULTIMO_CRP).trim().toLowerCase();
        if (tCrp.startsWith('adm') || tCrp === 'nao' || tCrp === 'n') p.TIPO_EMISSAO_ULTIMO_CRP = 'Administrativa';
        if (tCrp.startsWith('jud') || tCrp === 'sim' || tCrp === 's') p.TIPO_EMISSAO_ULTIMO_CRP = 'Judicial';
        
        // Espelhos data-k
        p.data_vencimento_ultimo_crp = p.DATA_VENC_ULTIMO_CRP;
        p.tipo_emissao_ult_crp = p.TIPO_EMISSAO_ULTIMO_CRP;

        // 3.3 Critérios
        p.__CRITERIOS_ARR__ = asArr(getAny('CRITERIOS_IRREGULARES', 'CRITERIOS_LIST', 'criterios_irregulares'));

        // 3.4 Prazo Adicional
        p.PRAZO_ADICIONAL_TEXTO = getAny('PRAZO_ADICIONAL_TEXTO', 'prazo_adicional_texto') || '';
        let prazoCod = getAny('PRAZO_ADICIONAL_COD', 'prazo_adicional_cod', 'prazo_adicional');
        if (prazoCod) {
             const m = String(prazoCod).match(/3\.[24]\.(\d)/);
             if (m) prazoCod = `3.4.${m[1]}`;
        }
        p.PRAZO_ADICIONAL_COD = prazoCod || '';

        // 4. Fase Selecionada
        p.__FASE_SEL__ = String(getAny('__FASE_SEL__', 'FASE_PROGRAMA', 'fase_programa', 'FASE') || '').trim();

        // === LISTAS DAS FASES ===
        
        // 4.1
        p.F41_OPCAO_TEXT = getAny('F41_OPCAO_TEXT', 'F41_OPCAO', 'f41_opcao', 'CELEBRACAO_TERMO_PARCELA_DEBITOS') || '';

        // 4.2
        p.F42_LISTA = asArr(getAny('F42_LISTA', 'F42_LISTA[]', 'F42_ITENS', 'F42_ITENS[]'));

        // 4.3 (Seus campos problemáticos)
        p.F43_LISTA = asArr(getAny('F43_LISTA', 'F43_LISTA[]', 'F43_ITENS', 'F43_ITENS[]'));
        p.F43_INCLUIR = asArr(getAny('F43_INCLUIR', 'F43_INCLUIR[]', 'f43_incluir', 'F43_INCLUIR_TXT'));
        p.F43_INCLUIR_B = asArr(getAny('F43_INCLUIR_B', 'F43_INCLUIR_B[]', 'f43_incluir_b'));
        
        p.F43_PLANO = getAny('F43_PLANO', 'f43_plano') || '';
        p.F43_PLANO_B = getAny('F43_PLANO_B', 'f43_plano_b') || '';
        p.F43_DESC_PLANOS = getAny('F43_DESC_PLANOS', 'f43_desc_planos') || '';
        p.F43_JUST = getAny('F43_JUST', 'f43_just') || '';
        
        p.F4310_OPCAO = getAny('F4310_OPCAO', 'f4310_opcao') || '';
        p.F4310_LEGISLACAO = getAny('F4310_LEGISLACAO', 'f4310_legislacao') || '';
        p.F4310_DOCS = getAny('F4310_DOCS', 'f4310_docs') || '';

        // 4.4
        p.F44_CRITERIOS = asArr(getAny('F44_CRITERIOS', 'F44_CRITERIOS[]', 'f44_criterios'));
        p.F44_DECLS = asArr(getAny('F44_DECLS', 'F44_DECLS[]', 'f44_decls'));
        p.F44_FINALIDADES = asArr(getAny('F44_FINALIDADES', 'F44_FINALIDADES[]', 'f44_finalidades'));
        p.F44_ANEXOS = getAny('F44_ANEXOS', 'f44_anexos') || '';
        p.F441_LEGISLACAO = getAny('F441_LEGISLACAO', 'f441_legislacao') || '';
        p.F445_DESC_PLANOS = getAny('F445_DESC_PLANOS', 'f445_desc_planos') || '';
        p.F446_DOCS = getAny('F446_DOCS', 'f446_docs') || '';
        p.F446_EXEC_RES = getAny('F446_EXEC_RES', 'f446_exec_res') || '';

        // 4.5
        p.F45_DECLS = asArr(getAny('F45_DECLS', 'F45_DECLS[]', 'f45_decls', 'F45_CONDICOES[]'));
        p.F45_DOCS = getAny('F45_DOCS', 'f45_docs') || '';
        p.F45_JUST = getAny('F45_JUST', 'f45_just') || '';
        p.F453_EXEC_RES = getAny('F453_EXEC_RES', 'f453_exec_res') || '';

        // 4.6
        p.F46_CRITERIOS = asArr(getAny('F46_CRITERIOS', 'F46_CRITERIOS[]', 'f46_criterios'));
        p.F46_FINALIDADES = asArr(getAny('F46_FINALIDADES', 'F46_FINALIDADES[]', 'f46_finalidades'));
        p.F462F_CRITERIOS = asArr(getAny('F462F_CRITERIOS', 'F462F_CRITERIOS[]', 'f462f_criterios'));
        // Unifica critérios estruturantes da 4.6
        p.F46_CRITERIOS = [...p.F46_CRITERIOS, ...p.F462F_CRITERIOS];
        
        p.F46_PROGESTAO = getAny('F46_PROGESTAO', 'f46_progestao') || '';
        p.F46_PORTE = getAny('F46_PORTE', 'f46_porte') || '';
        p.F46_JUST_D = getAny('F46_JUST_D', 'f46_just_d') || '';
        p.F46_DOCS_D = getAny('F46_DOCS_D', 'f46_docs_d') || '';
        p.F46_JUST_E = getAny('F46_JUST_E', 'f46_just_e') || '';
        p.F46_DOCS_E = getAny('F46_DOCS_E', 'f46_docs_e') || '';
        p.F466_DOCS = getAny('F466_DOCS', 'f466_docs') || '';
        p.F466_EXEC_RES = getAny('F466_EXEC_RES', 'f466_exec_res') || '';

        // 5. Justificativas Gerais
        p.JUSTIFICATIVAS_GERAIS = getAny('JUSTIFICATIVAS_GERAIS', 'justificativas_gerais') || '';

        // 6. Data Termo
        p.data_termo = getAny('DATA_TERMO_GERADO', 'DATA_SOLIC_GERADA', 'data_termo', 'data') || '';

        return p;
      }

      function hojeBR_robusto(){
        try{
          const s = new Date().toLocaleDateString('pt-BR');
          if (s && /\d{2}\/\d{2}\/\d{4}/.test(s)) return s;
        }catch(_){}
        return '';
      }

      function normalizarEsfera(txt){
        const t = String(txt||'').toLowerCase();
        if (t.includes('estadual') || t.includes('distrit')) return '1.1.2 RPPS Estadual/Distrital';
        if (t.includes('municip')) return '1.1.1 RPPS Municipal';
        return (typeof __NA_ALL__==='function' && __NA_ALL__()) ? __NA_LABEL__() : '—';
      }

      // ========= Função principal (Render) =========
      function run(payload){
        // 🚨 TESTE 1: Payload Bruto (para checar a comunicação)
        console.log('TERMO: RAW Payload recebido:', JSON.stringify(payload));

        const p = normalizePayload(payload || {});
        window.__TERMO_DATA__ = Object.assign({}, window.__TERMO_DATA__ || {}, p);

        // 🚨 TESTE 2: Chaves F43 após a normalização (o que o script está vendo)
        console.log('TERMO: Normalized F43 keys:', {
            F43_LISTA: p.F43_LISTA,
            F43_INCLUIR: p.F43_INCLUIR,
            F43_INCLUIR_B: p.F43_INCLUIR_B,
            F43_PLANO: p.F43_PLANO,
            F43_PLANO_B: p.F43_PLANO_B,
            F43_DESC_PLANOS: p.F43_DESC_PLANOS,
            F43_JUST: p.F43_JUST
        });
        
        // 1) Cabeçalho/meta
        ['ente','uf','ug','cnpj_ente','cnpj_ug','email_ente','email_ug',
         'N_GESCON','DATA_ENC_VIA_GESCON','SEI_PROCESSO','PORTARIA_SRPC',
         'ORGAO_VINCULACAO_UG','nome_rep_ente','cargo_rep_ente','cpf_rep_ente',
         'email_rep_ente','tel_rep_ente','nome_rep_ug','cargo_rep_ug','cpf_rep_ug',
         'email_rep_ug','tel_rep_ug','data_vencimento_ultimo_crp','tipo_emissao_ult_crp'
        ].forEach(k => {
             let val = p[k] || p[k.toUpperCase()] || p[k.toLowerCase()];
             fillText(k, val);
        });
        
        // 3.4 Prazo Adicional
        (function applyPrazoAdicional(code){
          const itens = Array.from(document.querySelectorAll('[data-3_4]'));
          let mostrou = false;
          itens.forEach(el => {
            const tag = (el.getAttribute('data-3_4') || '').trim();
            const ok  = code && tag === code;
            if (ok) { el.style.display = ''; mostrou = true; }
            else { el.remove(); }
          });
          const holder = document.querySelector('[data-k="PRAZO_ADICIONAL_TEXTO"]');
          if (holder) {
            if (mostrou) holder.classList.add('d-none');
            else {
              const txt = p.PRAZO_ADICIONAL_TEXTO || 'Não informado';
              holder.textContent = txt;
              holder.classList.toggle('d-none', !txt.trim());
            }
          }
        })(p.PRAZO_ADICIONAL_COD);

        // 3.3 Listas
        fillList('#criterios-list', p.__CRITERIOS_ARR__);

        // 4) Fase Selecionada
        let faseSel = p.__FASE_SEL__;
        if (!faseSel) {
           // Auto-detecção se vazio
           if (p.F41_OPCAO_TEXT) faseSel = '4.1';
           else if (p.F42_LISTA.length) faseSel = '4.2';
           else if (p.F43_LISTA.length || p.F43_INCLUIR.length || p.F43_PLANO) faseSel = '4.3';
           else if (p.F44_DECLS.length) faseSel = '4.4';
           else if (p.F45_DECLS.length) faseSel = '4.5';
           else if (p.F46_DECLS.length || p.F46_CRITERIOS.length) faseSel = '4.6';
        }

        // Oculta label "Fase selecionada:"
        const faseTxtEl = document.getElementById('fase-escolhida');
        if (faseTxtEl && faseTxtEl.parentElement) faseTxtEl.parentElement.hidden = true;

        function togglePhaseBlock(id, hasContent) {
          const el = $(id);
          if (el) {
            el.hidden = !hasContent;
            el.setAttribute('data-empty', hasContent ? 'false' : 'true');
          }
        }

        // --- FASE 4.1 ---
        togglePhaseBlock('#fase-41', !!p.F41_OPCAO_TEXT);
        const ul41 = $('#f41-itens');
        if(ul41) ul41.innerHTML = p.F41_OPCAO_TEXT ? `<li>${escapeHtml(p.F41_OPCAO_TEXT)}</li>` : '';

        // --- FASE 4.2 ---
        togglePhaseBlock('#fase-42', fillList('#f42-itens', p.F42_LISTA));

        // --- FASE 4.3 (LISTA COMPLETA) ---
        (function run43(){
          let hasContent = false;
          
          // 4.3.1 a 4.3.9 (filtra da lista geral F43_LISTA)
          const allItens = p.F43_LISTA;
          const filterList = (keys) => allItens.filter(item => {
            const lowItem = (item || '').toLowerCase();
            return keys.some(k => lowItem.includes(k));
          });

          if (fillList('#f43-itens-1', filterList(['dipr', 'caráter contributivo', 'repasse', 'aportes', 'parcelamento']))) hasContent = true;
          if (fillList('#f43-itens-2', filterList(['utilização dos recursos']))) hasContent = true;
          if (fillList('#f43-itens-3', filterList(['aplicações financeiras', 'dair', 'dpin']))) hasContent = true;
          if (fillList('#f43-itens-4', filterList(['limites de contribuição']))) hasContent = true;
          if (fillList('#f43-itens-5', filterList(['rol de benefícios', 'plano de benefícios']))) hasContent = true;
          if (fillList('#f43-itens-6', filterList(['previdência complementar', 'rpc']))) hasContent = true;
          if (fillList('#f43-itens-7', filterList(['envio de dados', 'solicitação de legislação', 'atendimento à fiscalização', 'nta', 'draa', 'msc', 'esocial']))) hasContent = true;
          if (fillList('#f43-itens-8', filterList(['compensação previdenciária']))) hasContent = true;
          if (fillList('#f43-itens-9', filterList(['requisitos dos dirigentes', 'colegiados', 'art. 8º-b']))) hasContent = true;

          // 4.3.10
          const opt4310 = String(p.F4310_OPCAO || '').trim().toLowerCase();
          const optA = opt4310.startsWith('a');
          const optB = opt4310.startsWith('b');
          show('#f43-opcao-a', optA);
          show('#f43-opcao-b', optB);
          if (optA) { fillBlock('[data-k="F4310_LEGISLACAO"]', p.F4310_LEGISLACAO); hasContent = true; }
          if (optB) { fillBlock('[data-k="F4310_DOCS"]', p.F4310_DOCS); hasContent = true; }

          // 4.3.11 (Campos F43_INCLUIR e F43_PLANO)
          // fillList retorna true se array tiver itens. fillValue retorna true se texto existir.
          const h11_1 = fillList('#f43-crit-incluir', p.F43_INCLUIR);
          const h11_2 = fillValue('#f43-just-11', p.F43_PLANO); 
          
          if (h11_1 || h11_2) {
              show('#f43-sub-11', true); 
              hasContent = true;
          } else { 
              show('#f43-sub-11', false); 
          }

          // 4.3.12 (Campos F43_INCLUIR_B, F43_PLANO_B, F43_DESC_PLANOS)
          const h12_1 = fillList('#f43-crit-incluir-12', p.F43_INCLUIR_B);
          const h12_2 = fillValue('#f43-just-12', p.F43_PLANO_B);
          const h12_3 = fillValue('#f43-desc-planos-12', p.F43_DESC_PLANOS);
          
          if (h12_1 || h12_2 || h12_3) {
              show('#f43-sub-12', true); 
              hasContent = true;
          } else { 
              show('#f43-sub-12', false); 
          }
          
          togglePhaseBlock('#fase-43', hasContent);
        })();

        // --- FASE 4.4 ---
        (function run44(){
          let hasContent = false;
          if (fillList('#f44-decls', p.F44_DECLS)) hasContent = true;
          
          const hasLeg = (p.F441_LEGISLACAO || '').trim();
          show('#f44-leg-wrap', !!hasLeg);
          if (hasLeg) { fillBlock('[data-k="F441_LEGISLACAO"]', p.F441_LEGISLACAO); hasContent = true; }

          if (fillList('#f44-finalidades', p.F44_FINALIDADES)) hasContent = true;
          if (fillList('#f44-criterios', p.F44_CRITERIOS)) hasContent = true;
          if (fillBlock('[data-k="F44_ANEXOS"]', p.F44_ANEXOS)) hasContent = true;
          if (fillBlock('[data-k="F445_DESC_PLANOS"]', p.F445_DESC_PLANOS)) hasContent = true;
          if (fillBlock('[data-k="F446_DOCS"]', p.F446_DOCS)) hasContent = true;
          if (fillBlock('[data-k="F446_EXEC_RES"]', p.F446_EXEC_RES)) hasContent = true;
          
          togglePhaseBlock('#fase-44', hasContent);
        })();

        // --- FASE 4.5 ---
        (function run45(){
          let hasContent = false;
          if (fillList('#f45-decls', p.F45_DECLS)) hasContent = true;
          if (fillBlock('[data-k="F45_DOCS"]', p.F45_DOCS)) hasContent = true;
          if (fillBlock('[data-k="F45_JUST"]', p.F45_JUST)) hasContent = true;
          if (fillBlock('[data-k="F453_EXEC_RES"]', p.F453_EXEC_RES)) hasContent = true;
          togglePhaseBlock('#fase-45', hasContent);
        })();

        // --- FASE 4.6 ---
        (function run46(){
          let hasContent = false;
          if (fillList('#f46-criterios', p.F46_CRITERIOS)) hasContent = true;
          if (fillBlock('[data-k="F46_PROGESTAO"]', p.F46_PROGESTAO)) hasContent = true;
          if (fillBlock('[data-k="F46_PORTE"]', p.F46_PORTE)) hasContent = true;
          if (fillBlock('[data-k="F46_JUST_D"]', p.F46_JUST_D)) hasContent = true;
          if (fillBlock('[data-k="F46_DOCS_D"]', p.F46_DOCS_D)) hasContent = true;
          if (fillBlock('[data-k="F46_JUST_E"]', p.F46_JUST_E)) hasContent = true;
          if (fillBlock('[data-k="F46_DOCS_E"]', p.F46_DOCS_E)) hasContent = true;
          if (fillList('#f46-finalidades', p.F46_FINALIDADES)) hasContent = true;
          if (fillBlock('[data-k="F466_DOCS"]', p.F466_DOCS)) hasContent = true;
          if (fillBlock('[data-k="F466_EXEC_RES"]', p.F466_EXEC_RES)) hasContent = true;
          togglePhaseBlock('#fase-46', hasContent);
        })();

        // 5) Justificativas Gerais
        fillText('justificativas_gerais', p.JUSTIFICATIVAS_GERAIS);
        
        // 6) Data e Assinaturas
        let dataTermo = p.data_termo || hojeBR_robusto();
        fillText('data_termo', dataTermo);

        // 7) Esfera
        const esferaTxt = normalizarEsfera(p.ESFERA);
        const esferaNode = document.querySelector('[data-esfera]');
        if (esferaNode) esferaNode.textContent = esferaTxt;
        (function(){
          const sig = document.getElementById('sig-cap-ente');
          if (sig) {
            const isEstDistr = /Estadual\/Distrital/i.test(esferaTxt);
            sig.innerHTML = isEstDistr
              ? 'Representante legal do Estado/Distrito de <span data-k="ente"></span>/<span data-k="uf"></span>'
              : 'Representante legal do Município de <span data-k="ente"></span>/<span data-k="uf"></span>';
            fillText('ente', p.ENTE); fillText('uf', p.UF);
          }
        })();

        // Flag de pronto para Puppeteer
        if (!window.__TERMO_READY_FIRED__) {
            window.__TERMO_READY_FIRED__ = true;
            requestAnimationFrame(() => {
                document.documentElement.setAttribute('data-termo-ready','1');
                window.__TERMO_PRINT_READY__ = true;
                try { document.dispatchEvent(new CustomEvent('TERMO_PRINT_READY')); } catch {}
            });
        }
      }

      // Exposição global
      window.run = run;
      window.__TERMO_RUN__ = run;

      // Inicialização
      if (window.__TERMO_DATA__) { 
          try { run(window.__TERMO_DATA__); } catch {} 
      }
      document.addEventListener('TERMO_DATA_READY', () => { try { run(window.__TERMO_DATA__ || {}); } catch {} });
      document.addEventListener('TERMO_DATA',       () => { try { run(window.__TERMO_DATA__ || {}); } catch {} });
      
      // Fallback
      setTimeout(() => {
         if (!window.__TERMO_READY_FIRED__) {
             run(window.__TERMO_DATA__ || {__NA_ALL:true});
         }
      }, 800);
    })();
  </script>
</body>
</html>