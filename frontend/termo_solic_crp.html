<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Termo de Solicitação de CRP Emergencial</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Montserrat:wght@600;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="./termo_solic_crp.css">
</head>
<body>
  <header class="prp-header" aria-hidden="true">
    <div class="logos-wrap">
      <img src="./imagens/logo-secretaria-complementar.svg" alt="Secretaria" loading="eager" />
      <img src="./imagens/logo-termo-drpps.svg" alt="Departamento de RPPS" loading="eager" />
    </div>
  </header>
  
  <main class="termo-wrap">
    <h1>Termo de Solicitação de CRP Emergencial</h1>
    
    <div class="secao">
      <h3>1. Informações do Ente e da Unidade Gestora</h3>
      
      <div class="campo-linha">
        <span class="label">Ente:</span>
        <span class="valor" data-k="ente"></span> / <span class="valor" data-k="uf"></span>
      </div>
      <div class="campo-linha">
        <span class="label">Esfera de Governo:</span>
        <span class="valor" data-esfera></span>
      </div>
      <div class="campo-linha">
        <span class="label">CNPJ do Ente:</span>
        <span class="valor" data-k="cnpj_ente"></span>
      </div>
      <div class="campo-linha">
        <span class="label">E-mail do Ente:</span>
        <span class="valor" data-k="email_ente"></span>
      </div>
      
      <div class="campo-linha">
        <span class="label">Unidade Gestora (UG):</span>
        <span class="valor" data-k="ug"></span>
      </div>
      <div class="campo-linha">
        <span class="label">CNPJ da UG:</span>
        <span class="valor" data-k="cnpj_ug"></span>
      </div>
      <div class="campo-linha">
        <span class="label">E-mail da UG:</span>
        <span class="valor" data-k="email_ug"></span>
      </div>
      <div class="campo-linha">
        <span class="label">Órgão de Vinculação da UG:</span>
        <span class="valor" data-k="ORGAO_VINCULACAO_UG"></span>
      </div>
      
      <div class="campo-linha">
        <span class="label">Nº GESCON:</span>
        <span class="valor" data-k="N_GESCON"></span>
      </div>
      <div class="campo-linha">
        <span class="label">Data de Encaminhamento via GESCON:</span>
        <span class="valor" data-k="DATA_ENC_VIA_GESCON"></span>
      </div>
      <div class="campo-linha">
        <span class="label">Processo SEI:</span>
        <span class="valor" data-k="SEI_PROCESSO"></span>
      </div>
      <div class="campo-linha">
        <span class="label">Portaria SRPC:</span>
        <span class="valor" data-k="PORTARIA_SRPC"></span>
      </div>
    </div>

    <div class="secao">
      <h3>2. Representantes Legais</h3>
      
      <h4>Representante do Ente</h4>
      <div class="campo-linha"><span class="label">Nome:</span> <span class="valor" data-k="nome_rep_ente"></span></div>
      <div class="campo-linha"><span class="label">CPF:</span> <span class="valor" data-k="cpf_rep_ente"></span></div>
      <div class="campo-linha"><span class="label">Cargo:</span> <span class="valor" data-k="cargo_rep_ente"></span></div>
      <div class="campo-linha"><span class="label">E-mail:</span> <span class="valor" data-k="email_rep_ente"></span></div>
      <div class="campo-linha"><span class="label">Telefone:</span> <span class="valor" data-k="tel_rep_ente"></span></div>
      
      <h4>Representante da Unidade Gestora</h4>
      <div class="campo-linha"><span class="label">Nome:</span> <span class="valor" data-k="nome_rep_ug"></span></div>
      <div class="campo-linha"><span class="label">CPF:</span> <span class="valor" data-k="cpf_rep_ug"></span></div>
      <div class="campo-linha"><span class="label">Cargo:</span> <span class="valor" data-k="cargo_rep_ug"></span></div>
      <div class="campo-linha"><span class="label">E-mail:</span> <span class="valor" data-k="email_rep_ug"></span></div>
      <div class="campo-linha"><span class="label">Telefone:</span> <span class="valor" data-k="tel_rep_ug"></span></div>
    </div>

    <div class="secao">
      <h3>3. Informações sobre o CRP</h3>
      <div class="campo-linha">
        <span class="label">Vencimento do último CRP:</span>
        <span class="valor" data-k="venc_ult_crp"></span>
      </div>
      <div class="campo-linha">
        <span class="label">Tipo de Emissão do último CRP:</span>
        <span class="valor" data-k="tipo_emissao_ult_crp"></span>
      </div>

      <h4>3.1 Solicitação de Prazo Adicional (se aplicável)</h4>
      <p data-3_4="A" style="display: none;">
        **Alternativa A:** Justificativa da não aplicação dos arts. 16, 17 e 18 da Portaria MTP nº 1.467/2022 (necessidade de medidas adicionais para obter a regularidade).
      </p>
      <p data-3_4="B" style="display: none;">
        **Alternativa B:** Não atendimento das exigências da Portaria MTP nº 1.467/2022 no prazo estipulado (necessidade de maior prazo para implementar as medidas).
      </p>
      <div class="campo-linha" data-k="PRAZO_ADICIONAL_TEXTO"></div>
      
      <h4>3.2 Critérios Estruturantes Atendidos (se aplicável)</h4>
      <ul id="criterios-list">
        </ul>
    </div>
    
    <div class="secao">
      <h3>4. Fase do Programa de Regularidade RPPS</h3>
      <div class="campo-linha">
        <span class="label">Fase Selecionada:</span>
        <span class="valor" data-k="FASE_PROGRAMA"></span>
      </div>

      <div id="fase-41" hidden>
        <h4>4.1 Fase I – Apresentação de Informações e Documentos</h4>
        <p>Opção escolhida:</p>
        <ul id="f41-itens"></ul>
      </div>

      <div id="fase-42" hidden>
        <h4>4.2 Fase II – Regularização de Pendências Administrativas</h4>
        <p>Pendências a serem regularizadas:</p>
        <ul id="f42-itens"></ul>
      </div>

      <div id="fase-43" hidden>
        <h4>4.3 Fase III – Equilíbrio Financeiro e Atuarial</h4>
        
        <h5>4.3.1 Déficit Atuarial</h5>
        <p>Item(ns) em situação irregular ou que requer(em) atenção:</p>
        <ul id="f43-itens"></ul>
        
        <div class="campo-linha">
          <span class="label">Justificativa da Situação Atual (4.3.1):</span>
          <span class="valor" id="f43-just"></span>
        </div>
        
        <h5>4.3.2 Plano de Equacionamento do Déficit Atuarial (se aplicável)</h5>
        <div class="campo-linha">
          <span class="label">Descrição do Plano A:</span>
          <span class="valor" id="f43-plano"></span>
        </div>
        <div class="campo-linha">
          <span class="label">Descrição do Plano B:</span>
          <span class="valor" id="f43-plano-b"></span>
        </div>
        
        <h5>4.3.10 Regras de Elegibilidade, Cálculo e Reajustamento</h5>
        <ul id="f4310"></ul>
        
        <h5>4.3.12 Planos de Ação (Itens Adicionais)</h5>
        <p>Critérios a incluir no Plano de Ação:</p>
        <ul id="f43-incluir"></ul>
        <p>Descrição dos Planos de Ação incluídos:</p>
        <div id="f43-desc-planos"></div>
      </div>

      <div id="fase-44" hidden>
        <h4>4.4 Fase IV – Estrutura Administrativa e Governança</h4>
        
        <h5>4.4.1 Critérios Estruturantes</h5>
        <p>Critérios Estruturantes a serem estabelecidos:</p>
        <ul id="f44-criterios"></ul>
        <div class="campo-linha">
          <span class="label">Legislação sobre Critérios Estruturantes (4.4.1):</span>
          <span class="valor" id="f441-legislacao"></span>
        </div>
        
        <h5>4.4.2 a 4.4.4 Declarações</h5>
        <p>Declarações prestadas:</p>
        <ul id="f44-decls"></ul>
        
        <h5>4.4.5 Planos de Ação</h5>
        <p>Descrição dos Planos de Ação:</p>
        <div id="f445-desc-planos"></div>
        
        <h5>4.4.6 Finalidades (Anexos e Execução)</h5>
        <p>Finalidades selecionadas:</p>
        <ul id="f44-finalidades"></ul>
        <div class="campo-linha">
          <span class="label">Anexos Comprobatórios (4.4):</span>
          <div id="f44-anexos"></div>
        </div>
        <div class="campo-linha">
          <span class="label">Documentos para Finalidades (4.4.6):</span>
          <div id="f446-docs"></div>
        </div>
        <div class="campo-linha">
          <span class="label">Execução de Recursos para Finalidades (4.4.6):</span>
          <div id="f446-exec"></div>
        </div>
      </div>

      <div id="fase-45" hidden>
        <h4>4.5 Fase V – Investimentos e Aplicações Financeiras</h4>
        
        <h5>4.5.1 a 4.5.2 Declarações</h5>
        <p>Declarações prestadas:</p>
        <ul id="f45-decls"></ul>
        
        <h5>4.5.3 Justificativas e Documentos</h5>
        <div class="campo-linha">
          <span class="label">Documentos/Anexos (4.5):</span>
          <div id="f45-docs"></div>
        </div>
        <div class="campo-linha">
          <span class="label">Justificativas (4.5):</span>
          <div id="f45-just"></div>
        </div>
        <div class="campo-linha">
          <span class="label">Execução de Recursos (4.5.3):</span>
          <div id="f45-exec"></div>
        </div>
      </div>

      <div id="fase-46" hidden>
        <h4>4.6 Fase VI – Manutenção da Conformidade</h4>
        
        <h5>4.6.1 a 4.6.4 Declarações e Critérios</h5>
        <p>Critérios Declarados Regulares (4.6.1, item a):</p>
        <ul id="f46-criterios"></ul>
        
        <p>Informações e Declarações Adicionais:</p>
        <ul id="f46-decls"></ul>
        
        <h5>4.6.5 Finalidades</h5>
        <p>Finalidades selecionadas:</p>
        <ul id="f46-finalidades"></ul>
        
        <div class="campo-linha">
          <span class="label">Justificativa sobre Planos de Ação (4.6.5):</span>
          <span class="valor" id="f46-just-planos"></span>
        </div>
        
        <h5>4.6.6 Critérios de Maior Complexidade (Finalidade 'f')</h5>
        <p>Critérios selecionados:</p>
        <ul id="f462f-criterios"></ul>
        <div class="campo-linha">
          <span class="label">Documentos para Finalidade 'f' (4.6.6):</span>
          <div id="f466-docs"></div>
        </div>
        <div class="campo-linha">
          <span class="label">Execução de Recursos para Finalidade 'f' (4.6.6):</span>
          <div id="f466-exec"></div>
        </div>
        <div class="campo-linha">
          <span class="label">Anexos Comprobatórios (Geral):</span>
          <div id="f46-anexos"></div>
        </div>
      </div>

      <div class="secao fase-extras">
        <h4>Campos Extras da Fase <span data-k="FASE_PROGRAMA"></span></h4>
        <div id="fase-extra-campos">
          </div>
      </div>
    </div>
    
    <div class="secao">
      <h3>5. Justificativas Gerais</h3>
      <p class="conteudo-justificativa" data-k="justificativas_gerais"></p>
    </div>

    <div class="secao">
      <p>O presente Termo é emitido na data de **<span data-k="data_termo"></span>**.</p>
      
      <div class="assinaturas-wrap">
        <div class="assinatura">
          <div class="sig-placeholder"></div>
          <span class="nome" data-k="NOME_REP_UG"></span>
          <span class="cargo" data-k="CARGO_REP_UG"></span>
          <span class="legenda">Representante da Unidade Gestora (<span data-k="UG"></span>)</span>
        </div>
        <div class="assinatura">
          <div class="sig-placeholder"></div>
          <span class="nome" data-k="NOME_REP_ENTE"></span>
          <span class="cargo" data-k="CARGO_REP_ENTE"></span>
          <span class="legenda" id="sig-cap-ente">
            Representante legal do Município de <span data-k="ente"></span>/<span data-k="uf"></span>
          </span>
        </div>
      </div>
      <p class="alerta-assinatura">Este documento dispensa assinatura física. Sua validade é atestada pela plataforma de geração.</p>
    </div>
  </main>

  <script>
    // Flag de debug
    window.__DEBUG_SOLIC_CRP__ = true;
    
    // VARIÁVEIS GLOBAIS (Mock de Fallback caso não sejam injetadas)
    if (typeof __NA_ALL__ !== 'function') {
      window.__NA_ALL__ = () => window.__TERMO_DATA__?.__NA_ALL__ || false;
    }
    if (typeof __NA_LABEL__ !== 'function') {
      window.__NA_LABEL__ = () => window.__TERMO_DATA__?.__NA_LABEL__ || 'Não informado';
    }

    // UTILS INFERIDOS (Necessários para as funções liList/run)
    function asArr(v) {
      if (Array.isArray(v)) return v.filter(x => x != null && String(x).trim() !== '').map(String);
      if (v == null) return [];
      const s = String(v).trim();
      if (!s) return [];
      return s.split(/[;,]\s*|\r?\n/).map(x => x.trim()).filter(Boolean);
    }
    function splitLines(s) { return asArr(s); }
    function escapeHtml(s) {
      if (s == null) return '';
      return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
    }
    function fillText(id, v) {
      const vStr = String(v || '').trim() || (window.__NA_ALL__() ? window.__NA_LABEL__() : '—');
      document.querySelectorAll(`[data-k="${id}"], #${id}`).forEach(el => {
        el.textContent = vStr;
      });
    }
    function liList(selector, arr) {
      const ul = document.querySelector(selector);
      if (!ul) return;
      const list = asArr(arr);
      ul.innerHTML = list.length
        ? list.map(a => `<li>${escapeHtml(a)}</li>`).join('')
        : `<li><span class="muted">${window.__NA_ALL__() ? escapeHtml(window.__NA_LABEL__()) : '—'}</span></li>`;
    }

    // FUNÇÕES DO CÓDIGO FORNECIDO (PARTE 1 E 2 COMBINADAS)
    (function(){
      
      // ========= Funções auxiliares =========

      function normalizePayload(payload) {
        const p = payload || {};
        // Aliases mínimos
        const _split = v => Array.isArray(v) ? v : String(v||'').split(/[;\n\r]+/).map(s => s.trim()).filter(Boolean);
        if (!p.F42_LISTA?.length) p.F42_LISTA = _split(p.REGULARIZACAO_PENDEN_ADMINISTRATIVA || p.reg_penden_admin || '');
        if (!p.F43_LISTA?.length) p.F43_LISTA = _split(p.DEFICIT_ATUARIAL || p.deficit_atuarial || '');
        if (!p.F44_CRITERIOS?.length) p.F44_CRITERIOS = _split(p.CRITERIOS_ESTRUT_ESTABELECIDOS || p.criterios_estrut || '');
        if (!p.F46_CRITERIOS?.length) p.F46_CRITERIOS = _split(p.MANUTENCAO_CONFORMIDADE_NORMAS_GERAIS || p.man_conformidade || '');

        // ATUALIZAÇÃO REQUERIDA: Mesclagem da Fase 4.3 (ponto 1 do diagnóstico)
        p.F43_INCLUIR = [...(p.F43_INCLUIR || []), ...(p.F43_INCLUIR_B || [])]; 

        return p;
      }
      function hojeBR_robusto(){
        try{
          const s = new Date().toLocaleDateString('pt-BR');
          if (s && /\d{2}\/\d{2}\/\d{4}/.test(s)) return s;
        }catch(_){}
        const d = new Date();
        const dd = String(d.getDate()).padStart(2,'0');
        const mm = String(d.getMonth()+1).padStart(2,'0');
        const yyyy = String(d.getFullYear());
        return `${dd}/${mm}/${yyyy}`;
      }

      function normalizarEsfera(txt){
        const t = String(txt||'').toLowerCase();
        if (t.includes('estadual') || t.includes('distrit')) return '1.1.2 RPPS Estadual/Distrital';
        if (t.includes('municip')) return '1.1.1 RPPS Municipal';
        return (typeof __NA_ALL__==='function' && __NA_ALL__()) ? __NA_LABEL__() : '—';
      }

      function show(id, v){ const el=document.getElementById(id); if(el) el.hidden=!v; }
      function showOnlyPhase(code){
        const ids = { '4.1':'fase-41','4.2':'fase-42','4.3':'fase-43','4.4':'fase-44','4.5':'fase-45','4.6':'fase-46' };
        Object.values(ids).forEach(id => show(id,false));
        if (ids[code]) show(ids[code], true);
      }

      // ========= Função principal =========
      function run(payload){
        if (window.__DEBUG_SOLIC_CRP__) {
          try { console.log('[E3] template/run → payload (raw)', payload); } catch {}
        }

        const p = normalizePayload(payload || {});
        window.__TERMO_DATA__ = Object.assign({}, window.__TERMO_DATA__ || {}, p);
        if (window.__DEBUG_SOLIC_CRP__) {
          try { console.log('[E3] template/run → payload (normalized)', p); } catch {}
        }
        try { document.dispatchEvent(new Event('TERMO_DATA')); } catch {}

        // 1) Cabeçalho/meta
        fillText('ente', p.ENTE); fillText('uf', p.UF); fillText('ug', p.UG);
        fillText('cnpj_ente', p.CNPJ_ENTE); fillText('cnpj_ug', p.CNPJ_UG);
        fillText('email_ente', p.EMAIL_ENTE); fillText('email_ug', p.EMAIL_UG);
        fillText('N_GESCON', p.N_GESCON || p.n_gescon || '');
        fillText('DATA_ENC_VIA_GESCON', p.DATA_ENC_VIA_GESCON || p.data_enc_via_gescon || '');
        fillText('SEI_PROCESSO', p.SEI_PROCESSO); fillText('PORTARIA_SRPC', p.PORTARIA_SRPC);
        fillText('ORGAO_VINCULACAO_UG', p.ORGAO_VINCULACAO_UG || '');

        // 2) Responsáveis
        fillText('nome_rep_ente',  p.NOME_REP_ENTE);
        fillText('cargo_rep_ente', p.CARGO_REP_ENTE);
        fillText('cpf_rep_ente',   p.CPF_REP_ENTE);
        fillText('email_rep_ente', p.EMAIL_REP_ENTE);
        fillText('tel_rep_ente',   p.TEL_REP_ENTE);

        fillText('nome_rep_ug',  p.NOME_REP_UG);
        fillText('cargo_rep_ug', p.CARGO_REP_UG);
        fillText('cpf_rep_ug',   p.CPF_REP_UG);
        fillText('email_rep_ug', p.EMAIL_REP_UG);
        fillText('tel_rep_ug',   p.TEL_REP_UG);

        // 3) CRP
        const __venc = p.DATA_VENC_ULTIMO_CRP || p.DATA_VENCIMENTO_ULTIMO_CRP || p.venc_ult_crp || '';
        fillText('venc_ult_crp', __venc);
        fillText('data_vencimento_ultimo_crp', __venc);

        const __tipo = p.TIPO_EMISSAO_ULTIMO_CRP || p.tipo_emissao_ult_crp || '';
        fillText('tipo_emissao_ult_crp',    __tipo);
        fillText('tipo_emissao_ultimo_crp', __tipo);

        fillText('DATA_VENC_ULTIMO_CRP',  p.DATA_VENC_ULTIMO_CRP  || p.DATA_VENCIMENTO_ULTIMO_CRP || p.venc_ult_crp || '');
        fillText('TIPO_EMISSAO_ULTIMO_CRP', p.TIPO_EMISSAO_ULTIMO_CRP || p.tipo_emissao_ult_crp || '');

        // 3.4 — mostra somente a alternativa selecionada
        const __prz = String(p.PRAZO_ADICIONAL_COD || p.prazo_adicional_cod || '').trim();
        (function applyPrazoAdicional(code){
          const itens = Array.from(document.querySelectorAll('[data-3_4]'));
          let mostrou = false;
          itens.forEach(el => {
            const tag = (el.getAttribute('data-3_4') || '').trim();
            const ok  = code && tag === code;
            if (ok) { el.style.display = ''; mostrou = true; }
            else { el.remove(); }
          });
          const holder = document.querySelector('[data-k="PRAZO_ADICIONAL_TEXTO"]');
          if (holder) {
            if (mostrou) holder.classList.add('d-none');
            else {
              const txt = p.PRAZO_ADICIONAL_TEXTO || p.prazo_adicional_texto || 'Não informado';
              holder.textContent = txt;
              holder.classList.toggle('d-none', !txt.trim());
            }
          }
        })(__prz);

        // 3.3
        liList('#criterios-list', p.__CRITERIOS_ARR__);

        // 4) Fase
        let faseSel = String(p.__FASE_SEL__ || p.FASE_PROGRAMA || '').trim();
        // fallback: tentar deduzir a fase pelos campos presentes no payload
        if (!faseSel) {
          const has = pref => Object.keys(p||{}).some(k => k.startsWith(pref));
          if      (has('F41_')) faseSel = '4.1';
          else if (has('F42_')) faseSel = '4.2';
          else if (has('F43_')) faseSel = '4.3';
          else if (has('F44_')) faseSel = '4.4';
          else if (has('F45_')) faseSel = '4.5';
          else if (has('F46_') || has('F462F_')) faseSel = '4.6';
        }
        showOnlyPhase(faseSel);
        fillText('FASE_PROGRAMA', faseSel || '—');

        switch (faseSel) {
          case '4.1': {
            const ul = document.getElementById('f41-itens');
            if (ul) {
              const texto = p.F41_OPCAO_TEXT;
              ul.innerHTML = texto
                ? `<li>${escapeHtml(texto)}</li>`
                : '<li>Não informado</li>';
            }
            break;
          }
          case '4.2': {
            liList('#f42-itens', p.F42_LISTA);
            break;
          }
          case '4.3': {
            liList('#f43-itens', p.F43_LISTA);
            (function(){
              const j = document.getElementById('f43-just');
              if (j) j.textContent = (p.F43_JUST || '') || (__NA_ALL__() ? __NA_LABEL__() : '—');
              const pl = document.getElementById('f43-plano');
              if (pl) pl.textContent = (p.F43_PLANO || '') || (__NA_ALL__() ? __NA_LABEL__() : '—');
              const plb = document.getElementById('f43-plano-b');
              if (plb) plb.textContent = (p.F43_PLANO_B || '') || (__NA_ALL__() ? __NA_LABEL__() : '—');
            })();
            (function(){
              const box = document.getElementById('f4310');
              if(!box) return;
              const items = [];
              if (p.F4310_OPCAO === 'a') {
                items.push('Opção: a) Foram adotadas regras de elegibilidade, de cálculo e de reajustamento dos benefícios do RPPS...');
                if (p.F4310_LEGISLACAO) items.push('Legislação: ' + p.F4310_LEGISLACAO);
              } else if (p.F4310_OPCAO === 'b') {
                items.push('Opção: b) Comprovamos o encaminhamento, pelo ente ao Poder Legislativo, de propostas de alteração...');
                if (p.F4310_DOCS) items.push('Documentos: ' + p.F4310_DOCS);
              }
              liList('#f4310', items);
            })();
            (function(){
              const desc = splitLines(p.F43_DESC_PLANOS || '');
              const dBox = document.getElementById('f43-desc-planos');
              if (dBox) dBox.innerHTML = desc.length
                ? '<ul>' + desc.map(a => '<li>' + escapeHtml(a) + '</li>').join('') + '</ul>'
                : `<span class="muted">${__NA_ALL__() ? escapeHtml(__NA_LABEL__()) : '—'}</span>`;
            })();
            liList('#f43-incluir', p.F43_INCLUIR);
            break;
          }
          case '4.4': {
            liList('#f44-criterios',   p.F44_CRITERIOS);
            liList('#f44-decls',       p.F44_DECLS);
            liList('#f44-finalidades', p.F44_FINALIDADES);
            (function(){
              const el = document.getElementById('f441-legislacao');
              if (el) el.textContent = (p.F441_LEGISLACAO || '') || (__NA_ALL__() ? __NA_LABEL__() : '—');
            })();
            (function(){
              const desc = splitLines(p.F445_DESC_PLANOS || '');
              const dBox = document.getElementById('f445-desc-planos');
              if (dBox) dBox.innerHTML = desc.length
                ? '<ul>' + desc.map(a => '<li>' + escapeHtml(a) + '</li>').join('') + '</ul>'
                : `<span class="muted">${__NA_ALL__() ? escapeHtml(__NA_LABEL__()) : '—'}</span>`;
            })();
            (function(){
              const ax = splitLines(p.F44_ANEXOS || '');
              const box = document.getElementById('f44-anexos');
              if (box) {
                box.innerHTML = ax.length
                  ? '<ul>' + ax.map(a => '<li>' + escapeHtml(a) + '</li>').join('') + '</ul>'
                  : `<span class="muted">${__NA_ALL__() ? escapeHtml(__NA_LABEL__()) : '—'}</span>`;
              }
            })();
            (function(){
              const d = splitLines(p.F446_DOCS || '');
              const e = splitLines(p.F446_EXEC_RES || '');
              const dBox = document.getElementById('f446-docs');
              const eBox = document.getElementById('f446-exec');
              if (dBox) dBox.innerHTML = d.length
                ? '<ul>' + d.map(a => '<li>' + escapeHtml(a) + '</li>').join('') + '</ul>'
                : `<span class="muted">${__NA_ALL__() ? escapeHtml(__NA_LABEL__()) : '—'}</span>`;
              if (eBox) eBox.innerHTML = e.length
                ? '<ul>' + e.map(a => '<li>' + escapeHtml(a) + '</li>').join('') + '</ul>'
                : `<span class="muted">${__NA_ALL__() ? escapeHtml(__NA_LABEL__()) : '—'}</span>`;
            })();
            break;
          }
          case '4.5': {
            liList('#f45-decls', p.F45_DECLS);
            const d = splitLines(p.F45_DOCS || '');
            const j = splitLines(p.F45_JUST || '');
            const e = splitLines(p.F453_EXEC_RES || '');
            const docsBox = document.getElementById('f45-docs');
            const justBox = document.getElementById('f45-just');
            const execBox = document.getElementById('f45-exec');
            if (docsBox) docsBox.innerHTML = d.length
              ? '<ul>' + d.map(a => '<li>' + escapeHtml(a) + '</li>').join('') + '</ul>'
              : `<span class="muted">${__NA_ALL__() ? escapeHtml(__NA_LABEL__()) : '—'}</span>`;
            if (execBox) execBox.innerHTML = e.length
              ? '<ul>' + e.map(a => '<li>' + escapeHtml(a) + '</li>').join('') + '</ul>'
              : `<span class="muted">${__NA_ALL__() ? escapeHtml(__NA_LABEL__()) : '—'}</span>`;
            if (justBox) justBox.innerHTML = j.length
              ? '<ul>' + j.map(a => '<li>' + escapeHtml(a) + '</li>').join('') + '</ul>'
              : `<span class="muted">${__NA_ALL__() ? escapeHtml(__NA_LABEL__()) : '—'}</span>`;
            break;
          }
          case '4.6': {
            (function(){
              let arr = asArr(p.F46_CRITERIOS);
              const decls = asArr(p.F46_DECLS);
              const aMarcado = decls.some(t => /a\)/i.test(String(t)));
              if (!arr.length && aMarcado) {
                arr = ['Demais critérios não abrangidos por Plano(s) de Ação foram declarados regulares (4.6.1, item a).'];
              }
              liList('#f46-criterios', arr);
            })();

            const decls = asArr(p.F46_DECLS);
            if (p.F46_PROGESTAO) decls.push('Nível Pró-Gestão RPPS: ' + p.F46_PROGESTAO);
            if (p.F46_PORTE)     decls.push('Grupo de Porte (ISP-RPPS): ' + p.F46_PORTE);
            if (p.F46_JUST_D)    decls.push('(d) Justificativas: ' + p.F46_JUST_D);
            if (p.F46_DOCS_D)    decls.push('(d) Documentos: ' + p.F46_DOCS_D);
            if (p.F46_JUST_E)    decls.push('(e) Justificativas: ' + p.F46_JUST_E);
            if (p.F46_DOCS_E)    decls.push('(e) Documentos: ' + p.F46_DOCS_E);
            liList('#f46-decls', decls);

            liList('#f46-finalidades', p.F46_FINALIDADES);
            liList('#f462f-criterios', p.F462F_CRITERIOS);

            (function(){
              const ax = splitLines(p.F46_ANEXOS || p.F466_DOCS || '');
              const axBox = document.getElementById('f46-anexos');
              if (axBox) axBox.innerHTML = ax.length
                ? '<ul>' + ax.map(a => '<li>' + escapeHtml(a) + '</li>').join('') + '</ul>'
                : `<span class="muted">${__NA_ALL__() ? escapeHtml(__NA_LABEL__()) : '—'}</span>`;
            })();

            (function(){
              const jp = document.getElementById('f46-just-planos');
              if (jp) jp.textContent = (p.F46_JUST_PLANOS || '') || (__NA_ALL__() ? __NA_LABEL__() : '—');
            })();

            (function(){
              const d = splitLines(p.F466_DOCS || '');
              const e = splitLines(p.F466_EXEC_RES || '');
              const dBox = document.getElementById('f466-docs');
              const eBox = document.getElementById('f466-exec');
              if (dBox) dBox.innerHTML = d.length
                ? '<ul>' + d.map(a => '<li>' + escapeHtml(a) + '</li>').join('') + '</ul>'
                : `<span class="muted">${__NA_ALL__() ? escapeHtml(__NA_LABEL__()) : '—'}</span>`;
              if (eBox) eBox.innerHTML = e.length
                ? '<ul>' + e.map(a => '<li>' + escapeHtml(a) + '</li>').join('') + '</ul>'
                : `<span class="muted">${__NA_ALL__() ? escapeHtml(__NA_LABEL__()) : '—'}</span>`;
            })();

            break;
          }
        }

        // Render genérico de extras da fase ativa
        (function renderFaseExtras(){
          const box = document.getElementById('fase-extra-campos');
          if (!box) return;

          const p = window.__TERMO_DATA__ || {};
          const fase = String(p.__FASE_SEL__ || p.FASE_PROGRAMA || '').trim();
          if (!fase) { box.innerHTML = '<span class="muted">—</span>'; return; }

          const prefList = [
            {p:`fase${fase.replace('.','_')}_`},
            {p:`fase${fase.replace('.','-')}-`},
            {p:`fase${fase}_`},
            {p:`f${fase.replace('.','')}_`}
          ];
          function hasPref(k){ return prefList.some(({p:pre}) => k.startsWith(pre)); }

          const useNA = (typeof __NA_ALL__ === 'function') ? __NA_ALL__() : true;
          const entries = Object.entries(p)
            .filter(([k,v]) => hasPref(k) && v != null && (String(v).trim?.() || (Array.isArray(v) && v.length)))
            .map(([k,v])=>{
              const label = k.replace(/^.*?(?:_|-)/,'').replaceAll('_',' ').replaceAll('-',' ').toUpperCase();
              const val = Array.isArray(v) ? v : String(v).trim();
              const htmlVal = Array.isArray(val) && val.length
                ? ('<ul>' + val.map(x => '<li>' + escapeHtml(String(x)) + '</li>').join('') + '</ul>')
                : (val ? escapeHtml(val) : ( useNA ? escapeHtml(__NA_LABEL__()) : '' ));
              return `<div class="linha"><div class="titulo">${escapeHtml(label)}</div><div class="valor">${htmlVal}</div></div>`;
            });

          box.innerHTML = entries.length ? entries.join('') : (useNA ? `<span class="muted">${escapeHtml(__NA_LABEL__())}</span>` : '');
        })();

        (function freezeAfterRender(){
          const prazos = document.querySelectorAll('[data-3_4]');
          if (prazos.length > 1) {
            for (let i = 1; i < prazos.length; i++) prazos[i].remove();
          }
        })();

        // 5) Justificativas gerais
        fillText('justificativas_gerais', p.JUSTIFICATIVAS_GERAIS || p.justificativas_gerais || '');

        // 6) Data/assinaturas
        const preferida = (p.DATA_TERMO_GERADO || p.DATA || p.DATA_SOLIC_GERADA || '').trim();
        const resolvida = preferida || hojeBR_robusto();
        window.__TERMO_DATA__ = Object.assign({}, window.__TERMO_DATA__ || {}, { data_termo: resolvida });
        fillText('data_termo', resolvida);
        try { document.dispatchEvent(new Event('TERMO_DATA')); } catch {}

        // 7) Esfera e legenda assinatura
        const esferaTxt = normalizarEsfera(p.ESFERA || p.ESFERA_GOVERNO || p.ESFERA_SUGERIDA || p.fase_esfera);
        const esferaNode = document.querySelector('[data-esfera]');
        if (esferaNode) esferaNode.textContent = esferaTxt;
        const esferaTitulo = document.querySelector('h3 .label');
        if (esferaTitulo) esferaTitulo.textContent = '1.1 Esfera de Governo';
        (function(){
          const sig = document.getElementById('sig-cap-ente');
          if (sig) {
            const isEstDistr = /Estadual\/Distrital/i.test(esferaTxt);
            sig.innerHTML = isEstDistr
              ? 'Representante legal do Estado/Distrito de <span data-k="ente"></span>/<span data-k="uf"></span>'
              : 'Representante legal do Município de <span data-k="ente"></span>/<span data-k="uf"></span>';
            fillText('ente', p.ENTE); fillText('uf', p.UF);
          }
        })();

        // Garante listas críticas antes do print + FLAG DE PRONTO
        (function ensureListsThenPrint(){
          const fase = String((window.__TERMO_DATA__ && (window.__TERMO_DATA__.__FASE_SEL__ || window.__TERMO_DATA__.FASE_PROGRAMA)) || '').trim();
          const mustByPhase = {
            '4.1': ['#f41-itens'],
            '4.2': ['#f42-itens'],
            '4.3': ['#f43-itens', '#f4310', '#f43-incluir'],
            '4.4': ['#f44-criterios', '#f44-decls', '#f44-finalidades'],
            '4.5': ['#f45-decls'],
            '4.6': ['#f46-decls','#f46-criterios','#f46-finalidades']
          };
          const mustHaveLis = mustByPhase[fase] || [];
          const ok = mustHaveLis.every(sel => {
            const el = document.querySelector(sel);
            return el && (el.querySelector('li') || el.textContent.trim().length > 0);
          });
          if (!ok) {
            document.body.offsetHeight;
            setTimeout(() => ensureListsThenPrint(), 50);
            return;
          }
          if (!window.__TERMO_READY_FIRED__) {
            window.__TERMO_READY_FIRED__ = true;
            const fontsReady = (document.fonts && document.fonts.ready) ? document.fonts.ready : Promise.resolve();
            const maxWait = new Promise(r => setTimeout(r, 1500));
            Promise.race([fontsReady, maxWait]).finally(() => {
              requestAnimationFrame(() => {
                // >>> FLAG para o gerador de PDF:
                document.documentElement.setAttribute('data-termo-ready','1');
                window.__TERMO_PRINT_READY__ = true;
                try { document.dispatchEvent(new CustomEvent('TERMO_PRINT_READY')); } catch {}
              });
            });
          }
        })();
      }
      // Modal PDF (abrir/fechar)
      window.ModalPDF = {
        open(){ document.getElementById('pdf-modal')?.classList.add('pdf-modal--open'); },
        close(){ document.getElementById('pdf-modal')?.classList.remove('pdf-modal--open'); }
      };

      // EXPOSIÇÃO: compat com postMessage
      window.__TERMO_RUN__ = run;
      window.run = run;

      // Injeção por querystring
      (function injectFromQueryIfPresent(){
        try{
          const qs = new URLSearchParams(window.location.search || '');
          if ([...qs.keys()].length) {
            const obj = {}; qs.forEach((v,k)=>{ obj[k]=v; });
            window.__TERMO_DATA__ = Object.assign({}, window.__TERMO_DATA__ || {}, obj);
            try { run(window.__TERMO_DATA__); } catch(_){ }
          }
        }catch(_){ }
      })();

      if (window.__TERMO_DATA__) { try { run(window.__TERMO_DATA__); } catch {} }
      document.addEventListener('TERMO_DATA_READY', () => { try { run(window.__TERMO_DATA__ || {}); } catch {} });
      document.addEventListener('TERMO_DATA',       () => { try { run(window.__TERMO_DATA__ || {}); } catch {} });
      window.addEventListener('message', (ev) => {
        const d = ev && ev.data;
        if (!d) return;
        if (d.type === 'TERMO_DATA' || d.type === 'TERMO_DATA_READY' || d.type === 'TERMO_PREVIEW_DATA') {
          try { run(d.payload || {}); } catch (_) {}
        }
      });

      (function spinWait(maxMs=4000, step=120){
        const t0 = Date.now();
        const iv = setInterval(() => {
          if (window.__TERMO_DATA__) {
            try { run(window.__TERMO_DATA__); } catch {}
            clearInterval(iv);
          } else if (Date.now() - t0 > maxMs) {
            clearInterval(iv);
          }
        }, step);
      })();

      document.addEventListener('DOMContentLoaded', () => {
        // Fallback caso não haja injeção externa
        if (!window.__TERMO_DATA__) {
          if (window.__DEBUG_SOLIC_CRP__) console.warn('termo_solic_crp: NO __TERMO_DATA__, using fallback');
          setTimeout(() => {
            if (!window.__TERMO_DATA__) {
              run({ __NA_ALL: true, __NA_LABEL: 'Não preenchido' });
            }
          }, 600);
        }
      });
    })();
  </script>
</body>
</html>