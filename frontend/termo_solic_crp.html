<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Termo de Solicitação de CRP Emergencial</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Montserrat:wght@600;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="./termo_solic_crp.css">
</head>
<body>
  <header class="prp-header" aria-hidden="true">
    <div class="logos-wrap">
      <img src="./imagens/logo-secretaria-complementar.svg" alt="Secretaria" loading="eager" />
      <img src="./imagens/logo-termo-drpps.svg" alt="Departamento de RPPS" loading="eager" />
    </div>
  </header>

  <div class="termo-container">

    <section class="prp-cover avoid-break">
      <div class="logos-wrap-cover">
        <img src="./imagens/logo-secretaria-complementar-cor.svg" alt="Secretaria" loading="eager" />
        <img src="./imagens/logo-termo-drpps-cor.svg" alt="Departamento de RPPS" loading="eager" />
      </div>

      <h1 class="prp-titulo">TERMO DE SOLICITAÇÃO DE<br> CERTIFICADO DE REGULARIDADE PREVIDENCIÁRIA<br> (CRP) EMERGENCIAL</h1>
      
      <div class="prp-box-info">
        <p class="prp-box-data">
          <span class="label">Nº Gescon/Consulta:</span>
          <strong class="value" data-k="GESCON_CONSULTA"></strong>
        </p>
        <p class="prp-box-data">
          <span class="label">Data de encaminhamento:</span>
          <strong class="value" data-k="DATA_ENCAMINHAMENTO"></strong>
        </p>
        <p class="prp-box-data">
          <span class="label">Processo SEI:</span>
          <strong class="value" data-k="PROCESSO_SEI"></strong>
        </p>
      </div>

      <div class="prp-ass-box">
        <p class="prp-ass-label">________________________________________</p>
        <p class="prp-ass-info"><span data-k="ENTE_FEDERATIVO"></span></p>
      </div>
      
      <p class="prp-instrucao">Documento gerado eletronicamente e encaminhado via Gescon/Portal</p>
    </section>

    <div class="prp-termo page-break-before">

      <section class="avoid-break" id="secao-1">
        <h2>1. Identificação do Ente Federativo</h2>
        <div class="field-group">
          <p><strong class="label">Ente Federativo:</strong> <span class="value" data-k="ENTE_FEDERATIVO"></span></p>
          <p><strong class="label">CNPJ:</strong> <span class="value" data-k="CNPJ_ENTE"></span></p>
          <p><strong class="label">Telefone:</strong> <span class="value" data-k="TELEFONE_ENTE"></span></p>
          <p><strong class="label">E-mail:</strong> <span class="value" data-k="EMAIL_ENTE"></span></p>
        </div>
      </section>

      <section class="avoid-break" id="secao-2">
        <h2>2. Identificação do RPPS</h2>
        <div class="field-group">
          <p><strong class="label">Nome do RPPS:</strong> <span class="value" data-k="NOME_RPPS"></span></p>
          <p><strong class="label">CNPJ do RPPS:</strong> <span class="value" data-k="CNPJ_RPPS"></span></p>
          <p><strong class="label">Entidade Gestora:</strong> <span class="value" data-k="ENTIDADE_GESTORA"></span></p>
          <p><strong class="label">Unidade Gestora Única:</strong> <span class="value" data-k="UNIDADE_GESTORA_UNICA"></span></p>
          <p><strong class="label">E-mail para contato:</strong> <span class="value" data-k="EMAIL_RPPS"></span></p>
        </div>
      </section>

      <section class="avoid-break" id="secao-3">
        <h2>3. Identificação do Representante Legal (Chefe do Poder Executivo)</h2>
        <div class="field-group">
          <p><strong class="label">Nome:</strong> <span class="value" data-k="NOME_REPRESENTANTE"></span></p>
          <p><strong class="label">CPF:</strong> <span class="value" data-k="CPF_REPRESENTANTE"></span></p>
          <p><strong class="label">Cargo/Função:</strong> <span class="value" data-k="CARGO_REPRESENTANTE"></span></p>
          <p><strong class="label">Telefone:</strong> <span class="value" data-k="TELEFONE_REPRESENTANTE"></span></p>
          <p><strong class="label">E-mail:</strong> <span class="value" data-k="EMAIL_REPRESENTANTE"></span></p>
        </div>
      </section>

      <div class="avoid-break page-break-before" id="secao-4">
          <h2>4. Identificação da Fase do Programa de Regularidade Previdenciária</h2>
          
          <div class="fase-container">

            <div class="avoid-break" id="fase-41" hidden>
              <h3>4.1 Fase Inicial/Diagnóstica – 1º CRP Emergencial</h3>
              <ul id="f41-itens"></ul>
            </div>

            <div class="avoid-break" id="fase-42" hidden>
              <h3>4.2 Fase Intermediária/Preparatória – 2º CRP Emergencial</h3>
              <p class="small mt"><strong>4.2.1 Regularidade quanto à manutenção dos critérios (selecione os itens):</strong></p>
              <ul id="f42-itens"></ul>
            </div>
            
            <div class="avoid-break" id="fase-43" hidden>
              <h3>4.3 Fase Intermediária/Preparatória – 3º CRP Emergencial</h3>
              
              <p class="small mt"><strong>4.3.1 Manutenção de regularidade nos critérios relativos a repasses, aportes e parcelamento:</strong></p>
              <ul id="f43-itens"></ul>
              
              <p class="small mt"><strong>4.3.2 Regularidade quanto à utilização de recursos previdenciários:</strong></p>
              <ul id="f432-itens"></ul>
              
              <p class="small mt"><strong>4.3.10 – Em relação à adequação das regras de benefícios do RPPS à Emenda Constitucional nº 103/2019:</strong></p>
              <div class="field-group">
                <p><strong class="label">a) Foram adotadas regras de elegibilidade, de cálculo e de reajustamento dos benefícios do RPPS (reforma das regras de benefícios)...</strong></p>
                <p class="mt mb-0"><strong class="label">Relacionar a legislação que adequou as regras de benefícios do RPPS à Emenda Constitucional nº 103/2019:</strong> <span class="value" data-k="F4310_LEGISLACAO"></span></p>
                <p><strong class="label">Opção (A ou B) - Legislação citada:</strong> <span class="value" data-k="F4310_OPCAO"></span></p>
                <p><strong class="label">Documentos citados (para Opção A/B):</strong> <span class="value" data-k="F4310_DOCS"></span></p>
                <p class="mt"><strong>Justificativas/Informações adicionais (texto livre - F43_JUST):</strong> <span class="value" id="f43-just-texto"></span></p>
              </div>
              <ul id="f4310" hidden></ul>

              <p class="small mt"><strong>4.3.11 - Solicitação de inclusão de critérios nos Planos de Ação da Fase Específica</strong></p>
              <p><strong class="label">a) Critérios do extrato que o ente deseja incluir no Plano de Ação da Fase Específica:</strong></p>
              <ul id="f43-plano"></ul> <div id="f43-plano-b-text" class="mb-2"></div> <p class="small mt"><strong>b) Justificativas/Informações apresentadas relativas a essa inclusão (anexos podem ser citados abaixo):</strong></p>
              <div id="f43-desc-planos-area"></div> <p class="small mt"><strong>4.3.12 Solicitação de inclusão de critérios nos Planos de Ação da Fase Específica</strong></p>
              
              <p><strong class="label">a) Critérios do extrato que o ente, comprovadamente, precisará incluir em Plano de Ação:</strong></p>
              <ul id="f43-incluir"></ul> <p class="small mt"><strong>b) Justificativas/informações apresentadas relativas à solicitação de inclusão (anexos podem ser citados abaixo):</strong></p>
              <div id="f4312-just-area"></div> <p class="small mt"><strong>c) Descrever sucintamente o(s) Plano(s) de Ação apresentado(s):</strong></p>
              <div id="f4312-desc-planos-area"></div> </div>

            <div class="avoid-break" id="fase-44" hidden>
              <h3>4.4 Fase Específica/Focalizada – 4º CRP Emergencial</h3>
              
              <p class="small mt"><strong>4.4.1 Declaro ter cumprido as seguintes condições:</strong></p>
              <ul id="f44-decls"></ul>
              
              <p class="mt mb-0"><strong class="label">d) Adoção de regras de benefícios do RPPS conforme EC 103/2019, art. 40 da CF/88 e art. 164 da Portaria MTP nº 1.467/2022.</strong></p>
              <p class="mt mb-0"><strong class="label">Relacionar a legislação que adequou as regras de benefícios do RPPS à EC 103/2019:</strong> <span class="value" id="f441-legislacao"></span></p>

              <p class="small mt"><strong>4.4.2 Finalidade do(s) Plano(s) de Ação apresentado(s):</strong></p>
              <ul id="f44-finalidades"></ul>

              <p class="small mt"><strong>4.4.3 Critério(s) do extrato previdenciário objeto do(s) Plano(s) de Ação:</strong></p>
              <ul id="f44-criterios"></ul>

              <p class="small mt"><strong>4.4.4 Anexos (obrigatório o encaminhamento de Planos de Ação e documentação comprobatória):</strong></p>
              <div id="f44-anexos"></div>

              <p class="small mt"><strong>4.4.5 Descrever sucintamente o(s) Plano(s) de Ação apresentado(s):</strong></p>
              <div id="f445-desc-planos-area"></div>

              <p class="small mt"><strong>4.4.6 Em caso de Plano(s) de Ação apresentado(s) na Fase Intermediária:</strong></p>
              
              <p><strong class="label">a) Comprovação do cumprimento do(s) Plano(s) de Ação (relacione os documentos, um por linha):</strong></p>
              <div id="f446-docs"></div>

              <p><strong class="label">b) Descrever sucintamente a execução do(s) Plano(s) de Ação e os resultados alcançados:</strong></p>
              <div id="f446-exec-area"></div>
            </div>

            <div class="avoid-break" id="fase-45" hidden>
              <h3>4.5 Fase Específica/Focalizada – 5º CRP Emergencial</h3>
              <ul id="f45-itens"></ul>
              
              <p class="small mt"><strong>4.5.1 Mantida a regularidade dos critérios exigidos nas fases anteriores:</strong></p>
              <p id="f45-regularidade"></p>
              
              <p class="small mt"><strong>4.5.2 Comprovação do cumprimento do(s) Plano(s) de Ação:</strong></p>
              <div id="f45-docs-area"></div>

              <p class="small mt"><strong>4.5.4 Justificativas:</strong></p>
              <div id="f45-just-area"></div>

              <p class="small mt"><strong>4.5.3 Descrever sucintamente a execução do(s) Plano(s) de Ação e os resultados alcançados:</strong></p>
              <div id="f45-exec-area"></div>
            </div>

            <div class="avoid-break" id="fase-46" hidden>
              <h3>4.6 Fase de Manutenção da Conformidade</h3>

              <p class="small mt"><strong>4.6.1 Declaro ter cumprido as seguintes condições:</strong></p>
              <div class="field-group">
                <p><strong class="label">a) Demais critérios que não são objeto do Plano(s) de Ação estão regulares:</strong></p>
                <ul id="f46-criterios"></ul>

                <p class="small mt"><strong>b) Nível de certificação no Pró-Gestão RPPS:</strong> <span class="value" data-k="F46_PROGESTAO"></span></p>
                <p class="small mt"><strong>c) Grupo de Porte (ISP-RPPS):</strong> <span class="value" data-k="F46_PORTE"></span></p>

                <p class="small mt"><strong>d) Houve melhora na situação financeira e atuarial do RPPS com base, entre outros, nos indicadores do ISP-RPPS — anexar comprovações.</strong></p>
                <p><strong class="label">Justificativas (item d):</strong></p>
                <div id="f46-just-d-area"></div>
                <p><strong class="label">Documentos (item d):</strong></p>
                <div id="f46-docs-d-area"></div>
                
                <p class="small mt"><strong>e) Medidas de acompanhamento atuarial (arts. 67 a 69 da Portaria MTP nº 1.467/2022).</strong></p>
                <p><strong class="label">Justificativas (item e):</strong></p>
                <div id="f46-just-e-area"></div>
                <p><strong class="label">Documentos (item e):</strong></p>
                <div id="f46-docs-e-area"></div>
              </div>

              <p class="small mt"><strong>4.6.2 Finalidade do(s) Plano(s) de Ação apresentado(s):</strong></p>
              <ul id="f46-finalidades"></ul>

              <p class="small mt"><strong>f) Organização do RPPS conforme critérios estruturantes das normas gerais / outro critério de maior complexidade (especificar).</strong></p>
              <ul id="f462f-criterios"></ul>

              <p class="small mt"><strong>4.6.4 Anexos (obrigatório o encaminhamento de Planos de Ação e documentação comprobatória):</strong></p>
              <div id="f46-anexos-area"></div>

              <p class="small mt"><strong>4.6.5 Justificativas quanto ao(s) Plano(s) de Ação:</strong></p>
              <div id="f46-just-planos-area"></div>

              <p class="small mt"><strong>4.6.6 Em caso de Plano(s) de Ação em execução ou concluído(s):</strong></p>

              <p><strong class="label">a) Comprovação do cumprimento do(s) Plano(s) de Ação (relacione os documentos, um por linha):</strong></p>
              <div id="f466-docs-area"></div>

              <p><strong class="label">b) Descrever sucintamente a execução do(s) Plano(s) de Ação e os resultados alcançados:</strong></p>
              <div id="f466-exec-area"></div>
            </div>
            
          </div>
        </div>

      <section class="avoid-break page-break-before" id="secao-5">
        <h2>5. Declarações Finais</h2>
        <ul id="f5-decls">
          <li>Declaro, sob as penas da lei, que as informações e documentos que acompanham o pedido de CRP Emergencial são verdadeiros, completos e fidedignos.</li>
          <li>Declaro ter ciência das penalidades administrativas, civis e criminais aplicáveis à falsidade de informações.</li>
          <li>Comprometo-me a comunicar imediatamente à Secretaria de Regime Próprio e Complementar (SRPC) do Ministério da Previdência Social (MPS) qualquer alteração nas informações prestadas.</li>
        </ul>
      </section>

      <section class="avoid-break" id="secao-6">
        <h2>6. Dados do Ente Federativo / Responsável pelo Termo</h2>
        <div class="field-group">
          <p><strong class="label">Local e data:</strong> <span class="value" data-k="LOCAL_ASSINATURA"></span>, <span class="value" data-k="DATA_ASSINATURA"></span></p>
        </div>
      </section>

      <section class="avoid-break" id="secao-7">
        <h2>7. Assinatura do Representante Legal</h2>
        <div class="signature-block">
          <p class="assinatura-line"></p>
          <p class="assinatura-nome"><strong data-k="NOME_REPRESENTANTE"></strong></p>
          <p class="assinatura-cargo"><span data-k="CARGO_REPRESENTANTE"></span></p>
        </div>
      </section>

      <footer class="prp-footer" aria-hidden="true">
        <p>Documento gerado eletronicamente e encaminhado via Gescon/Portal</p>
      </footer>
    </div>
  </div>

  <script>
    // Variáveis globais de configuração
    window.__NA_LABEL__ = window.__NA_LABEL__ || (() => 'Não informado');
    window.__NA_ALL__  = window.__NA_ALL__  || (() => true);

    // Helpers (manter aqui ou linkar em arquivo .js)
    function splitLines(s) {
      if (s === null || s === undefined) return [];
      const lines = String(s).split(/\r?\n/).map(x => x.trim()).filter(Boolean);
      return lines;
    }

    function escapeHtml(s) {
      if (typeof s !== 'string') return s;
      return s.replace(/&/g, '&amp;')
              .replace(/</g, '&lt;')
              .replace(/>/g, '&gt;')
              .replace(/"/g, '&quot;')
              .replace(/'/g, '&#039;');
    }
    
    function toDateBR(s) {
      if (!s) return s;
      try {
        const date = new Date(s);
        if (isNaN(date.getTime())) return s; // Retorna original se inválido
        return date.toLocaleDateString('pt-BR', { timeZone: 'UTC' });
      } catch (e) {
        return s;
      }
    }
    
    function asArr(v) {
      if (Array.isArray(v)) return v.filter(x => x != null && String(x).trim() !== '').map(String);
      if (v == null) return [];
      const s = String(v).trim();
      if (!s) return [];
      // separa por ; , ou quebra de linha (mantido para compatibilidade, mas o front deve enviar array)
      return s.split(/[;,]\s*|\r?\n/).map(x => x.trim()).filter(Boolean);
    }
    
    function asYes(v){ return ['sim','s','true','1','yes','y'].includes(String(v ?? '').trim().toLowerCase()); }

    function fillText(k, v) {
      document.querySelectorAll(`[data-k="${k}"]`).forEach(el => {
        const value = (v || '').trim();
        const useNA = (typeof __NA_ALL__ === 'function') ? __NA_ALL__() : true;
        el.textContent = value || (useNA ? __NA_LABEL__() : '—');
      });
    }

    function liList(sel, arr) {
      const ul = document.querySelector(sel);
      if (!ul) return;
      const a = asArr(arr);
      const useNA = (typeof __NA_ALL__ === 'function') ? __NA_ALL__() : true;

      if (a.length) {
        ul.innerHTML = a.map(x => `<li>${escapeHtml(x)}</li>`).join('');
      } else {
        // Se a lista estiver vazia, exibe "Não informado" em um item, mantendo o <ul> visível se necessário
        ul.innerHTML = useNA ? `<li class="muted">${escapeHtml(__NA_LABEL__())}</li>` : '';
      }
    }
    
    // === NOVAS Funções auxiliares (patch C.1) ===
    function renderParagraphs(sel, s){
        const el = document.querySelector(sel);
        if (!el) return;
        const lines = splitLines(s);
        const useNA = (typeof __NA_ALL__ === 'function') ? __NA_ALL__() : true;
        
        if (lines.length) {
          // Renderiza cada linha como um parágrafo HTML
          el.innerHTML = lines.map(x=>`<p>${escapeHtml(x)}</p>`).join('');
        } else {
          el.innerHTML = useNA ? `<span class="muted">${escapeHtml(__NA_LABEL__())}</span>` : '—';
        }
      }

      // Função para renderizar documentos/listas em div/ul/li (similar ao liList, mas em div)
      function renderListDiv(sel, arr){
        const box = document.querySelector(sel);
        if (!box) return;
        const a = asArr(arr);
        const useNA = (typeof __NA_ALL__ === 'function') ? __NA_ALL__() : true;

        if (a.length) {
          box.innerHTML = '<ul>' + a.map(x=>'<li>' + escapeHtml(x) + '</li>').join('') + '</ul>';
        } else {
          box.innerHTML = useNA ? `<span class="muted">${escapeHtml(__NA_LABEL__())}</span>` : '—';
        }
      }


    // Função principal de preenchimento
    function run(p) {
      // 1. Identificação do Ente Federativo
      fillText('ENTE_FEDERATIVO', p.ENTE_FEDERATIVO);
      fillText('CNPJ_ENTE', p.CNPJ_ENTE);
      fillText('TELEFONE_ENTE', p.TELEFONE_ENTE);
      fillText('EMAIL_ENTE', p.EMAIL_ENTE);

      // 2. Identificação do RPPS
      fillText('NOME_RPPS', p.NOME_RPPS);
      fillText('CNPJ_RPPS', p.CNPJ_RPPS);
      fillText('ENTIDADE_GESTORA', p.ENTIDADE_GESTORA);
      fillText('UNIDADE_GESTORA_UNICA', p.UNIDADE_GESTORA_UNICA);
      fillText('EMAIL_RPPS', p.EMAIL_RPPS);

      // 3. Identificação do Representante Legal
      fillText('NOME_REPRESENTANTE', p.NOME_REPRESENTANTE);
      fillText('CPF_REPRESENTANTE', p.CPF_REPRESENTANTE);
      fillText('CARGO_REPRESENTANTE', p.CARGO_REPRESENTANTE);
      fillText('TELEFONE_REPRESENTANTE', p.TELEFONE_REPRESENTANTE);
      fillText('EMAIL_REPRESENTANTE', p.EMAIL_REPRESENTANTE);

      // Metadados
      const dataEnvio = toDateBR(p.DATA_ENCAMINHAMENTO);
      fillText('GESCON_CONSULTA', p.GESCON_CONSULTA);
      fillText('DATA_ENCAMINHAMENTO', dataEnvio);
      fillText('PROCESSO_SEI', p.PROCESSO_SEI);
      
      // 6. Local e Data
      fillText('LOCAL_ASSINATURA', p.LOCAL_ASSINATURA);
      fillText('DATA_ASSINATURA', dataEnvio);


      // 4. Identificação da Fase do Programa de Regularidade Previdenciária (Patch G.1)
      const faseSel = String(p.FASE_PROGRAMA || '').trim();
      
      // Esconde TODOS os blocos de fase (4.1 a 4.6), garantindo que apenas um será exibido
      ['41', '42', '43', '44', '45', '46'].forEach(id => {
        const el = document.getElementById(`fase-${id}`);
        if (el) el.setAttribute('hidden', 'hidden');
      });
      
      // Mostra APENAS o bloco da fase selecionada
      if (faseSel) {
        const faseId = faseSel.replace('.', '');
        const faseHtml = document.getElementById(`fase-${faseId}`);
        if (faseHtml) {
          faseHtml.removeAttribute('hidden');
        }
      }

      // Preenchimento de dados da Fase 4
      switch (faseSel) {
        case '4.1': {
          liList('#f41-itens', p.F41_LISTA);
          break;
        }
        case '4.2': {
          liList('#f42-itens', p.F42_LISTA);
          break;
        }
        case '4.3': { // Patch G.2 (Atualizado)
          liList('#f43-itens', p.F43_LISTA); // 4.3.1
          liList('#f432-itens', p.F432_LISTA); // 4.3.2
          
          // 4.3.10 detalhado
          fillText('F4310_OPCAO', p.F4310_OPCAO);
          fillText('F4310_LEGISLACAO', p.F4310_LEGISLACAO);
          fillText('F4310_DOCS', p.F4310_DOCS);

          // F43_JUST (texto livre original - 4.3.10 Justificativas/Informações adicionais)
          const f43JustEl = document.getElementById('f43-just-texto');
          if (f43JustEl) f43JustEl.textContent = (p.F43_JUST || '') || (__NA_ALL__() ? __NA_LABEL__() : '—');
          
          // 4.3.11 (a) - Critérios do extrato a incluir. F43_PLANO e F43_PLANO_B são os dados.
          liList('#f43-plano', p.F43_PLANO); // Itens de checklist
          renderParagraphs('#f43-plano-b-text', p.F43_PLANO_B); // Texto livre
          
          // 4.3.11 (b) - Justificativas/Informações - F43_DESC_PLANOS (texto longo)
          renderParagraphs('#f43-desc-planos-area', p.F43_DESC_PLANOS);

          // 4.3.12 (a) Critérios
          liList('#f43-incluir', p.F43_INCLUIR);
          
          // 4.3.12 (b) Justificativas detalhadas - F4312_JUST (texto longo)
          renderParagraphs('#f4312-just-area', p.F4312_JUST);

          // 4.3.12 (c) Descrição Planos detalhada - F4312_DESC_PLANOS (texto longo)
          renderParagraphs('#f4312-desc-planos-area', p.F4312_DESC_PLANOS);
          break;
        }
        case '4.4': { // Atualizado
          liList('#f44-decls', p.F44_DECLS);
          liList('#f44-finalidades', p.F44_FINALIDADES);
          liList('#f44-criterios', p.F44_CRITERIOS);

          // 4.4.1(d) Legislação
          const f441Leg = document.getElementById('f441-legislacao');
          if (f441Leg) f441Leg.textContent = (p.F441_LEGISLACAO || '') || (__NA_ALL__() ? __NA_LABEL__() : '—');

          // 4.4.4 Anexos (documentos, renderiza como lista)
          renderListDiv('#f44-anexos', p.F44_ANEXOS);

          // 4.4.5 Descrever sucintamente (texto longo)
          renderParagraphs('#f445-desc-planos-area', p.F445_DESC_PLANOS);

          // 4.4.6 (a) Documentos (documentos, renderiza como lista)
          renderListDiv('#f446-docs', p.F446_DOCS);

          // 4.4.6 (b) Execução e resultados (texto longo)
          renderParagraphs('#f446-exec-area', p.F446_EXEC_RES);
          break;
        }
        case '4.5': { // Atualizado
          const f45RegEl = document.getElementById('f45-regularidade');
          if (f45RegEl) f45RegEl.textContent = asYes(p.F45_REGULARIDADE) ? 'Sim' : 'Não';
          
          renderListDiv('#f45-docs-area', p.F45_DOCS);
          renderParagraphs('#f45-just-area', p.F45_JUST);
          renderParagraphs('#f45-exec-area', p.F45_EXEC_RES);
          break;
        }
        case '4.6': { // Atualizado
          // 4.6.1 (a), (b) e (c)
          liList('#f46-criterios', p.F46_CRITERIOS);
          fillText('F46_PROGESTAO', p.F46_PROGESTAO);
          fillText('F46_PORTE', p.F46_PORTE);
          
          // 4.6.1 (d) e (e) (textos longos e listas)
          renderParagraphs('#f46-just-d-area', p.F46_JUST_D);
          renderListDiv('#f46-docs-d-area', p.F46_DOCS_D); // Documentos: lista
          renderParagraphs('#f46-just-e-area', p.F46_JUST_E);
          renderListDiv('#f46-docs-e-area', p.F46_DOCS_E); // Documentos: lista

          // 4.6.2 e 4.6.3 (listas)
          liList('#f46-finalidades', p.F46_FINALIDADES);
          liList('#f462f-criterios', p.F462F_CRITERIOS);

          // 4.6.4 Anexos (documentos, renderiza como lista)
          renderListDiv('#f46-anexos-area', p.F46_ANEXOS);

          // 4.6.5 Justificativas (texto longo)
          renderParagraphs('#f46-just-planos-area', p.F46_JUST_PLANOS);

          // 4.6.6 (a) Documentos (documentos, renderiza como lista)
          renderListDiv('#f466-docs-area', p.F466_DOCS);

          // 4.6.6 (b) Execução e resultados (texto longo)
          renderParagraphs('#f466-exec-area', p.F466_EXEC_RES);
          break;
        }
      }

      // ---

      // ... (Outras lógicas de preenchimento, se houver)
    }

    // Lógica para rodar a função run com os dados injetados
    // ... (Mantida a lógica de espera/mensagem original)
    if (window.__TERMO_DATA__) { try { run(window.__TERMO_DATA__); } catch {} }
    document.addEventListener('TERMO_DATA_READY', () => { try { run(window.__TERMO_DATA__ || {}); } catch {} });
    document.addEventListener('TERMO_DATA',       () => { try { run(window.__TERMO_DATA__ || {}); } catch {} });
    window.addEventListener('message', (ev) => {
      const d = ev && ev.data;
      if (!d) return;
      if (d.type === 'TERMO_DATA' || d.type === 'TERMO_DATA_READY' || d.type === 'TERMO_PREVIEW_DATA') {
        try { run(d.payload || {}); } catch (_) {}
      }
    });

    (function spinWait(maxMs=4000, step=120){
      const t0 = Date.now();
      const iv = setInterval(() => {
        if (window.__TERMO_DATA__) {
          try { run(window.__TERMO_DATA__); } catch {}
          clearInterval(iv);
        } else if (Date.now() - t0 > maxMs) {
          clearInterval(iv);
        }
      }, step);
    })();

    document.addEventListener('DOMContentLoaded', () => {
      // Fallback caso não haja injeção externa
      if (!window.__TERMO_DATA__) {
        if (window.__DEBUG_SOLIC_CRP__) console.warn('termo_solic_crp.html: Sem dados injetados. Tentando URL/session storage.');
        try {
          // 1. Tentar URL (fallback do PDF)
          const matchB64 = (location.hash.match(/payload_b64=([^&]+)/) || [])[1];
          if (matchB64) {
            const data = JSON.parse(decodeURIComponent(escape(atob(matchB64))));
            window.__TERMO_DATA__ = data;
            return run(data);
          }
          // 2. Tentar sessionStorage (fallback do preview)
          const sessionData = sessionStorage.getItem('TERMO_SOLIC_CRP_PAYLOAD');
          if (sessionData) {
            const data = JSON.parse(sessionData);
            window.__TERMO_DATA__ = data;
            return run(data);
          }
        } catch(e) {
          if (window.__DEBUG_SOLIC_CRP__) console.error('Erro ao tentar recuperar payload:', e);
        }
      }
    });
  </script>
</body>
</html>