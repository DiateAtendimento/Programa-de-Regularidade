<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Termo de Solicita√ß√£o de CRP Emergencial</title>

  <!-- Fonte apenas para PREVIEW em tela (o PDF usa Rawline do CSS local) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Montserrat:wght@600;700&display=swap" rel="stylesheet">

  <!-- Estilos oficiais do termo (usa Rawline no PDF) -->
  <link rel="stylesheet" href="./termo_solic_crp.css">
</head>
<body>
  <!-- Cabe√ßalho FIXO (anti-sobreposi√ß√£o em 2+ p√°ginas) -->
  <header class="prp-header" aria-hidden="true">
    <div class="logos-wrap">
      <img src="./imagens/logo-secretaria-complementar.svg" alt="Secretaria" loading="eager" />
      <img src="./imagens/logo-termo-drpps.svg" alt="Departamento de RPPS" loading="eager" />
    </div>
  </header>

  <div id="pdf-root">
    <main class="term-wrap prp-content">
      <h1 class="term-title">
        <br>TERMO DE SOLICITA√á√ÉO DE CRP EMERGENCIAL<br>
        PROGRAMA DE REGULARIDADE PREVIDENCI√ÅRIA<br>
      </h1>

      <p class="term-meta">
        Ente: <strong data-k="ente"></strong> / UF: <strong data-k="uf"></strong> ‚Ä¢ UG: <strong data-k="ug"></strong>
      </p>

      <!-- 1. IDENTIFICA√á√ÉO -->
      <section class="term-section avoid-break" id="sec-1">
        <h2><br>1. IDENTIFICA√á√ÉO DO ENTE FEDERATIVO E DA UNIDADE GESTORA</h2>

        <h3><span class="label">1.1 Esfera de Governo</span></h3>
        <div class="linha">
          <div class="titulo"></div>
          <div class="valor" data-esfera></div>
        </div>

        <h3><strong>1.2 Ente Federativo</strong></h3>
        <div class="grid grid-num">
          <div class="field"><span class="label"><strong>1.2.1 Ente</strong></span><span class="value" data-k="ente"></span></div>
          <div class="field"><span class="label"><strong>1.2.2 CNPJ</strong></span><span class="value" data-k="cnpj_ente"></span></div>
          <div class="field"><span class="label"><strong>1.2.3 E-mail oficial</strong></span><span class="value" data-k="email_ente"></span></div>
        </div>

        <h3 id="sec-1-3"><strong>1.3 Regime Pr√≥prio de Previd√™ncia Social (RPPS)</strong></h3>
        <div class="grid grid-num">
          <div class="field"><span class="label"><strong>1.3.1 Unidade Gestora</strong></span><span class="value" data-k="ug"></span></div>
          <div class="field"><span class="label"><strong>1.3.2 CNPJ</strong></span><span class="value" data-k="cnpj_ug"></span></div>
          <div class="field"><span class="label"><strong>1.3.3 E-mail oficial</strong></span><span class="value" data-k="email_ug"></span></div>
          <div class="field"><span class="label"><strong>1.3.4 √ìrg√£o de vincula√ß√£o da UG</strong></span><span class="value" data-k="ORGAO_VINCULACAO_UG"></span></div>
        </div>
      </section>

      <!-- 2. IDENTIFICA√á√ÉO DOS RESPONS√ÅVEIS -->
      <section class="term-section avoid-break">
        <h2>2. IDENTIFICA√á√ÉO DOS RESPONS√ÅVEIS</h2>

        <h3><strong>2.1 Representante legal do ente federativo</strong></h3>
        <div class="grid grid-num">
          <div class="field"><span class="label"><strong>2.1.1 Nome</strong></span><span class="value" data-k="nome_rep_ente"></span></div>
          <div class="field"><span class="label"><strong>2.1.2 Cargo/Fun√ß√£o</strong></span><span class="value" data-k="cargo_rep_ente"></span></div>
          <div class="field"><span class="label"><strong>2.1.3 CPF</strong></span><span class="value" data-k="cpf_rep_ente"></span></div>
          <div class="field"><span class="label"><strong>2.1.4 E-mail</strong></span><span class="value" data-k="email_rep_ente"></span></div>
          <div class="field"><span class="label"><strong>2.1.5 Telefone</strong></span><span class="value" data-k="tel_rep_ente"></span></div>
        </div>

        <h3>2.2 Representante legal do RPPS</h3>
        <div class="grid grid-num">
          <div class="field"><span class="label"><strong>2.2.1 Nome</strong></span><span class="value" data-k="nome_rep_ug"></span></div>
          <div class="field"><span class="label"><strong>2.2.2 Cargo/Fun√ß√£o</strong></span><span class="value" data-k="cargo_rep_ug"></span></div>
          <div class="field"><span class="label"><strong>2.2.3 CPF</strong></span><span class="value" data-k="cpf_rep_ug"></span></div>
          <div class="field"><span class="label"><strong>2.2.4 E-mail</strong></span><span class="value" data-k="email_rep_ug"></span></div>
          <div class="field"><span class="label"><strong>2.2.5 Telefone</strong></span><span class="value" data-k="tel_rep_ug"></span></div>
        </div>
      </section>

      <!-- 3. SITUA√á√ÉO RELATIVA AO CRP -->
      <section class="term-section avoid-break page-break" id="sec-3">
        <h2>3. SITUA√á√ÉO RELATIVA AO CERTIFICADO DE REGULARIDADE PREVIDENCI√ÅRIA (CRP)</h2>

        <!-- 3.1 Data de vencimento do √∫ltimo CRP -->
        <div class="linha">
          <div class="rotulo">3.1 Data de vencimento do √∫ltimo CRP</div>
          <div class="valor">
            <span data-k="data_vencimento_ultimo_crp" data-fallback="DATA_VENC_ULTIMO_CRP" data-na="‚Äî"></span>
          </div>
        </div>

        <!-- 3.2 Tipo de emiss√£o do √∫ltimo CRP -->
        <div class="linha">
          <div class="rotulo">3.2 Tipo de emiss√£o do √∫ltimo CRP</div>
          <div class="valor">
            <span data-k="tipo_emissao_ult_crp" data-fallback="TIPO_EMISSAO_ULTIMO_CRP" data-na="‚Äî"></span>
          </div>
        </div>

        <h3>3.3 Crit√©rio(s) atualmente irregular(es) no extrato previdenci√°rio</h3>
        <p class="small">Selecione todos os itens apontados como irregulares no extrato.</p>
        <ul id="criterios-list" data-empty="Sem irregularidades informadas."></ul>

        <!-- 3.4 -->
        <div class="linha">
          <h2>3.4 Solicita√ß√£o de Prazo Adicional</h2>
          <div class="valor">
            <div data-3_4="3.4.1">3.4.1 Manuten√ß√£o da conformidade</div>
            <div data-3_4="3.4.2">3.4.2 Equacionamento do d√©ficit atuarial (ou necessidade de prazo adicional para implementar)</div>
            <div data-3_4="3.4.3">3.4.3 Organiza√ß√£o do RPPS conforme crit√©rios estruturantes (inclui art. 40, ¬ß 20, CF)</div>
            <div data-3_4="3.4.4">3.4.4 Outro crit√©rio que apresente (ou possa apresentar) maior complexidade</div>
            <div data-k="PRAZO_ADICIONAL_TEXTO" class="d-none"></div>
          </div>
        </div>
      </section>

      <!-- 4. FASE DO PROGRAMA -->
      <section class="term-section avoid-break" id="sec-fase">
        <h2>4. IDENTIFICA√á√ÉO DA FASE DO PROGRAMA DE REGULARIDADE PREVIDENCI√ÅRIA</h2>
        
        <p class="small">
          Fase selecionada:
          <strong id="fase-escolhida" data-k="FASE_PROGRAMA"></strong>
        </p>

        <p class="small mt"><strong>Campos adicionais desta fase:</strong></p>
        <div id="fase-extra-campos"></div>

        <!-- 4.1 -->
        <div class="avoid-break phase-block" id="fase-41" hidden>
          <h3>4.1 Fase Geral/Introdut√≥ria ‚Äì 1¬∫ CRP Emergencial</h3>
          <ul id="f41-itens" class="clean-list" data-empty="N√£o preenchido"></ul>
        </div>

        <!-- 4.2 -->
        <div class="avoid-break phase-block" id="fase-42" hidden>
          <h3>4.2 Fase Geral/Introdut√≥ria ‚Äì 2¬∫ CRP Emergencial</h3>
          <p class="small"><strong>4.2.1</strong> Regularidade nos seguintes crit√©rios do extrato previdenci√°rio:</p>
          <ul id="f42-itens" class="styled-list" data-empty="N√£o preenchido"></ul>
        </div>

        <!-- 4.3 (CORRIGIDO COMPLETO) -->
        <div class="avoid-break phase-block" id="fase-43" hidden>

          <h3>4.3 Fase Intermedi√°ria/Preparat√≥ria ‚Äì 3¬∫ CRP Emergencial</h3>

          <!-- 4.3.1 -->
          <div class="sub-section" id="f43-sub-1">
            <p class="small"><strong>4.3.1 Manuten√ß√£o de regularidade nos crit√©rios relativos a repasses, aportes e parcelamento:</strong></p>
            <ul id="f43-1" class="styled-list" data-empty="N√£o preenchido"></ul>
            <!-- Texto-resumo garantido via data-k (mesmo se UL falhar) -->
            <p class="small" id="F431_LIST_TXT" data-k="F431_LIST_TXT"></p>
          </div>

          <!-- 4.3.2 -->
          <div class="sub-section" id="f43-sub-2">
            <p class="small"><strong>4.3.2 Regularidade quanto √† utiliza√ß√£o de recursos previdenci√°rios:</strong></p>
            <ul id="f43-2" class="styled-list" data-empty="N√£o preenchido"></ul>
            <p class="small" id="F432_LIST_TXT" data-k="F432_LIST_TXT"></p>
          </div>

          <!-- 4.3.3 -->
          <div class="sub-section" id="f43-sub-3">
            <p class="small"><strong>4.3.3 Regularidade quanto √† aplica√ß√£o dos recursos previdenci√°rios no mercado financeiro:</strong></p>
            <ul id="f43-3" class="styled-list" data-empty="N√£o preenchido"></ul>
            <p class="small" id="F433_LIST_TXT" data-k="F433_LIST_TXT"></p>
          </div>

          <!-- 4.3.4 -->
          <div class="sub-section" id="f43-sub-4">
            <p class="small"><strong>4.3.4 Regularidade quanto aos limites de contribui√ß√£o (EC 103/2019 e Lei 9.717/1998):</strong></p>
            <ul id="f43-4" class="styled-list" data-empty="N√£o preenchido"></ul>
            <p class="small" id="F434_LIST_TXT" data-k="F434_LIST_TXT"></p>
          </div>

          <!-- 4.3.5 -->
          <div class="sub-section" id="f43-sub-5">
            <p class="small"><strong>4.3.5 Regularidade quanto √† limita√ß√£o do rol de benef√≠cios (EC 103/2019):</strong></p>
            <ul id="f43-5" class="styled-list" data-empty="N√£o preenchido"></ul>
            <p class="small" id="F435_LIST_TXT" data-k="F435_LIST_TXT"></p>
          </div>

          <!-- 4.3.6 -->
          <div class="sub-section" id="f43-sub-6">
            <p class="small"><strong>4.3.6 Regularidade quanto √† institui√ß√£o por lei do Regime de Previd√™ncia Complementar ‚Äì RPC:</strong></p>
            <ul id="f43-6" class="styled-list" data-empty="N√£o preenchido"></ul>
            <p class="small" id="F436_LIST_TXT" data-k="F436_LIST_TXT"></p>
          </div>

          <!-- 4.3.7 -->
          <div class="sub-section" id="f43-sub-7">
            <p class="small"><strong>4.3.7 Regularidade quanto ao envio de dados e informa√ß√µes do RPPS:</strong></p>
            <ul id="f43-7" class="styled-list" data-empty="N√£o preenchido"></ul>
            <p class="small" id="F437_LIST_TXT" data-k="F437_LIST_TXT"></p>
          </div>

          <!-- 4.3.8 -->
          <div class="sub-section" id="f43-sub-8">
            <p class="small"><strong>4.3.8 Regularidade quanto √† operacionaliza√ß√£o da compensa√ß√£o previdenci√°ria:</strong></p>
            <ul id="f43-8" class="styled-list" data-empty="N√£o preenchido"></ul>
            <p class="small" id="F438_LIST_TXT" data-k="F438_LIST_TXT"></p>
          </div>

          <!-- 4.3.9 -->
          <div class="sub-section" id="f43-sub-9">
            <p class="small"><strong>4.3.9 Regularidade quanto aos requisitos dos dirigentes e colegiados (art. 8¬∫-B da Lei 9.717/1998):</strong></p>
            <ul id="f43-9" class="styled-list" data-empty="N√£o preenchido"></ul>
            <p class="small" id="F439_LIST_TXT" data-k="F439_LIST_TXT"></p>
          </div>

          <!-- Fallback textual caso os ULs 4.3.1‚Äì4.3.9 fiquem vazios -->
          <div id="f43-fallback" class="value-block" style="margin-top: .35rem;"></div>

          <!-- 4.3.10 -->
          <div class="sub-section" id="f43-sub-10">
            <p class="small"><strong>4.3.10 ‚Äì Em rela√ß√£o √† adequa√ß√£o das regras de benef√≠cios do RPPS √† Emenda Constitucional n¬∫ 103/2019:</strong></p>

            <div id="f43-opcao-a" class="field-group" hidden>
              <p><strong>a)</strong> Foram adotadas regras de elegibilidade, de c√°lculo e de reajustamento dos benef√≠cios do RPPS...</p>
              <p class="label-like">Relacionar a legisla√ß√£o:</p>
              <div class="value-block" id="val-f4310-leg" data-k="F4310_LEGISLACAO"></div>
            </div>

            <div id="f43-opcao-b" class="field-group" hidden>
              <p><strong>b)</strong> Comprovamos encaminhamento de propostas ao Poder Legislativo...</p>
              <p class="label-like">Documentos anexados:</p>
              <div class="value-block" id="val-f4310-docs" data-k="F4310_DOCS"></div>
            </div>
          </div>

          <!-- 4.3.11 -->
          <div class="sub-section" id="f43-sub-11">
            <p class="small"><strong>4.3.11 - Solicita√ß√£o de inclus√£o de crit√©rios nos Planos de A√ß√£o da Fase Espec√≠fica</strong></p>

            <p class="label-like">a) Crit√©rios selecionados:</p>
            <ul id="f43-crit-incluir" class="styled-list" style="display:block; list-style:none; padding-left:0;"></ul>
            <!-- Texto-resumo dos crit√©rios (backup) -->
            <p class="small" id="F4311_INCLUIR_TXT" data-k="F4311_INCLUIR_TXT"></p>

            <p class="label-like">b) Justificativas/Informa√ß√µes:</p>
            <div class="value-block" id="f43-just-11"></div>
            <!-- Texto-resumo da justificativa (backup) -->
            <p class="small" id="F4311_PLANO_TXT" data-k="F4311_PLANO_TXT"></p>

            <p class="small text-muted small">
              Obs.: N√£o se aplica a crit√©rios de ‚ÄúDIPR - Consist√™ncia e Car√°ter Contributivo‚Äù, ‚ÄúCar√°ter contributivo - Repasse (PAP)‚Äù e ‚ÄúUtiliza√ß√£o dos recursos previdenci√°rios (PAP)‚Äù.
            </p>
          </div>

          <!-- 4.3.12 -->
          <div class="sub-section" id="f43-sub-12">
            <p class="small"><strong>4.3.12 Solicita√ß√£o de inclus√£o de crit√©rios nos Planos de A√ß√£o da Fase Espec√≠fica</strong></p>

            <p class="label-like">a) Crit√©rios que dever√£o ser inclu√≠dos:</p>
            <ul id="f43-crit-incluir-12" class="styled-list" data-empty="N√£o preenchido"></ul>
            <p class="small" id="F4312_INCLUIR_TXT" data-k="F4312_INCLUIR_TXT"></p>

            <p class="label-like">b) Justificativas/Informa√ß√µes apresentadas:</p>
            <div class="value-block" id="f43-just-12"></div>
            <p class="small" id="F4312_PLANO_TXT" data-k="F4312_PLANO_TXT"></p>

            <p class="label-like">c) Descri√ß√£o dos Planos de A√ß√£o:</p>
            <div class="value-block" id="f43-desc-planos-12"></div>
            <p class="small" id="F4312_DESC_TXT" data-k="F4312_DESC_TXT"></p>

            <p class="small text-muted small">
              Obs.: N√£o se aplica a crit√©rios de DIPR, Car√°ter Contributivo ‚Äì Repasse e Utiliza√ß√£o dos Recursos Previdenci√°rios (PAP).
            </p>
          </div>
        </div> <!-- FIM DA 4.3 -->

        <!-- 4.4 -->
        <div class="avoid-break phase-block" id="fase-44" hidden>
          <h3>4.4 Fase Espec√≠fica/Focalizada ‚Äì 4¬∫ CRP Emergencial</h3>
          <div class="sub-section" id="f44-sub-1">
            <p class="small"><strong>4.4.1 Declaro ter cumprido as seguintes condi√ß√µes:</strong></p>
            <ul id="f44-decls" class="styled-list" data-empty="N√£o preenchido"></ul>
            <div id="f44-leg-wrap" class="field-group" hidden>
              <p class="label-like">Relacionar a legisla√ß√£o:</p>
              <div class="value-block" data-k="F441_LEGISLACAO"></div>
            </div>
          </div>

          <div class="sub-section" id="f44-sub-2">
            <p class="small"><strong>4.4.2 Finalidade do(s) Plano(s) de A√ß√£o apresentado(s)</strong></p>
            <ul id="f44-finalidades" class="styled-list" data-empty="N√£o preenchido"></ul>
          </div>

          <div class="sub-section" id="f44-sub-3">
            <p class="small"><strong>4.4.3 Crit√©rio(s) do extrato previdenci√°rio objeto do(s) Plano(s) de A√ß√£o</strong></p>
            <ul id="f44-criterios" class="styled-list" data-empty="N√£o preenchido"></ul>
          </div>

          <div class="sub-section" id="f44-sub-4">
            <p class="small"><strong>4.4.4 Anexos</strong></p>
            <div class="value-block" data-k="F44_ANEXOS"></div>
          </div>

          <div class="sub-section" id="f44-sub-5">
            <p class="small"><strong>4.4.5 Descrever sucintamente o(s) Plano(s) de A√ß√£o apresentado(s):</strong></p>
            <div class="value-block" data-k="F445_DESC_PLANOS"></div>
          </div>

          <div class="sub-section" id="f44-sub-6">
            <p class="small"><strong>4.4.6 Execu√ß√£o e resultados alcan√ßados</strong></p>
            <p class="label-like">a) Documentos</p>
            <div class="value-block" data-k="F446_DOCS"></div>
            <p class="label-like">b) Execu√ß√£o e resultados</p>
            <div class="value-block" data-k="F446_EXEC_RES"></div>
          </div>
        </div>

        <!-- 4.5 -->
        <div class="avoid-break phase-block" id="fase-45" hidden>
          <h3>4.5 Fase Espec√≠fica/Focalizada ‚Äì 5¬∫ CRP Emergencial</h3>
          <ul id="f45-decls" class="styled-list" data-empty="N√£o preenchido"></ul>

          <div class="sub-section" id="f45-sub-2">
            <p class="small"><strong>4.5.2 Comprova√ß√£o do cumprimento</strong></p>
            <div class="value-block" data-k="F45_DOCS"></div>
          </div>

          <div class="sub-section" id="f45-sub-4">
            <p class="small"><strong>4.5.4 Justificativas</strong></p>
            <div class="value-block" data-k="F45_JUST"></div>
          </div>

          <div class="sub-section" id="f45-sub-3">
            <p class="small"><strong>4.5.3 Execu√ß√£o e resultados</strong></p>
            <div class="value-block" data-k="F453_EXEC_RES"></div>
          </div>
        </div>

        <!-- 4.6 -->
        <div class="avoid-break phase-block" id="fase-46" hidden>
          <h3>4.6 Fase de Manuten√ß√£o da Conformidade</h3>

          <div class="sub-section" id="f46-sub-1">
            <p class="small"><strong>4.6.1 Declaro ter cumprido as seguintes condi√ß√µes:</strong></p>

            <p class="label-like">a) Crit√©rios regulares:</p>
            <ul id="f46-criterios" class="styled-list" data-empty="N√£o preenchido"></ul>

            <p class="label-like">b) N√≠vel de certifica√ß√£o no Pr√≥-Gest√£o RPPS</p>
            <div class="value-block" data-k="F46_PROGESTAO"></div>

            <p class="label-like">c) Grupo de Porte (ISP-RPPS)</p>
            <div class="value-block" data-k="F46_PORTE"></div>

            <p class="label-like">d) Melhora financeira/atuarial</p>
            <p class="label-like nested">Justificativas</p>
            <div class="value-block" data-k="F46_JUST_D"></div>
            <p class="label-like nested">Documentos</p>
            <div class="value-block" data-k="F46_DOCS_D"></div>

            <p class="label-like">e) Medidas de acompanhamento atuarial</p>
            <p class="label-like nested">Justificativas</p>
            <div class="value-block" data-k="F46_JUST_E"></div>
            <p class="label-like nested">Documentos</p>
            <div class="value-block" data-k="F46_DOCS_E"></div>
          </div>

          <div class="sub-section" id="f46-sub-2">
            <p class="small"><strong>4.6.2 Finalidade do(s) Plano(s) de A√ß√£o</strong></p>
            <ul id="f46-finalidades" class="styled-list" data-empty="N√£o preenchido"></ul>
            <ul id="f46-crit-f" class="styled-list nested-list" data-empty="N√£o preenchido"></ul>
          </div>

          <div class="sub-section" id="f46-sub-6">
            <p class="small"><strong>4.6.6 Execu√ß√£o do(s) Plano(s) de A√ß√£o:</strong></p>
            <p class="label-like">a) Documentos</p>
            <div class="value-block" data-k="F466_DOCS"></div>
            <p class="label-like">b) Resultados alcan√ßados</p>
            <div class="value-block" data-k="F466_EXEC_RES"></div>
          </div>
        </div>
      </section>

      <!-- 5. JUSTIFICATIVAS GERAIS -->
      <section class="term-section avoid-break">
        <h2>5. JUSTIFICATIVAS / INFORMA√á√ïES ADICIONAIS</h2>
        <p data-k="justificativas_gerais"></p>
      </section>

      <!-- For√ßa p√°gina nova antes das assinaturas -->
      <div class="break-before"></div>

      <!-- Assinaturas -->
      <footer class="term-footer">
        <p class="place-date"><span data-k="ente"></span>/<span data-k="uf"></span>, <span data-k="data_termo"></span>.</p>

        <div class="signature-block">
          <div class="signature-line" aria-hidden="true"></div>
          <p class="signature-caption">
            <strong><span data-k="nome_rep_ente"></span></strong><br>
            <span id="sig-cap-ente">Representante legal do Munic√≠pio de <span data-k="ente"></span>/<span data-k="uf"></span></span>
          </p>
        </div>

        <div class="signature-block">
          <div class="signature-line" aria-hidden="true"></div>
          <p class="signature-caption">
            <strong><span data-k="nome_rep_ug"></span></strong><br>
            Representante legal do <span data-k="ug"></span>
          </p>
        </div>
      </footer>
    </main>
  </div>

  <!-- Modal "Gerando PDF‚Ä¶" -->
  <div id="pdf-modal" class="pdf-modal" aria-hidden="true">
    <div class="pdf-modal__backdrop"></div>
    <div class="pdf-modal__box" role="dialog" aria-modal="true" aria-label="Gerando PDF">
      <div class="pdf-modal__header">Gerando PDF‚Ä¶</div>
      <div class="pdf-modal__body">
        <p>Aguarde, preparando o arquivo.</p>
        <div class="spinner" aria-hidden="true"></div>
      </div>
    </div>
  </div>

  <!-- SCRIPT √öNICO, COMPLETO -->
  <script>
    (function () {
      const $  = (s, r=document) => r.querySelector(s);
      const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));

      // === INJE√á√ÉO DE PAYLOAD (hash, query, sessionStorage ou postMessage) ===
      (function initPayload(){
        const KEY = 'TERMO_SOLIC_CRP_PAYLOAD';
        const setPayload = (p) => {
          if (!p || typeof p !== 'object') return;
          window.__TERMO_DATA__ = p;
          try {
            document.dispatchEvent(new Event('TERMO_DATA'));
            document.dispatchEvent(new Event('TERMO_DATA_READY'));
          } catch (_) {}
        };

        // hash #payload_b64=
        try {
          const h = location.hash || '';
          const m = h.match(/payload_b64=([^&]+)/);
          if (m && m[1]) {
            const json = decodeURIComponent(escape(atob(m[1])));
            setPayload(JSON.parse(json));
            return;
          }
        } catch(e){ console.warn('[TERMO] falha ao ler payload_b64', e); }

        // query ?p= (JSON)
        try {
          const pParam = new URLSearchParams(location.search).get('p');
          if (pParam) {
            const decoded = decodeURIComponent(pParam);
            setPayload(JSON.parse(decoded));
            return;
          }
        } catch(e){ console.warn('[TERMO] falha ao ler query ?p=', e); }

        // sessionStorage (salvo pelo app)
        try {
          const ss = sessionStorage.getItem(KEY);
          if (ss) {
            setPayload(JSON.parse(ss));
            return;
          }
        } catch(_) {}

        // postMessage de janela pai
        try {
          window.addEventListener('message', ev => {
            if (ev.data && (ev.data.type === 'TERMO_PAYLOAD' || ev.data.type === 'TERMO_SOLIC_CRP_PAYLOAD')) {
              setPayload(ev.data.data || ev.data.payload || ev.data);
            }
          });
        } catch(_) {}
      })();

      const __NA_LABEL__ = () =>
        String((window.__TERMO_DATA__ && window.__TERMO_DATA__.__NA_LABEL) || 'N√£o informado');

      // Agora o padr√£o N√ÉO √© mais "verdadeiro" para qualquer payload.
      // S√≥ entra em modo "__NA_ALL" quando for explicitamente marcado.
      const __NA_ALL__ = () => {
        const d = window.__TERMO_DATA__;
        if (!d) return true; // antes de qualquer payload, mant√©m comportamento antigo

        if (Object.prototype.hasOwnProperty.call(d, '__NA_ALL')) {
          return !!d.__NA_ALL;
        }

        // Se j√° temos dados reais (ente, UF, fase, etc.), n√£o estamos em modo placeholder
        const temDadosReais =
          d.ENTE || d.ente ||
          d.UF   || d.uf   ||
          d.FASE_PROGRAMA || d.__FASE_SEL__;

        return temDadosReais ? false : true;
      };

      function fillText(key, val){
        const raw = (val == null) ? '' : String(val);
        const trimmed = raw.trim();

        // üî• Campos da Fase 4.3 (4.3.1 a 4.3.12)
        const isF43 =
          /^F43(1|2|3|4|5|6|7|8|9|10|11|12)/i.test(String(key)) ||
          /^F431[0-9]?_/.test(String(key));

        // Se for Fase 4.3 e N√ÉO vier valor no payload,
        // n√£o sobrescreve nada que j√° esteja na tela
        if (isF43 && !trimmed) {
          const els = $$('[data-k="'+key+'"]');
          const jaTemAlgo = els.some(el => String(el.textContent || '').trim());
          if (jaTemAlgo) {
            // J√° existe texto exibido (ex.: gerado por __reconstruirF43 / hydrateF43),
            // ent√£o n√£o mexe.
            return;
          }
        }

        let s;
        if (isF43) {
          // Para Fase 4.3: usa o que veio, ou deixa vazio (mas nunca "N√£o informado")
          s = trimmed;
        } else {
          // Demais campos: mant√©m l√≥gica normal com "__NA_LABEL__"
          s = trimmed || (__NA_ALL__() ? __NA_LABEL__() : '');
        }

        $$('[data-k="'+key+'"]').forEach(el => { el.textContent = s; });
      }

      /* ===== Utilit√°rios ===== */
      function escapeHtml(s){
        return String(s||'').replace(/[&<>\"']/g, m => ({
          '&':'&amp;',
          '<':'&lt;',
          '>':'&gt;',
          '"':'&quot;',
          "'":'&#39;'
        })[m]);
      }

      function asArr(v){
        if (Array.isArray(v)) return v;
        if (v == null || v === '') return [];
        if (typeof v === 'string') {
          const s = v.trim();
          if (!s) return [];
          // Tenta JSON primeiro (caso venha stringified)
          if ((s.startsWith('[') && s.endsWith(']'))) {
            try {
              const j = JSON.parse(s);
              if (Array.isArray(j)) {
                return j
                  .filter(Boolean)
                  .map(x=>String(x).trim())
                  .filter(Boolean);
              }
            } catch(_) {}
          }
          // padr√£o: separa por ; ou quebra de linha
          return s.split(/;|\r?\n/).map(t=>t.trim()).filter(Boolean);
        }
        return [String(v)].filter(Boolean);
      }

      function splitLines(s){
        return String(s||'').split(/\r?\n/).map(t=>t.trim()).filter(Boolean);
      }

      function liList(sel, arr){
        const ul = document.querySelector(sel);
        if (!ul) {
          console.warn('[TERMO F43] liList: UL n√£o encontrada para seletor', sel);
          return false; 
        }
        const a = asArr(arr);

        console.log('[TERMO F43] liList: preenchendo', sel, 'com', a);

        if (a.length) {
          ul.innerHTML = a.map(x=>`<li>${escapeHtml(x)}</li>`).join('');
          return true;
        } 
        ul.innerHTML = '';
        return false;
      }
      const fillList = liList;

      /********************************************************************
       * DEBUG MODE ‚Äì Diagn√≥stico de preenchimento da Fase 4.3
      ********************************************************************/
      window.__debugF43 = function(p) {
        console.groupCollapsed("%c[F43 DEBUG] Iniciando diagn√≥stico detalhado", "color:#0af");

        console.log("Payload Fase 4.3 (chaves relevantes):", {
          F43_LISTA: p.F43_LISTA,
          F43_LISTA_TXT: p.F43_LISTA_TXT,
          F43_INCLUIR: p.F43_INCLUIR,
          F43_INCLUIR_B: p.F43_INCLUIR_B,
          F43_PLANO: p.F43_PLANO,
          F43_PLANO_B: p.F43_PLANO_B,
          F43_DESC_PLANOS: p.F43_DESC_PLANOS,
          fase4_3_criterios: p.fase4_3_criterios
        });

        // Verifica se os elementos HTML existem
        for (let i = 1; i <= 12; i++) {
          const el = document.querySelector(`#f43-${i}`) || document.querySelector(`#f43-sub-${i}`);
          console.log(`Elemento #f43-${i} ou #f43-sub-${i}:`, el ? "OK" : "‚ùå N√ÉO ENCONTRADO");
        }

        // Testa fillList em um UL real (se existir)
        if (typeof fillList === "function") {
          console.groupCollapsed("[F43 DEBUG] Testando fillList em #f43-1");
          const testeOK = fillList("#f43-1", ["Item de teste A", "Item de teste B"]);
          console.log("fillList(#f43-1, ...) ‚Üí", testeOK ? "OK (preencheu)" : "FALHOU");
          console.groupEnd();
        } else {
          console.warn("‚ö†Ô∏è fun√ß√£o fillList n√£o encontrada no contexto atual!");
        }

        // Depois de um tempo, l√™ o DOM para ver o que ficou de fato
        setTimeout(() => {
          console.groupCollapsed("[DOM CHECK] Conte√∫do atual de cada UL F43");
          for (let i = 1; i <= 12; i++) {
            const ul = document.querySelector(`#f43-${i}`);
            if (ul) {
              console.log(`#f43-${i}:`, (ul.innerText || "").trim() || "(vazio)");
            } else {
              console.warn(`#f43-${i} n√£o existe no template`);
            }
          }
          console.groupEnd();
          console.groupEnd();
        }, 1500);
      };

      function renderParagraphs(sel, s){
        const el = document.querySelector(sel);
        if (!el) return false;
        const lines = splitLines(s);
        if (lines.length) {
          el.innerHTML = lines.map(x=>`<p>${escapeHtml(x)}</p>`).join('');
          return true;
        }
        el.innerHTML = '';
        return false;
      }
      const fillBlock = renderParagraphs;

      function fillValue(sel, val) {
        const el = $(sel);
        if (!el) return false;
        const s = String(val || '').trim();
        if (s) {
          el.innerHTML = escapeHtml(s).replace(/\r?\n/g, '<br>');
          return true;
        }
        el.innerHTML = '';
        return false;
      }

      function show(sel, visible) {
        const el = $(sel);
        if (el) {
          el.hidden = !visible;
          el.style.display = visible ? '' : 'none';
        }
      }

      // ==================== FUN√á√ÉO GLOBAL (usada por hydrateF43) ====================
      function togglePhaseBlock(id, hasContent) {
        const el = document.querySelector(id);
        if (el) {
          el.hidden = !hasContent;
          el.style.display = hasContent ? '' : 'none';
          el.setAttribute('data-empty', hasContent ? 'false' : 'true');
        }
      }

      /* ===== Normaliza√ß√£o do payload ===== */
      function normalizePayload(p0){
        const p = Object.assign({}, p0);

        const getAny = (...keys) => {
          for (const k of keys) {
            if (p[k] !== undefined && p[k] !== null && p[k] !== '') return p[k];
            const lower = k.toLowerCase();
            if (p[lower] !== undefined && p[lower] !== null && p[lower] !== '') return p[lower];
          }
          return undefined;
        };

        // 3.1 e 3.2 CRP
        p.DATA_VENC_ULTIMO_CRP = getAny('DATA_VENC_ULTIMO_CRP', 'DATA_VENCIMENTO_ULTIMO_CRP', 'venc_ult_crp', 'data_vencimento_ultimo_crp') || '';
        p.TIPO_EMISSAO_ULTIMO_CRP = getAny('TIPO_EMISSAO_ULTIMO_CRP', 'tipo_emissao_ult_crp', 'tipo_emissao_ultimo_crp', 'tipo') || '';
        
        let tCrp = String(p.TIPO_EMISSAO_ULTIMO_CRP).trim().toLowerCase();
        if (tCrp.startsWith('adm') || tCrp === 'nao' || tCrp === 'n') p.TIPO_EMISSAO_ULTIMO_CRP = 'Administrativa';
        if (tCrp.startsWith('jud') || tCrp === 'sim' || tCrp === 's') p.TIPO_EMISSAO_ULTIMO_CRP = 'Judicial';
        
        p.data_vencimento_ultimo_crp = p.DATA_VENC_ULTIMO_CRP;
        p.tipo_emissao_ult_crp = p.TIPO_EMISSAO_ULTIMO_CRP;

        // 3.3 Crit√©rios
        p.__CRITERIOS_ARR__ = asArr(getAny('CRITERIOS_IRREGULARES', 'CRITERIOS_LIST', 'criterios_irregulares'));

        // 3.4 Prazo Adicional
        p.PRAZO_ADICIONAL_TEXTO = getAny('PRAZO_ADICIONAL_TEXTO', 'prazo_adicional_texto') || '';
        let prazoCod = getAny('PRAZO_ADICIONAL_COD', 'prazo_adicional_cod', 'prazo_adicional');
        if (prazoCod) {
          const m = String(prazoCod).match(/3\.[24]\.(\d)/);
          if (m) prazoCod = `3.4.${m[1]}`;
        }
        p.PRAZO_ADICIONAL_COD = prazoCod || '';

        // 4. Fase Selecionada
        p.__FASE_SEL__ = String(getAny('__FASE_SEL__', 'FASE_PROGRAMA', 'fase_programa', 'FASE') || '').trim();

        // 4.1
        p.F41_OPCAO_TEXT = getAny('F41_OPCAO_TEXT', 'F41_OPCAO', 'f41_opcao', 'CELEBRACAO_TERMO_PARCELA_DEBITOS') || '';

        // 4.2
        p.F42_LISTA = asArr(getAny('F42_LISTA', 'F42_LISTA[]', 'F42_ITENS', 'F42_ITENS[]'));

        // 4.3 ‚Äî montagem mais robusta das listas

        // F43_LISTA: junta qualquer varia√ß√£o que chegar (array, string, "[]", TXT)
        (function () {
          const merged = [];
          ['F43_LISTA', 'F43_LISTA[]', 'F43_LISTA[][]', 'F43_ITENS', 'F43_ITENS[]', 'F43_ITENS[][]', 'fase4_3_criterios', 'fase4_3_criterios[]'].forEach(k => {
            if (p[k] !== undefined && p[k] !== null && p[k] !== '') {
              merged.push(...asArr(p[k]));
            }
          });

          // fallback: se n√£o vier array, tenta o TXT (string com ; entre itens)
          if (!merged.length && (p.F43_LISTA_TXT || p['F43_LISTA_TXT[]'])) {
            merged.push(...asArr(p.F43_LISTA_TXT || p['F43_LISTA_TXT[]']));
          }

          p.F43_LISTA = merged;

          if (window.__DEBUG_SOLIC_CRP__) {
            console.log('[DEBUG_F43_NORMALIZE] merge F43_LISTA', {
              merged,
              F43_LISTA_TXT: p.F43_LISTA_TXT,
              raw: {
                F43_LISTA: p.F43_LISTA,
                F43_LISTA_TXT: p.F43_LISTA_TXT,
                fase4_3_criterios: p.fase4_3_criterios,
                fase4_3_criterios_txt: p.fase4_3_criterios_txt
              }
            });
          }
        })();

        // F43_INCLUIR (4.3.11 ‚Äì crit√©rios a incluir)
        (function () {
          const merged = [];
          ['F43_INCLUIR', 'F43_INCLUIR[]', 'F43_INCLUIR[][]', 'F43_INCLUIR_TXT', 'f43_incluir'].forEach(k => {
            if (p[k] !== undefined && p[k] !== null && p[k] !== '') {
              merged.push(...asArr(p[k]));
            }
          });
          p.F43_INCLUIR = merged;
        })();

        // F43_INCLUIR_B (4.3.12 ‚Äì crit√©rios a incluir na fase espec√≠fica)
        (function () {
          const merged = [];
          ['F43_INCLUIR_B', 'F43_INCLUIR_B[]', 'F43_INCLUIR_B[][]', 'F43_INCLUIR_B_TXT', 'f43_incluir_b'].forEach(k => {
            if (p[k] !== undefined && p[k] !== null && p[k] !== '') {
              merged.push(...asArr(p[k]));
            }
          });
          p.F43_INCLUIR_B = merged;
        })();

        // Demais campos de 4.3
        p.F43_PLANO        = getAny('F43_PLANO', 'f43_plano') || '';
        p.F43_PLANO_B      = getAny('F43_PLANO_B', 'f43_plano_b') || '';
        p.F43_DESC_PLANOS  = getAny('F43_DESC_PLANOS', 'f43_desc_planos') || '';
        p.F43_JUST         = getAny('F43_JUST', 'f43_just') || '';
        
        // 4.3.10: captura e normaliza (aceita aliases/c√≥digos/texto)
        p.F4310_OPCAO        = getAny('F4310_OPCAO', 'F4310_OPCAO_CODE', 'F4310_OPCAO_TXT', 'f4310_opcao') || '';
        p.F4310_LEGISLACAO   = getAny('F4310_LEGISLACAO', 'F4310_LEGISLACAO_TXT', 'F4310_LEG', 'f4310_legislacao') || '';
        p.F4310_DOCS         = getAny('F4310_DOCS', 'F4310_DOCS_TXT', 'F4310_DOC', 'f4310_docs') || '';
        p.F4310_FALLBACK_TXT = getAny('F4310_FALLBACK_TXT', 'f4310_fallback_txt') || '';

        // ===================================================
        // NOVO PREENCHIMENTO DIRETO DOS TEXTOS 4.3.1 A 4.3.9
        // (sem usar data-k / fillText) ‚Äì AGORA TAMB√âM ALIMENTA O PAYLOAD NORMALIZADO
        // ===================================================
        try {
          if (typeof __reconstruirF43 === 'function') {
            const gruposF43 = __reconstruirF43(p);

            const mapResumo = {
              "4.3.1": { sel: "#F431_LIST_TXT" },
              "4.3.2": { sel: "#F432_LIST_TXT" },
              "4.3.3": { sel: "#F433_LIST_TXT" },
              "4.3.4": { sel: "#F434_LIST_TXT" },
              "4.3.5": { sel: "#F435_LIST_TXT" },
              "4.3.6": { sel: "#F436_LIST_TXT" },
              "4.3.7": { sel: "#F437_LIST_TXT" },
              "4.3.8": { sel: "#F438_LIST_TXT" },
              "4.3.9": { sel: "#F439_LIST_TXT" }
            };

            const resolveVals = (k) => {
              const idx = k.split('.').pop();
              return gruposF43[k]
                || gruposF43[`grupo${idx}`]
                || (gruposF43.grupos ? gruposF43.grupos[k] : [])
                || [];
            };

            Object.entries(mapResumo).forEach(([k, cfg]) => {
              const vals   = resolveVals(k);
              const el     = document.querySelector(cfg.sel);
              const texto  = (vals || []).join('; ');

              // Atualiza tamb√©m o objeto normalizado 'p', para que
              // o fillText() gen√©rico, que roda depois, use o mesmo conte√∫do
              // e N√ÉO zere o campo.
              const id = (cfg.sel || '').replace('#',''); // ex.: "#F431_LIST_TXT" -> "F431_LIST_TXT"
              if (id) p[id] = texto || '';

              if (el) el.textContent = texto || ''; // nunca "N√£o informado"
            });
          }
        } catch (e) {
          console.error('[F43 resumo direto] erro ao preencher textos 4.3.1-4.3.9:', e);
        }

        // 4.3.11 ‚Äì sempre gera texto de crit√©rios e justificativa
        const _incl11Arr = asArr(
          p.F43_INCLUIR ||
          p['F43_INCLUIR[]'] ||
          p.F43_INCLUIR_TXT ||
          p.F4311_INCLUIR_TXT
        );
        p.F4311_INCLUIR_TXT = _incl11Arr.join('; ');
        p.F4311_PLANO_TXT   = p.F43_PLANO || '';

        // 4.3.12 ‚Äì idem
        const _incl12Arr = asArr(
          p.F43_INCLUIR_B ||
          p['F43_INCLUIR_B[]'] ||
          p.F43_INCLUIR_B_TXT ||
          p.F4312_INCLUIR_TXT
        );
        p.F4312_INCLUIR_TXT = _incl12Arr.join('; ');
        p.F4312_PLANO_TXT   = p.F43_PLANO_B || '';
        p.F4312_DESC_TXT    = p.F43_DESC_PLANOS || '';

        // 4.4
        p.F44_CRITERIOS   = asArr(getAny('F44_CRITERIOS', 'F44_CRITERIOS[]', 'f44_criterios'));
        p.F44_DECLS       = asArr(getAny('F44_DECLS', 'F44_DECLS[]', 'f44_decls'));
        p.F44_FINALIDADES = asArr(getAny('F44_FINALIDADES', 'F44_FINALIDADES[]', 'f44_finalidades'));
        p.F44_ANEXOS      = getAny('F44_ANEXOS', 'f44_anexos') || '';
        p.F441_LEGISLACAO = getAny('F441_LEGISLACAO', 'f441_legislacao') || '';
        p.F445_DESC_PLANOS = getAny('F445_DESC_PLANOS', 'f445_desc_planos') || '';
        p.F446_DOCS       = getAny('F446_DOCS', 'f446_docs') || '';
        p.F446_EXEC_RES   = getAny('F446_EXEC_RES', 'f446_exec_res') || '';

        // 4.5
        p.F45_DECLS       = asArr(getAny('F45_DECLS', 'F45_DECLS[]', 'f45_decls', 'F45_CONDICOES[]'));
        p.F45_DOCS        = getAny('F45_DOCS', 'f45_docs') || '';
        p.F45_JUST        = getAny('F45_JUST', 'f45_just') || '';
        p.F453_EXEC_RES   = getAny('F453_EXEC_RES', 'f453_exec_res') || '';

        // 4.6
        p.F46_DECLS       = asArr(getAny('F46_DECLS', 'F46_DECLS[]', 'f46_decls'));
        p.F46_CRITERIOS   = asArr(getAny('F46_CRITERIOS', 'F46_CRITERIOS[]', 'f46_criterios'));
        p.F46_FINALIDADES = asArr(getAny('F46_FINALIDADES', 'F46_FINALIDADES[]', 'f46_finalidades'));
        p.F462F_CRITERIOS = asArr(getAny('F462F_CRITERIOS', 'F462F_CRITERIOS[]', 'f462f_criterios'));
        p.F46_CRITERIOS   = [...p.F46_CRITERIOS, ...p.F462F_CRITERIOS];
        
        p.F46_PROGESTAO   = getAny('F46_PROGESTAO', 'f46_progestao') || '';
        p.F46_PORTE       = getAny('F46_PORTE', 'f46_porte') || '';
        p.F46_JUST_D      = getAny('F46_JUST_D', 'f46_just_d') || '';
        p.F46_DOCS_D      = getAny('F46_DOCS_D', 'f46_docs_d') || '';
        p.F46_JUST_E      = getAny('F46_JUST_E', 'f46_just_e') || '';
        p.F46_DOCS_E      = getAny('F46_DOCS_E', 'f46_docs_e') || '';
        p.F466_DOCS       = getAny('F466_DOCS', 'f466_docs') || '';
        p.F466_EXEC_RES   = getAny('F466_EXEC_RES', 'f466_exec_res') || '';

        // 5. Justificativas Gerais
        p.JUSTIFICATIVAS_GERAIS = getAny('JUSTIFICATIVAS_GERAIS', 'justificativas_gerais') || '';

        // 6. Data Termo
        p.data_termo = getAny('DATA_TERMO_GERADO', 'DATA_SOLIC_GERADA', 'data_termo', 'data') || '';

        return p;
      }

      function __reconstruirF43(payload) {
        const p = payload || {};

        // 1) Base: pega lista principal ou reconstr√≥i de campos unit√°rios
        let lista = [];
        if (Array.isArray(p.F43_LISTA) && p.F43_LISTA.length) {
            lista = [...p.F43_LISTA];
        } else if (p.F43_LISTA_TXT) {
            lista = asArr(p.F43_LISTA_TXT);
        } else {
          const ordem = [
              'F43_1','F43_1_TXT','F43_2',
              'F43_3_A','F43_3_B','F43_3_C',
              'F43_4_A','F43_4_B',
              'F43_5','F43_6',
              'F43_7_A','F43_7_B','F43_7_C','F43_7_D','F43_7_E','F43_7_F','F43_7_G','F43_7_H',
              'F43_8','F43_9'
          ];
          ordem.forEach(k => {
              const val = p[k] || p[k.toUpperCase()] || p[k.toLowerCase()];
              if (Array.isArray(val)) val.forEach(v => { const s = String(v||'').trim(); if (s) lista.push(s); });
              else { const s = String(val||'').trim(); if (s) lista.push(s); }
          });
          // aliases extras que podem chegar do backend/Joi
          const extraLista = p.fase4_3_criterios || p['fase4_3_criterios[]'] || p['F43_LISTA[][]'] || p['F43_ITENS[][]'];
          if (!lista.length && Array.isArray(extraLista) && extraLista.length) {
            lista = [...extraLista];
          }
          if (!lista.length && Array.isArray(p.fase4_3_criterios) && p.fase4_3_criterios.length) {
            lista = [...p.fase4_3_criterios];
            p.F43_LISTA = lista.slice();
            p.F43_LISTA_TXT = lista.join('; ');
          }
        }

        // 2) Normaliza√ß√£o para compara√ß√£o (remove acentos/aspas curvas)
        const normalize = (s) =>
          String(s||'')
            .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
            .replace(/[‚Äú‚Äù‚Äû¬´¬ª]/g, '"')
            .replace(/[‚Äì‚Äî]/g, '-')         // en/emdash ‚Üí h√≠fen
            .replace(/^[a-z]\)\s*/i, '')   // tira ‚Äúa) ‚Äù, ‚Äúb) ‚Äù etc.
            .toLowerCase();

        const listaNorm = lista.map(raw => ({ raw, norm: normalize(raw) }));

        const filterBy = (terms) => {
          const norms = terms.map(normalize);
          return listaNorm
            .filter(it => norms.some(t => it.norm.includes(t)))
            .map(it => it.raw);
        };

        // 3) Agrupamento por conte√∫do (palavra-chave)
        const grupos = {
            "4.3.1": filterBy(["DIPR - Consistencia", "Carater contributivo - Repasse"]),
            "4.3.2": filterBy(["Utilizacao dos recursos previdenciarios"]),
            "4.3.3": filterBy(["Aplicacoes Financeiras", "DAIR - Consistencia", "DPIN - Consistencia"]),
            "4.3.4": filterBy(["limites de contribuicao do ente", "limites de contribuicao dos segurados"]),
            "4.3.5": filterBy(["Plano de beneficios integrado apenas"]),
            "4.3.6": filterBy(["regime de previdencia complementar", "aprova"]),
            "4.3.7": filterBy(["Atendimento a solicitacao", "Atendimento a fiscalizacao", "Equilibrio Financeiro",
                               "Matriz de Saldos", "DPIN - Encaminhamento", "DAIR - Encaminhamento",
                               "DIPR - Encaminhamento", "esocial"]),
            "4.3.8": filterBy(["compensacao previdenciaria", "Termo de Adesao"]),
            "4.3.9": filterBy(["Requisitos para os dirigentes", "colegiados"])
        };

        // 4) Fallback posicional para qualquer grupo que tenha ficado vazio
        const slices = {
          "4.3.1": [0, 2],
          "4.3.2": [2, 3],
          "4.3.3": [3, 6],
          "4.3.4": [6, 8],
          "4.3.5": [8, 9],
          "4.3.6": [9, 10],
          "4.3.7": [10, 18],
          "4.3.8": [18, 19],
          "4.3.9": [19, 20]
        };
        Object.entries(slices).forEach(([k,[i,j]]) => {
          if (!grupos[k] || grupos[k].length === 0) {
            grupos[k] = lista.slice(i, j);
          }
        });

        // 4.1) Se algum grupo vier "inchado" (ex.: todos os 20 itens), corta pelo tamanho esperado
        const expected = {
          "4.3.1": 2, "4.3.2": 1, "4.3.3": 3, "4.3.4": 2, "4.3.5": 1,
          "4.3.6": 1, "4.3.7": 8, "4.3.8": 1, "4.3.9": 1
        };
        Object.entries(expected).forEach(([k, max]) => {
          if (Array.isArray(grupos[k]) && grupos[k].length > max) {
            grupos[k] = grupos[k].slice(0, max);
          }
        });

        // 4.2) Se TODOS os grupos ficaram com o mesmo tamanho da lista completa (bug de filtro),
        // refaz com os slices padroes para evitar repetir tudo em cada sub-bloco.
        const allFull = lista.length > 0 &&
          Object.values(grupos).every(arr => Array.isArray(arr) && arr.length === lista.length);
        if (allFull) {
          Object.entries(slices).forEach(([k,[i,j]]) => {
            grupos[k] = lista.slice(i, j);
          });
        }

        return grupos;
      }

      /********************************************************************
       * hydrateF43 ‚Äî fun√ß√£o GLOBAL respons√°vel por renderizar a Fase 4.3
       ********************************************************************/
      window.hydrateF43 = function(p) {

        /**************************************************************
         * PATCH 2 ‚Äî Diagn√≥stico direto de Fase 4.3 dentro de hydrateF43
        **************************************************************/
        console.groupCollapsed("%c[F43 HYDRATE] Iniciando hidrata√ß√£o da Fase 4.3", "color:#39f");
        console.log("üöÄ Payload F43 recebido:", {
          F43_LISTA: p.F43_LISTA,
          F43_LISTA_TXT: p.F43_LISTA_TXT,
          F43_INCLUIR: p.F43_INCLUIR,
          F43_PLANO: p.F43_PLANO,
          F43_DESC_PLANOS: p.F43_DESC_PLANOS
        });

        // Teste: verifica se as ULs e DIVs realmente existem no DOM
        const targets = [
          "#f43-1", "#f43-2", "#f43-3", "#f43-4", "#f43-5",
          "#f43-6", "#f43-7", "#f43-8", "#f43-9", "#f43-10",
          "#f43-11", "#f43-12", "#fase43-itens", "#fase43-desc"
        ];
        const notFound = [];
        targets.forEach(sel => {
          const el = document.querySelector(sel);
          console.log(sel, el ? "‚úÖ encontrado" : "‚ùå ausente");
          if (!el) notFound.push(sel);
        });

        // Testa manualmente o preenchimento se existir o campo principal
        const elMain = document.querySelector("#fase43-itens") || document.querySelector("#f43-1");
        if (!elMain) {
          console.warn("‚ö†Ô∏è Nenhum UL de F43 foi encontrado para preencher!");
        }

        console.groupEnd();

        // üî• Vari√°vel global para informar ao run() que a fase 4.3 tem conte√∫do
        window.__F43_HAS_CONTENT__ = false;

        // haConteudo precisa existir tamb√©m fora do try, para o fallback textual
        let haConteudo = false;

        try {
          // 1) Reconstr√≥i os grupos de crit√©rios com base em F43_LISTA / F43_LISTA_TXT
          const gruposF43 = __reconstruirF43(p);
          const listaBase = asArr(p.F43_LISTA || p['F43_LISTA[]'] || p.F43_LISTA_TXT || '');

          // Se todos os grupos vieram vazios mas temos lista base, for√ßa o fatiamento posicional
          const allEmpty = Object.values(gruposF43).every(arr => !arr || !arr.length);
          if (allEmpty && listaBase.length) {
            const slicesHard = {
              "4.3.1": [0, 2],
              "4.3.2": [2, 3],
              "4.3.3": [3, 6],
              "4.3.4": [6, 8],
              "4.3.5": [8, 9],
              "4.3.6": [9, 10],
              "4.3.7": [10, 18],
              "4.3.8": [18, 19],
              "4.3.9": [19, 20]
            };
            Object.entries(slicesHard).forEach(([k,[i,j]]) => {
              gruposF43[k] = listaBase.slice(i,j);
            });
            console.warn('[F43 DEBUG] Todos os grupos vazios; aplicando fatiamento posicional de backup', gruposF43);
          }

          // Se apenas alguns grupos ficaram vazios, ainda assim preencha a partir da lista base
          if (!allEmpty && listaBase.length) {
            const slicesHard = {
              "4.3.1": [0, 2],
              "4.3.2": [2, 3],
              "4.3.3": [3, 6],
              "4.3.4": [6, 8],
              "4.3.5": [8, 9],
              "4.3.6": [9, 10],
              "4.3.7": [10, 18],
              "4.3.8": [18, 19],
              "4.3.9": [19, 20]
            };
            Object.entries(slicesHard).forEach(([k,[i,j]]) => {
              if (!gruposF43[k] || !gruposF43[k].length) {
                gruposF43[k] = listaBase.slice(i, j);
              }
            });
            console.warn('[F43 DEBUG] Grupos parciais; preenchendo vazios com fatiamento posicional', gruposF43);
          }

          // 2) DEBUG opcional para quem estiver carregando o termo em iframe
          try {
            window.parent?.postMessage({
              type: 'F43_DEBUG',
              gruposF43,
              F43_LISTA: p.F43_LISTA,
              F43_LISTA_TXT: p.F43_LISTA_TXT
            }, '*');
          } catch (_) {}

          console.log('[F43 DEBUG] gruposF43=', gruposF43, 'F43_LISTA=', p.F43_LISTA, 'F43_LISTA_TXT=', p.F43_LISTA_TXT);

          // 3) Mapeia cada grupo 4.3.x para sua UL correspondente
          const mapaUL = {
            "4.3.1": "#f43-1",
            "4.3.2": "#f43-2",
            "4.3.3": "#f43-3",
            "4.3.4": "#f43-4",
            "4.3.5": "#f43-5",
            "4.3.6": "#f43-6",
            "4.3.7": "#f43-7",
            "4.3.8": "#f43-8",
            "4.3.9": "#f43-9"
          };

          Object.keys(mapaUL).forEach(k => {
            const sel = mapaUL[k];
            const arr = gruposF43[k] || [];

            console.log('[F43 DEBUG] preenchendo', k, '->', sel, 'itens:', arr);

            const ok = fillList(sel, arr);      // preenche a <ul> com <li>
            const idx = k.split('.').pop();     // "4.3.1" -> "1"
            const sub = document.querySelector('#f43-sub-' + idx);
            if (sub) sub.style.display = ok ? '' : 'none';

            if (ok) {
              haConteudo = true;
              window.__F43_HAS_CONTENT__ = true;
            }
          });

          // Caso nenhuma UL tenha sido preenchida, mas exista listaBase,
          // joga toda a lista em 4.3.1 para n√£o sair vazio no PDF.
          if (!haConteudo && listaBase.length) {
            const okBase = fillList('#f43-1', listaBase);
            if (okBase) {
              console.warn('[F43 DEBUG] Nenhum sub-bloco preenchido; usando listaBase inteira em 4.3.1');
              const sub1 = document.querySelector('#f43-sub-1');
              if (sub1) sub1.style.display = '';
              haConteudo = true;
              window.__F43_HAS_CONTENT__ = true;
            }
          }

          // 4) 4.3.10 ‚Äì Adequa√ß√£o das regras de benef√≠cios (op√ß√µes a / b)
          const op = String(
            p.F4310_OPCAO ||
            p.f4310_opcao ||
            (p.F43_PLANO ? 'a' : '') ||
            (p.F4310_DOCS ? 'b' : '')
          ).trim().toLowerCase();

          const isA = op.includes('adotadas regras') || op.startsWith('a');
          const isB = op.includes('encaminhamento') || op.startsWith('b');

          show("#f43-opcao-a", isA);
          show("#f43-opcao-b", isB);

          if (isA) fillBlock("#val-f4310-leg",  p.F4310_LEGISLACAO);
          if (isB) fillBlock("#val-f4310-docs", p.F4310_DOCS);

          // 5) 4.3.11 ‚Äî Inclus√£o de crit√©rios (fase espec√≠fica ‚Äî 1¬™ parte)
          let show11 = false;

          const inc11 = asArr(
            p.F43_INCLUIR ||
            p['F43_INCLUIR[]'] ||
            p.F43_INCLUIR_TXT ||
            p.F4311_INCLUIR_TXT ||
            ''
          );

          const plano11 =
            p.F43_PLANO ||
            p.F4311_PLANO_TXT ||
            '';

          if (fillList("#f43-crit-incluir", inc11)) show11 = true;
          if (fillBlock("#f43-just-11", plano11))   show11 = true;

          const txt11inc = inc11.length ? inc11.join('; ') : '';
          const el4311Inc = document.getElementById('F4311_INCLUIR_TXT');
          if (el4311Inc && txt11inc) { el4311Inc.textContent = txt11inc; show11 = true; p.F4311_INCLUIR_TXT = txt11inc; }

          const el4311Plano = document.getElementById('F4311_PLANO_TXT');
          if (el4311Plano && plano11) { el4311Plano.textContent = plano11; show11 = true; p.F4311_PLANO_TXT = plano11; }

          show("#f43-sub-11", show11);
          if (show11) haConteudo = true;

          // 6) 4.3.12 ‚Äî Inclus√£o de crit√©rios (fase espec√≠fica ‚Äî 2¬™ parte)
          let show12 = false;

          const inc12 = asArr(
            p.F43_INCLUIR_B ||
            p['F43_INCLUIR_B[]'] ||
            p.F43_INCLUIR_B_TXT ||
            p.F4312_INCLUIR_TXT ||
            ''
          );

          const plano12 =
            p.F43_PLANO_B ||
            p.F4312_PLANO_TXT ||
            '';

          const desc12 =
            p.F43_DESC_PLANOS ||
            p.F4312_DESC_TXT ||
            '';

          if (fillList("#f43-crit-incluir-12", inc12)) show12 = true;
          if (fillBlock("#f43-just-12", plano12)) show12 = true;
          if (fillBlock("#f43-desc-planos-12", desc12)) show12 = true;

          const txt12inc = inc12.length ? inc12.join('; ') : '';
          const el4312Inc = document.getElementById('F4312_INCLUIR_TXT');
          if (el4312Inc && txt12inc) { el4312Inc.textContent = txt12inc; show12 = true; p.F4312_INCLUIR_TXT = txt12inc; }

          const el4312Plano = document.getElementById('F4312_PLANO_TXT');
          if (el4312Plano && plano12) { el4312Plano.textContent = plano12; show12 = true; p.F4312_PLANO_TXT = plano12; }

          const el4312Desc = document.getElementById('F4312_DESC_TXT');
          if (el4312Desc && desc12) { el4312Desc.textContent = desc12; show12 = true; p.F4312_DESC_TXT = desc12; }

          show("#f43-sub-12", show12);
          if (show12) haConteudo = true;

          // 6.1) Caso apenas os textos-resumo (F431_LIST_TXT etc.) estejam
          // preenchidos, garante que o bloco 4.3 n√£o fique oculto.
          if (!haConteudo) {
            const resumidos = [
              '#F431_LIST_TXT','#F432_LIST_TXT','#F433_LIST_TXT','#F434_LIST_TXT',
              '#F435_LIST_TXT','#F436_LIST_TXT','#F437_LIST_TXT','#F438_LIST_TXT',
              '#F439_LIST_TXT',
              '#f43-crit-incluir','#f43-just-11','#F4311_INCLUIR_TXT','#F4311_PLANO_TXT',
              '#f43-crit-incluir-12','#f43-just-12','#f43-desc-planos-12',
              '#F4312_INCLUIR_TXT','#F4312_PLANO_TXT','#F4312_DESC_TXT'
            ];

            const hasResumo = resumidos.some(sel => {
              const el = document.querySelector(sel);
              return el && String(el.textContent || '').trim();
            });

            if (hasResumo) {
              haConteudo = true;
              window.__F43_HAS_CONTENT__ = true;
            }
          }

          // ================== PATCH 2 ‚Äî For√ßa exibi√ß√£o do bloco 4.3 mesmo vazio inicialmente ==================
          if (!haConteudo && (p.F43_LISTA_TXT || (Array.isArray(p.F43_LISTA) && p.F43_LISTA.length))) {
            console.log('[PATCH] For√ßando exibi√ß√£o de #fase-43 mesmo sem subitens detectados');
            const fase43 = document.querySelector('#fase-43');
            if (fase43) {
              fase43.hidden = false;
              fase43.style.display = 'block';
              fase43.setAttribute('data-empty', 'false');
            }
          }

          // 7) Exibe ou oculta o bloco da fase 4.3 como um todo
          const fase = document.querySelector('#fase-43');
          if (fase) {
            fase.hidden = !haConteudo;
            fase.style.display = haConteudo ? 'block' : 'none';
            fase.setAttribute('data-empty', haConteudo ? 'false' : 'true');
          }

        } catch (e) {
          console.error("hydrateF43 ERROR:", e);
        }

        // 8) Fallback textual: se, por qualquer motivo, as ULs ficarem vazias,
        // monta uma lista √∫nica em #f43-fallback usando F43_LISTA_TXT / F43_LISTA.
        try {
          const hadBefore = document.querySelector('#f43-fallback')?.querySelector('li');
          ensureF43Fallback(p);
          const hasFallback = document.querySelector('#f43-fallback')?.querySelector('li');
          if (!haConteudo && hasFallback && !hadBefore) {
            haConteudo = true;
            window.__F43_HAS_CONTENT__ = true;
            const fase = document.querySelector('#fase-43');
            if (fase) {
              fase.hidden = false;
              fase.style.display = 'block';
              fase.setAttribute('data-empty','false');
            }
          }

          // Fallback extra: se 4.3.10 tiver texto e n√É¬£o pintou nos blocos, injeta no fallback
          const opTxt = getVal('F4310_OPCAO','F4310_OPCAO_TXT');
          const legTxt = getVal('F4310_LEGISLACAO','F4310_LEGISLACAO_TXT','F4310_LEG');
          const docTxt = getVal('F4310_DOCS','F4310_DOCS_TXT','F4310_DOC');
          if ((opTxt || legTxt || docTxt) && !window.__F4310_RENDERED__ && !document.querySelector('#f43-opcao-a li') && !document.querySelector('#f43-opcao-b li')) {
            const fb = document.getElementById('f43-fallback');
            if (fb) {
              const li = document.createElement('li');
              li.innerHTML = `<strong>4.3.10</strong> ${[opTxt, legTxt || docTxt].filter(Boolean).join(' - ')}`;
              fb.appendChild(li);
              fb.style.display = '';
              haConteudo = true;
              const fase = document.querySelector('#fase-43');
              if (fase) {
                fase.hidden = false;
                fase.style.display = 'block';
                fase.setAttribute('data-empty','false');
              }
            }
          }
        } catch (_) {}

        // 9) Marca global indicando que a Fase 4.3 j√° foi montada
        // üîç Dispara debug detalhado da Fase 4.3
        try {
          if (window.__debugF43) {
            window.__debugF43(p);
          }
        } catch (e) {
          console.error("[F43 DEBUG] Erro ao executar __debugF43:", e);
        }
      };

      // Fallback: se nenhuma UL de 4.3.1‚Äì4.3.9 receber <li>,
      // monta uma lista √∫nica usando F43_LISTA_TXT ou F43_LISTA.
      function ensureF43Fallback(p) {
        try {
          const ulsSel = [
            '#f43-1','#f43-2','#f43-3',
            '#f43-4','#f43-5','#f43-6',
            '#f43-7','#f43-8','#f43-9'
          ];

          const temLi = ulsSel.some(sel => {
            const ul = document.querySelector(sel);
            return ul && ul.querySelector('li');
          });

          // Se j√° tem itens em alguma UL, n√£o faz nada
          if (temLi) return;
          if (window.__F4310_RENDERED__) return;

          const fb = document.querySelector('#f43-fallback');
          if (!fb) return;

          // Base de texto: primeiro tenta o TXT, depois o array
          const baseTxt = p.F43_LISTA_TXT || '';
          let itens = [];

          if (baseTxt && baseTxt.trim()) {
            itens = asArr(baseTxt);   // usa o mesmo asArr do topo
          } else if (Array.isArray(p.F43_LISTA) && p.F43_LISTA.length) {
            itens = p.F43_LISTA;
          }

          if (!itens.length) return;

          fb.innerHTML =
            '<p class="small"><strong>Crit√©rios selecionados na Fase 4.3:</strong></p>' +
            '<ul class="styled-list">' +
              itens.map(x => `<li>${escapeHtml(x)}</li>`).join('') +
            '</ul>';
        } catch (e) {
          console.error('ensureF43Fallback ERROR:', e);
        }
      }

      function hojeBR_robusto(){
        try{
          const s = new Date().toLocaleDateString('pt-BR');
          if (s && /\d{2}\/\d{2}\/\d{4}/.test(s)) return s;
        }catch(_){}
        return '';
      }

      function normalizarEsfera(txt){
        const t = String(txt||'').toLowerCase();
        if (t.includes('estadual') || t.includes('distrit')) return '1.1.2 RPPS Estadual/Distrital';
        if (t.includes('municip')) return '1.1.1 RPPS Municipal';
        return (typeof __NA_ALL__==='function' && __NA_ALL__()) ? __NA_LABEL__() : '‚Äî';
      }

      // ================== ANCHOR: IN√çCIO run(payload) ‚Äì VERS√ÉO SIMPLIFICADA ==================
      function run(payload) {
        console.log("TERMO: run() iniciado", payload);

        // Se for chamada apenas para "placeholders", n√£o preenche nada
        if (payload && payload.__NA_ALL) {
          console.log('TERMO: payload em modo __NA_ALL (placeholders), saindo de run().');
          return;
        }

        console.log('TERMO: RAW payload recebido:', JSON.stringify(payload));

        // Normaliza chaves, arrays e textos
        const p = normalizePayload(payload || {});
        p.__NA_ALL = false;

        // Guarda c√≥pia global
        window.__TERMO_DATA__ = Object.assign({}, window.__TERMO_DATA__ || {}, p);

        // ================== CAMPOS DE TEXTO SIMPLES (data-k) ==================
        [
          'ente','uf','ug','cnpj_ente','cnpj_ug','email_ente','email_ug',
          'N_GESCON','DATA_ENC_VIA_GESCON','SEI_PROCESSO','PORTARIA_SRPC',
          'ORGAO_VINCULACAO_UG',
          'nome_rep_ente','cargo_rep_ente','cpf_rep_ente','email_rep_ente','tel_rep_ente',
          'nome_rep_ug','cargo_rep_ug','cpf_rep_ug','email_rep_ug','tel_rep_ug',
          'data_vencimento_ultimo_crp','tipo_emissao_ult_crp',
          // Demais fases
          'F44_ANEXOS','F441_LEGISLACAO','F445_DESC_PLANOS',
          'F446_DOCS','F446_EXEC_RES',
          'F45_DOCS','F45_JUST','F453_EXEC_RES',
          'F46_PROGESTAO','F46_PORTE','F46_JUST_D','F46_DOCS_D',
          'F46_JUST_E','F46_DOCS_E','F466_DOCS','F466_EXEC_RES',
          'JUSTIFICATIVAS_GERAIS','data_termo'
        ].forEach(k => {
          const val = p[k] !== undefined ? p[k] : (p[k && k.toUpperCase()] || p[k && k.toLowerCase()]);
          fillText(k, val);
        });

        // ========== 3.4 Prazo adicional ==========
        (function applyPrazoAdicional(code){
          const itens = Array.from(document.querySelectorAll('[data-3_4]'));
          let mostrou = false;
          itens.forEach(el => {
            const tag = (el.getAttribute('data-3_4') || '').trim();
            const ok  = code && tag === code;
            if (ok) { el.style.display = ''; mostrou = true; }
            else { el.remove(); }
          });
          const holder = document.querySelector('[data-k="PRAZO_ADICIONAL_TEXTO"]');
          if (holder) {
            if (mostrou) holder.classList.add('d-none');
            else {
              const txt = p.PRAZO_ADICIONAL_TEXTO || '';
              holder.textContent = txt || '';
              holder.classList.toggle('d-none', !txt.trim());
            }
          }
        })(p.PRAZO_ADICIONAL_COD);

        // ========== 3.3 Crit√©rios irregulares ==========
        fillList('#criterios-list', p.__CRITERIOS_ARR__ || []);

        // ========== 4. FASES DO PROGRAMA ==========
        // Detec√ß√£o de fase selecionada (apenas para fins informativos)
        let faseSel = p.__FASE_SEL__;
        if (!faseSel) {
          if (p.F41_OPCAO_TEXT) faseSel = '4.1';
          else if (p.F42_LISTA && p.F42_LISTA.length) faseSel = '4.2';
          else if (
            (p.F43_LISTA && p.F43_LISTA.length) ||
            (p.F43_INCLUIR && p.F43_INCLUIR.length) ||
            (p.F43_INCLUIR_B && p.F43_INCLUIR_B.length) ||
            p.F43_PLANO || p.F43_PLANO_B || p.F43_DESC_PLANOS
          ) faseSel = '4.3';
          else if (p.F44_DECLS && p.F44_DECLS.length) faseSel = '4.4';
          else if (p.F45_DECLS && p.F45_DECLS.length) faseSel = '4.5';
          else if ((p.F46_DECLS && p.F46_DECLS.length) || (p.F46_CRITERIOS && p.F46_CRITERIOS.length)) faseSel = '4.6';
        }

        // Esconde label "Fase selecionada:" (texto n√£o √© mais cr√≠tico para o PDF)
        const faseTxtEl = document.getElementById('fase-escolhida');
        if (faseTxtEl && faseTxtEl.parentElement) faseTxtEl.parentElement.hidden = true;

        // --- 4.1 ---
        togglePhaseBlock('#fase-41', !!p.F41_OPCAO_TEXT);
        const ul41 = document.querySelector('#f41-itens');
        if (ul41) {
          ul41.innerHTML = p.F41_OPCAO_TEXT
            ? `<li>${escapeHtml(String(p.F41_OPCAO_TEXT))}</li>`
            : '';
        }

        // --- 4.2 ---
        togglePhaseBlock('#fase-42', fillList('#f42-itens', p.F42_LISTA || []));

        // --- 4.3 ---
        // A fase 4.3 √© tratada integralmente pelo hydrateF43, chamado mais abaixo.
        // Fallback r√°pido para garantir exibi√ß√£o do 4.3.10 mesmo sem hydrateF43
        function render4310Block(pLocal){
          const getVal = (...keys) => {
            for (const k of keys) {
              const v = pLocal[k];
              if (v === undefined || v === null) continue;
              if (Array.isArray(v)) {
                const arr = v.filter(Boolean).map(String).map(s=>s.trim()).filter(Boolean);
                if (arr.length) return arr.join('; ');
              }
              const s = String(v).trim();
              if (s) return s;
            }
            return '';
          };

          const op   = getVal('F4310_OPCAO','F4310_OPCAO_TXT','F4310_OPCAO_CODE','f4310_opcao');
          const leg  = getVal('F4310_LEGISLACAO','F4310_LEGISLACAO_TXT','F4310_LEG','f4310_legislacao');
          const docs = getVal('F4310_DOCS','F4310_DOCS_TXT','F4310_DOC','f4310_docs');
          if (!(op || leg || docs)) return false;

          const opNorm = String(op||'').toLowerCase();
          const selA = opNorm.startsWith('a') || (!opNorm && leg);
          const selB = opNorm.startsWith('b') || (!opNorm && docs && !selA);

          const setVal = (sel,val) => { const el = document.querySelector(sel); if (el) el.textContent = val || ''; };
          const show = (sel, on) => { const el = document.querySelector(sel); if (el) { el.hidden = !on; el.style.display = on ? 'block' : 'none'; } };

          show('#f43-opcao-a', selA);
          show('#f43-opcao-b', selB);
          show('#f43-sub-10', true);

          const fase43 = document.querySelector('#fase-43');
          if (fase43) { fase43.hidden = false; fase43.style.display = 'block'; fase43.setAttribute('data-empty','false'); }

          setVal('#val-f4310-leg', selA ? (leg || op) : (leg || ''));
          setVal('#val-f4310-docs', selB ? (docs || op) : (docs || ''));
          window.__F4310_RENDERED__ = true;
          return true;
        }
        render4310Block(p);

        // --- 4.4 ---
        (function(){
          const has =
            fillList('#f44-decls', p.F44_DECLS || []) ||
            fillList('#f44-finalidades', p.F44_FINALIDADES || []) ||
            fillList('#f44-criterios', p.F44_CRITERIOS || []) ||
            !!p.F44_ANEXOS || !!p.F445_DESC_PLANOS || !!p.F446_DOCS || !!p.F446_EXEC_RES;
          togglePhaseBlock('#fase-44', has);
        })();

        // --- 4.5 ---
        (function(){
          const has =
            fillList('#f45-decls', p.F45_DECLS || []) ||
            !!p.F45_DOCS || !!p.F45_JUST || !!p.F453_EXEC_RES;
          togglePhaseBlock('#fase-45', has);
        })();

        // --- 4.6 ---
        (function(){
          const has =
            fillList('#f46-criterios', p.F46_CRITERIOS || []) ||
            fillList('#f46-finalidades', p.F46_FINALIDADES || []) ||
            fillList('#f46-crit-f', p.F462F_CRITERIOS || []) ||
            !!p.F46_PROGESTAO || !!p.F46_PORTE ||
            !!p.F46_JUST_D || !!p.F46_DOCS_D ||
            !!p.F46_JUST_E || !!p.F46_DOCS_E ||
            !!p.F466_DOCS || !!p.F466_EXEC_RES;
          togglePhaseBlock('#fase-46', has);
        })();

        // ========== 5. Justificativas Gerais ==========
        fillText('justificativas_gerais', p.JUSTIFICATIVAS_GERAIS || '');

        // Removido fallback pr√©-hydrate para evitar conte√∫do antes dos t√≠tulos da 4.3

        // ========== 6. Data e assinaturas ==========
        const dataTermo = (p.data_termo || hojeBR_robusto());
        fillText('data_termo', dataTermo);

        // ========== 7. Esfera e legenda de assinatura ==========
        const esferaTxt = normalizarEsfera(p.ESFERA);
        const esferaNode = document.querySelector('[data-esfera]');
        if (esferaNode) esferaNode.textContent = esferaTxt;

        (function(){
          const sig = document.getElementById('sig-cap-ente');
          if (!sig) return;
          const isEstDistr = /Estadual\/Distrital/i.test(esferaTxt);
          sig.innerHTML = isEstDistr
            ? 'Representante legal do Estado/Distrito de <span data-k="ente"></span>/<span data-k="uf"></span>'
            : 'Representante legal do Munic√≠pio de <span data-k="ente"></span>/<span data-k="uf"></span>';
          // Garante preenchimento dos placeholders dentro do caption
          fillText('ente', p.ENTE || p.ente);
          fillText('uf', p.UF || p.uf);
        })();

        // ========== Fase 4.3 ‚Äì chamada definitiva e sincronizada ==========
        try {
          if (window.hydrateF43) {
            console.log('TERMO: adiando execu√ß√£o de hydrateF43 at√© o DOM estar pronto...');
            requestAnimationFrame(() => {
              const payloadFinal = window.__TERMO_DATA__ || p;
              console.log('üî• hydrateF43 AGORA (DOM montado):', payloadFinal);
              window.hydrateF43(payloadFinal);
            });
          }
        } catch (e) {
          console.error('hydrateF43 via run() ERROR:', e);
        }

        // ================== PATCH 1 ‚Äî Execu√ß√£o tardia de seguran√ßa ==================
        setTimeout(() => {
          try {
            const payloadFinal = window.__TERMO_DATA__ || p;
            const fase43 = document.querySelector('#fase-43');
            if (fase43 && window.hydrateF43 && !window.__F43_APPLIED__) {
              console.log('‚öôÔ∏è [PATCH] Rodando hydrateF43 (execu√ß√£o tardia) para garantir preenchimento completo 4.3.1‚Äì4.3.12');
              window.hydrateF43(payloadFinal);
            }
          } catch (e) {
            console.error('[PATCH] Erro na execu√ß√£o tardia de hydrateF43:', e);
          }
        }, 1500);

        // Marca HTML como pronto para impress√£o (sinal para o Apps Script)
        if (!window.__TERMO_READY_FIRED__) {
          window.__TERMO_READY_FIRED__ = true;
          requestAnimationFrame(() => {
            document.documentElement.setAttribute('data-termo-ready','1');
            window.__TERMO_PRINT_READY__ = true;
            try { document.dispatchEvent(new CustomEvent('TERMO_PRINT_READY')); } catch (_) {}
          });
        }
      }
      // ================== ANCHOR: FIM run(payload) ‚Äì VERS√ÉO SIMPLIFICADA ==================

      // DEBUG LOCAL via ?p=
      try {
        const search = window.location && window.location.search;
        if (search && !window.__TERMO_DATA__) {
          const usp = new URLSearchParams(search);
          const pParam = usp.get('p');
          if (pParam) {
            console.group('[TERMO DEBUG] Carregando payload via ?p=');
            let decoded = pParam;
            try { decoded = decodeURIComponent(pParam); } catch (e) {
              console.warn('decodeURIComponent falhou, usando valor bruto de p:', e);
            }
            let json = null;
            try { json = JSON.parse(decoded); } catch (e) {
              console.error('[TERMO DEBUG] Erro ao fazer JSON.parse do par√¢metro p:', e, 'valor=', decoded);
            }
            if (json && typeof json === 'object') {
              console.log('[TERMO DEBUG] Payload parseado com sucesso:', json);
              window.__TERMO_DATA__ = json;
            } else {
              console.warn('[TERMO DEBUG] Par√¢metro ?p= n√£o p√¥de ser interpretado como JSON.');
            }
            console.groupEnd();
          }
        }
      } catch (e) {
        console.warn('[TERMO DEBUG] Falha ao processar par√¢metro ?p=', e);
      }

      // Exposi√ß√£o global
      window.run = run;
      window.__TERMO_RUN__ = run;

      document.addEventListener("TERMO_PRINT_READY", () => {
        if (window.__F43_APPLIED__) return;
        try {
          const p = window.__TERMO_DATA__;
          if (p && window.hydrateF43) {
            console.log("üî• hydrateF43 FINAL ‚Üí Aplicando sobre o HTML j√° montado");
            requestAnimationFrame(() => {
              try {
                window.hydrateF43(p);
                window.__F43_APPLIED__ = true; // marca sucesso
              } catch (e) {
                window.__F43_APPLIED__ = false; // permite nova tentativa
                console.error("hydrateF43 final ERROR:", e);
              }
            });
          }
        } catch(e){
          console.error("hydrateF43 final ERROR:", e);
        }
      });

      document.addEventListener('TERMO_DATA_READY', () => { try { run(window.__TERMO_DATA__ || {}); } catch(e){ console.error(e);} });
      document.addEventListener('TERMO_DATA',       () => { try { run(window.__TERMO_DATA__ || {}); } catch(e){ console.error(e);} });
      setTimeout(() => {
        // S√≥ executa automaticamente se J√Å houver payload real.
        // N√£o usa mais {__NA_ALL:true} pra n√£o poluir com "N√£o informado".
        if (!window.__TERMO_READY_FIRED__ && window.__TERMO_DATA__) {
          run(window.__TERMO_DATA__);
        }
      }, 800);
    })();
</script>

<script>
// === Rebuild & hydrate Fase 4.3 (robusto) ===
(function(){
  const norm = (s) => String(s || '')
    .normalize('NFD')
    .replace(/[\u0300-\u036f]/g, '')
    .toLowerCase();

  const asArr = (v) => {
    const out = [];
    if (Array.isArray(v)) {
      v.forEach(x => out.push(...asArr(x)));
    } else if (typeof v === 'string') {
      String(v).split(/[\n;]+/).forEach(p => {
        const t = p.trim();
        if (t) out.push(t);
      });
    }
    return out;
  };

  const asStr = (v, sep = '; ') => asArr(v).join(sep);

  const clean = (s) => String(s || '')
    .replace(/^[\s\-\d\.\)]+/,'')
    .replace(/^[a-h]\)\s*/i,'')
    .trim();

  function __reconstruirF43(payload = {}) {
    const uniq = (arr) => Array.from(new Set((arr || []).map(v => String(v || '').trim()).filter(Boolean)));

    const src = [];
    const grab = (...keys) => keys.forEach(k => {
      const v = payload[k];
      if (v === undefined || v === null) return;
      if (Array.isArray(v)) src.push(...v);
      else if (typeof v === 'string' && v.trim()) src.push(v);
    });

    grab(
      'F43_LISTA','F43_LISTA[]','F43_LISTA_TXT','F43_LISTA[][]',
      'fase4_3_criterios','fase4_3_criterios[]','fase4_3_criterios_txt',
      'F43_ITENS','F43_ITENS[]','F43_ITENS[][]',
      'F431_LIST_TXT','F432_LIST_TXT','F433_LIST_TXT','F434_LIST_TXT','F435_LIST_TXT','F436_LIST_TXT','F437_LIST_TXT','F438_LIST_TXT','F439_LIST_TXT',
      'F43_INCLUIR','F43_INCLUIR[]','F43_INCLUIR_B','F43_INCLUIR_B[]','F43_INCLUIR_TXT','F43_INCLUIR_B_TXT',
      'F43_PLANO','F43_PLANO_B','F43_DESC_PLANOS'
    );

    [
      'F43_1','F43_1_TXT','F43_2',
      'F43_3_A','F43_3_B','F43_3_C',
      'F43_4_A','F43_4_B',
      'F43_5','F43_6',
      'F43_7_A','F43_7_B','F43_7_C','F43_7_D','F43_7_E','F43_7_F','F43_7_G','F43_7_H',
      'F43_8','F43_9'
    ].forEach(grab);

    const base = uniq(asArr(src).map(clean).filter(Boolean));
    const used = new Set();
    const groups = Array.from({ length: 9 }, () => []);

    const match = (txt, kws) => kws.every(w => norm(txt).includes(w));

    base.forEach((item, idx) => {
      const n = norm(item);
      const push = (i) => { groups[i].push(item); used.add(idx); };

      if (match(item, ['dipr']) && (n.includes('contrib') || n.includes('repasse') || n.includes('aporte') || n.includes('parcel'))) { push(0); return; }
      if (match(item, ['utilizacao','recursos','previd'])) { push(1); return; }
      if (n.includes('aplic') || n.includes('dair') || n.includes('dpin')) { push(2); return; }
      if (n.includes('limite') && n.includes('contrib')) { push(3); return; }
      if (n.includes('plano de beneficios') || n.includes('rol de beneficios')) { push(4); return; }
      if (n.includes('previdencia complementar') || n.includes('rpc')) { push(5); return; }
      if (n.includes('solicitacao') || n.includes('fiscalizacao') || n.includes('equilibrio') || n.includes('matriz de saldos') || n.includes('draa') || n.includes('nta') || n.includes('esocial')) { push(6); return; }
      if (n.includes('compensacao previdenciaria') || n.includes('empresa de tecnologia')) { push(7); return; }
      if (n.includes('dirigent') || n.includes('conselho') || n.includes('comite')) { push(8); return; }
    });

    // Permite mais itens em 4.3.8 e 4.3.9 para evitar envio ao "resto"
    const expected = [2,1,3,2,1,1,8,2,2];
    const remaining = base.filter((_, idx) => !used.has(idx));

    groups.forEach((g, i) => {
      if (g.length > expected[i]) {
        const extra = g.splice(expected[i]);
        remaining.push(...extra);
      }
      if (g.length < expected[i] && remaining.length) {
        g.push(...remaining.splice(0, expected[i] - g.length));
      }
    });

    const resto = remaining;

    // dedup grupos
    groups.forEach((g, idx) => { groups[idx] = uniq(g); });

    const mapa = {
      "4.3.1": groups[0],
      "4.3.2": groups[1],
      "4.3.3": groups[2],
      "4.3.4": groups[3],
      "4.3.5": groups[4],
      "4.3.6": groups[5],
      "4.3.7": groups[6],
      "4.3.8": groups[7],
      "4.3.9": groups[8]
    };

    if (window.__DEBUG_SOLIC_CRP__) {
      console.log('[DEBUG_F43_RECON] grupos finais', { mapa, resto, base });
    }

    return {
      ...mapa,
      grupos: mapa,
      grupo1: groups[0],
      grupo2: groups[1],
      grupo3: groups[2],
      grupo4: groups[3],
      grupo5: groups[4],
      grupo6: groups[5],
      grupo7: groups[6],
      grupo8: groups[7],
      grupo9: groups[8],
      resto,
      listaBase: base,
      gruposArr: groups
    };
  }

  function hydrateF43(p) {
    p = p || {};
    const data = __reconstruirF43(p);
    const uniq = (arr) => Array.from(new Set((arr || []).map(v => String(v || '').trim()).filter(Boolean)));
    // Clona o resto para permitir filtragem (ex.: reaproveitar item 4.3.10)
    let restoArr = Array.isArray(data.resto)
      ? data.resto.slice()
      : (data.resto ? asArr(data.resto) : []);

    const fillList = (sel, arr) => {
      const el = document.querySelector(sel);
      if (!el) return;
      const items = uniq(arr);
      if (!items.length) { el.innerHTML = ''; el.dataset.empty = '1'; return; }
      el.innerHTML = arr.map(x => `<li>${x}</li>`).join('');
      delete el.dataset.empty;
    };
    const setVal = (sel, val) => {
      const el = document.querySelector(sel);
      if (el) el.textContent = val || '';
    };
    const show = (sel, cond) => {
      const el = document.querySelector(sel);
      if (!el) return;
      if (cond) {
        el.hidden = false;
        el.removeAttribute('hidden');
        el.style.display = '';
        delete el.dataset.empty;
      } else {
        el.hidden = true;
        el.style.display = 'none';
        el.dataset.empty = '1';
      }
    };
    const mkTxt = (v) => asStr(v);

    const groups = [
      data.grupo1,data.grupo2,data.grupo3,
      data.grupo4,data.grupo5,data.grupo6,
      data.grupo7,data.grupo8,data.grupo9
    ];

    if (window.__DEBUG_SOLIC_CRP__) {
      console.log('[DEBUG_F43_HYDRATE_V2] grupos reconstruidos', {
        groups,
        resto: data.resto,
        listaBase: data.listaBase
      });
    }

    groups.forEach((g, i) => {
      fillList(`#f43-${i+1}`, g);
      const txt = mkTxt(g);
      p[`F43${i+1}_LIST_TXT`] = txt;
      setVal(`#F43${i+1}_LIST_TXT`, txt);
    });

    fillList('#f43-fallback', restoArr);
    // HTML usa <div id="f43-fallback"> (sem "-wrap"); ajustar selector para exibir o texto
    show('#f43-fallback', !!(restoArr && restoArr.length));

    const anyList = groups.some(g => g && g.length) || (restoArr && restoArr.length);

    const getVal = (...keys) => {
      for (const k of keys) {
        const v = p[k];
        if (v === undefined || v === null) continue;
        if (Array.isArray(v)) {
          const arr = asArr(v);
          if (arr.length) return arr.join('; ');
        }
        const s = String(v).trim();
        if (s) return s;
      }
      return '';
    };

    // 4.3.10 (A/B)
    let op = getVal('F4310_OPCAO_CODE','F4310_OPCAO','F4310_OPCAO_TXT','f4310_opcao');
    const legVal = getVal('F4310_LEGISLACAO','F4310_LEGISLACAO_TXT','F4310_LEG','f4310_legislacao','F4310_FALLBACK_TXT');
    const docsVal = getVal('F4310_DOCS','F4310_DOCS_TXT','F4310_DOC','f4310_docs','F4310_FALLBACK_TXT');
    const fallback4310 = getVal('F4310_FALLBACK_TXT');
    let has4310 = !!(op || legVal || docsVal || fallback4310);
    const opNorm = String(op || '').trim().toLowerCase();
    console.info('[PDF 4.3.10]', { opRaw: op, opNorm, leg: legVal, docs: docsVal });
    console.info('[PDF 4.3.10 FULL PAYLOAD SNAPSHOT]', {
      F4310_OPCAO: p.F4310_OPCAO,
      F4310_OPCAO_TXT: p.F4310_OPCAO_TXT,
      F4310_OPCAO_CODE: p.F4310_OPCAO_CODE,
      F4310_LEGISLACAO: p.F4310_LEGISLACAO,
      F4310_LEGISLACAO_TXT: p.F4310_LEGISLACAO_TXT,
      F4310_DOCS: p.F4310_DOCS,
      F4310_DOCS_TXT: p.F4310_DOCS_TXT,
      F43_LISTA: p.F43_LISTA,
      F43_LISTA_TXT: p.F43_LISTA_TXT
    });

    const hasLeg = !!legVal;
    const hasDocs = !!docsVal;
    let selA = opNorm.startsWith('a') || opNorm.includes('adotadas regras') || (!opNorm && hasLeg);
    let selB = opNorm.startsWith('b') || opNorm.includes('encaminhamento') || (!opNorm && hasDocs && !selA);

    // Se n√£o h√° dados expl√≠citos mas sobrou algo em "resto", usa como texto do 4.3.10 (bloco A)
    let resto4310 = '';
    if (!has4310 && restoArr.length) {
      const idx = restoArr.findIndex(t => /4\.?3\.?10/i.test(String(t || '')));
      if (idx >= 0) {
        resto4310 = restoArr.splice(idx, 1)[0];
      } else {
        resto4310 = restoArr.join('; ');
        restoArr = [];
      }
      if (resto4310) {
        has4310 = true;
        selA = true;
      }
    }

    if (!selA && !selB && (hasLeg || hasDocs || opNorm)) selA = true;
    if (!selA && !selB && (fallback4310 || resto4310)) selA = true; // fallback text vai para A
    if (!selA && !selB && !(hasLeg || hasDocs || opNorm || fallback4310 || resto4310)) {
      console.warn('[PDF 4.3.10] nenhum bloco exibido (sem dados)');
    }

    const blocoA = document.querySelector('#f43-opcao-a');
    const blocoB = document.querySelector('#f43-opcao-b');
    if (blocoA) { blocoA.hidden = !selA; blocoA.style.display = selA ? 'block' : 'none'; }
    if (blocoB) { blocoB.hidden = !selB; blocoB.style.display = selB ? 'block' : 'none'; }

    const txtA = hasLeg ? legVal : (selA ? (op || fallback4310 || resto4310 || '') : '');
    const txtB = hasDocs ? docsVal : '';
    setVal('#val-f4310-leg', txtA);
    setVal('#val-f4310-docs', txtB);

    // garante que o bloco 4.3.10 fique vis√≠vel se houver dados (inclui fallback)
    const sub10 = document.getElementById('f43-sub-10');
    if (sub10 && (op || hasLeg || hasDocs || fallback4310)) {
      sub10.hidden = false;
      sub10.style.display = 'block';
    }

    // Fallback final: se chegamos at√© aqui sem pintar nada vis√≠vel, injeta texto bruto logo no bloco A
    const renderedA = document.querySelector('#val-f4310-leg')?.textContent?.trim();
    const renderedB = document.querySelector('#val-f4310-docs')?.textContent?.trim();
    if (has4310 && !renderedA && !renderedB) {
      const raw4310 = [op, legVal, docsVal, fallback4310, resto4310]
        .filter(Boolean)
        .join(' - ');
      if (raw4310) {
        selA = true; selB = false;
        if (blocoA) { blocoA.hidden = false; blocoA.style.display = 'block'; }
        if (blocoB) { blocoB.hidden = true; blocoB.style.display = 'none'; }
        setVal('#val-f4310-leg', raw4310);
      }
    }

    if (has4310) {
      window.__F4310_RENDERED__ = true;
      const fase43 = document.querySelector('#fase-43');
      if (fase43) {
        fase43.hidden = false;
        fase43.style.display = 'block';
        fase43.setAttribute('data-empty','false');
      }
      // Apenas empurra para o fallback se nenhum bloco A/B tiver sido exibido
      if (!selA && !selB) {
        const fb = document.getElementById('f43-fallback');
        if (fb) {
          const txt4310 = [op, legVal || docsVal].filter(Boolean).join(' - ') || 'Informa√ß√µes do item 4.3.10';
          const ul = fb.querySelector('ul') || (() => { const u=document.createElement('ul'); fb.appendChild(u); return u; })();
          const li = document.createElement('li');
          li.innerHTML = `<strong>4.3.10</strong> ${txt4310}`;
          ul.appendChild(li);
          fb.style.display = '';
        }
      }
    } else {
      // fallback de √∫ltimo recurso: se por algum motivo os campos vierem vazios, exibe placeholder claro
      const fb = document.getElementById('f43-fallback');
      if (fb) {
        const ul = fb.querySelector('ul') || (() => { const u=document.createElement('ul'); fb.appendChild(u); return u; })();
        const li = document.createElement('li');
        li.innerHTML = `<strong>4.3.10</strong> Informa√ß√µes n√£o fornecidas (verificar preenchimento)`;
        ul.appendChild(li);
        fb.style.display = '';
      }
    }

    // Loga o estado final do 4.3.10 no template (para saber se o PDF leu este arquivo).
    (function log4310Rendered() {
      const aBlock = document.querySelector('#f43-opcao-a');
      const bBlock = document.querySelector('#f43-opcao-b');
      const logPayload = {
        opFinal: op,
        legFinal: document.querySelector('#val-f4310-leg')?.textContent || '',
        docsFinal: document.querySelector('#val-f4310-docs')?.textContent || '',
        aVisible: !!(aBlock && aBlock.style.display !== 'none' && !aBlock.hidden),
        bVisible: !!(bBlock && bBlock.style.display !== 'none' && !bBlock.hidden),
        fbHas4310: !!document.querySelector('#f43-fallback li strong')
      };
      try {
        console.info('[PDF 4.3.10 rendered]', logPayload);
      } catch (_e) {
        /* ignore console failure in some PDF engines */
      }
    })();

    // 4.3.11
    const incluir = asArr(getVal('F43_INCLUIR','F43_INCLUIR_TXT','F4311_INCLUIR_TXT','F43_INCLUIR[]'));
    const plano = getVal('F43_PLANO','F4311_PLANO_TXT');
    const just11 = getVal('F43_JUST','F4311_JUST_TXT');
    fillList('#f43-crit-incluir', incluir);
    setVal('#f43-just-11', plano || just11);
    p.F4311_INCLUIR_TXT = asStr(incluir);
    p.F4311_PLANO_TXT = plano;
    const has11 = incluir.length || plano || just11;
    show('#f43-sub-11', !!has11);

    // 4.3.12
    const incluirB = asArr(getVal('F43_INCLUIR_B','F43_INCLUIR_B_TXT','F4312_INCLUIR_TXT','F43_INCLUIR_B[]'));
    const planoB = getVal('F43_PLANO_B','F4312_PLANO_TXT');
    const desc12 = getVal('F43_DESC_PLANOS','F4312_DESC_TXT');
    const just12 = getVal('F4312_JUST_TXT');
    fillList('#f43-crit-incluir-12', incluirB);
    setVal('#f43-just-12', planoB || just12);
    setVal('#f43-desc-planos-12', desc12);
    p.F4312_INCLUIR_TXT = asStr(incluirB);
    p.F4312_PLANO_TXT = planoB;
    p.F4312_DESC_TXT = desc12;
    const has12 = incluirB.length || planoB || desc12 || just12;
    show('#f43-sub-12', !!has12);

    // Se j√° temos listas principais, limpamos qualquer fallback residual para evitar duplica√ß√£o ou deslocamento visual
    if (anyList) {
      const fb = document.getElementById('f43-fallback');
      if (fb) {
        fb.innerHTML = '';
        fb.style.display = 'none';
        fb.dataset.empty = '1';
      }
    }

    const any = anyList || has11 || has12 || has4310;
    show('#fase-43', !!any);
    if (!any) document.querySelector('#fase-43')?.setAttribute('data-empty','1');

    window.__F43_LAST__ = data;
    return data;
  }

  window.__reconstruirF43 = __reconstruirF43;
  window.hydrateF43 = hydrateF43;
  // Fallback para exibir os crit√©rios 4.3 quando o template n√£o preencher via data-k
  window.ensureF43Fallback = function ensureF43Fallback(payload){
    try{
      const box = document.getElementById('f43-fallback');
      if (!box) return;
      if (window.__F4310_RENDERED__) return;

      const splitTxt = (txt='') => String(txt)
        .split(/;|\n/)
        .map(s => s.trim())
        .filter(Boolean);

      const escapeHtml = (s='') => String(s)
        .replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;').replace(/'/g,'&#39;');

      let itens = [];
      if (payload && Array.isArray(payload?.resto) && payload.resto.length) {
        itens = payload.resto.filter(Boolean);
      } else if (payload && typeof payload?.resto === 'string' && payload.resto.trim()) {
        itens = splitTxt(payload.resto);
      } else if (payload && Array.isArray(payload?.F43_LISTA) && payload.F43_LISTA.length) {
        itens = payload.F43_LISTA.filter(Boolean);
      } else if (payload && payload.F43_LISTA_TXT) {
        itens = splitTxt(payload.F43_LISTA_TXT);
      }

      // Inclui 4.3.10 se houver dados
      const opTxt = payload?.F4310_OPCAO || payload?.F4310_OPCAO_TXT || '';
      const legTxt = payload?.F4310_LEGISLACAO || payload?.F4310_LEGISLACAO_TXT || payload?.F4310_LEG || '';
      const docTxt = payload?.F4310_DOCS || payload?.F4310_DOCS_TXT || payload?.F4310_DOC || '';
      if (opTxt || legTxt || docTxt) {
        itens.push(`<strong>4.3.10</strong> ${[opTxt, legTxt || docTxt].filter(Boolean).join(' - ')}`);
      }

      if (!itens.length) {
        box.style.display = 'none';
        return;
      }

      box.innerHTML = `
        <p class="small mb-1"><strong>Crit√©rios selecionados na Fase 4.3:</strong></p>
        <ul class="mb-2">
          ${itens.map(t => `<li>${escapeHtml(t)}</li>`).join('')}
        </ul>
      `;
      box.style.display = '';
    }catch(e){
      console.error('[termo_solic_crp] ensureF43Fallback fail', e);
    }
  };
})();
</script>
<!-- Fallback render para 4.3.x caso o template n√£o esteja populando as respostas -->
<script>
(() => {
  if (window.__F43_ULT_FALLBACK__) return;
  window.__F43_ULT_FALLBACK__ = true;

  const toArr = (v) => Array.isArray(v) ? v.filter(Boolean) : (v ? [String(v)] : []);

  function renderFallback(p) {
    const root = document.querySelector('#fase-43') || document.body;
    if (!root) return;

    let box = document.getElementById('f43-ultimate-fallback');
    if (!box) {
      box = document.createElement('div');
      box.id = 'f43-ultimate-fallback';
      box.style.padding = '8px 12px';
      box.style.marginTop = '8px';
      box.style.border = '1px dashed #999';
      box.style.fontSize = '13px';
      root.appendChild(box);
    }

    const lines = [];
    const lista43 = toArr(p.F43_LISTA || p['F43_LISTA[]']);
    if (lista43.length) lines.push('<strong>4.3.1‚Äì4.3.9</strong><br>' + lista43.join('; '));

    const op4310 = [p.F4310_OPCAO || p.F4310_OPCAO_TXT, p.F4310_LEGISLACAO || p.F4310_LEG, p.F4310_DOCS || p.F4310_DOC]
      .filter(Boolean).join(' ‚Äì ');
    if (!op4310) console.warn('[PDF 4.3.10 ultimate fallback] vazio', { F4310_OPCAO: p.F4310_OPCAO, F4310_OPCAO_TXT: p.F4310_OPCAO_TXT, F4310_LEG: p.F4310_LEG, F4310_DOC: p.F4310_DOC });
    if (op4310) lines.push('<strong>4.3.10</strong><br>' + op4310);

    const inclA = p.F43_INCLUIR || toArr(p['F43_INCLUIR[]']).join('; ');
    if (inclA) lines.push('<strong>4.3.11</strong><br>' + inclA);

    const inclB = p.F43_INCLUIR_B || toArr(p['F43_INCLUIR_B[]']).join('; ');
    if (inclB) lines.push('<strong>4.3.12</strong><br>' + inclB);

    if (!lines.length) {
      box.innerHTML = '';
      box.style.display = 'none';
      return;
    }

    box.style.display = '';
    if (root.hasAttribute('data-empty')) root.removeAttribute('data-empty');
    box.innerHTML =
      '<div style="font-weight:600">Resumo 4.3 (fallback)</div>' +
      lines.map((l) => `<div style="margin-top:4px">${l}</div>`).join('');
  }

  const trigger = () => renderFallback(window.__TERMO_DATA__ || {});
  document.addEventListener('TERMO_DATA', trigger);
  setTimeout(trigger, 300);
  setTimeout(trigger, 900);
})();
</script>

<!-- Inje√ß√£o final para exibir 4.3.10 mesmo em templates/rotas antigas -->
<script>
(() => {
  function render4310() {
    try {
      const p = window.__TERMO_DATA__ || {};
      if (window.__F4310_RENDERED__) return;
      const txt4310 =
        p.F4310_FALLBACK_TXT ||
        p.F4310_LEGISLACAO_TXT || p.F4310_LEGISLACAO || p.F4310_LEG ||
        p.F4310_DOCS_TXT || p.F4310_DOCS || p.F4310_DOC ||
        '';
      if (!txt4310) return;

      const fase43 = document.querySelector('#fase-43');
      if (fase43) {
        fase43.hidden = false;
        fase43.style.display = 'block';
        fase43.setAttribute('data-empty','false');
      }

      const fb = document.getElementById('f43-fallback') || fase43 || document.body;
      const ul = fb.querySelector('ul') || (() => { const u=document.createElement('ul'); fb.appendChild(u); return u; })();
      const li = document.createElement('li');
      li.innerHTML = `<strong>4.3.10</strong> ${txt4310}`;
      ul.appendChild(li);
      fb.style.display = '';
    } catch(e) {
      console.warn('[PDF 4.3.10 ultimate inject] falha', e);
    }
  }
  document.addEventListener('TERMO_DATA', render4310);
  document.addEventListener('TERMO_DATA_READY', render4310);
  setTimeout(render4310, 500);
})();
</script>
</body>
</html>
