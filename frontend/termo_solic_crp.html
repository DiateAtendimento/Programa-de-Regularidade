<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Termo de Solicitação de CRP Emergencial</title>

  <!-- Fonte apenas para PREVIEW em tela (o PDF usa Rawline do CSS local) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Montserrat:wght@600;700&display=swap" rel="stylesheet">

  <!-- Estilos oficiais do termo (usa Rawline no PDF) -->
  <link rel="stylesheet" href="./termo_solic_crp.css">
  
</head>

<body>
  <!-- Cabeçalho FIXO (anti-sobreposição em 2+ páginas) -->
  <header class="prp-header" aria-hidden="true">
    <div class="logos-wrap">
      <img src="./imagens/logo-secretaria-complementar.svg" alt="Secretaria" loading="eager" />
      <img src="./imagens/logo-termo-drpps.svg" alt="Departamento de RPPS" loading="eager" />
    </div>
  </header>
  <div id="pdf-root">
    <main class="term-wrap prp-content">
      <h1 class="term-title">
        <br>TERMO DE SOLICITAÇÃO DE CRP EMERGENCIAL<br>
        PROGRAMA DE REGULARIDADE PREVIDENCIÁRIA<br>
      </h1>

      <p class="term-meta">
        Ente: <strong data-k="ente"></strong> / UF: <strong data-k="uf"></strong> • UG: <strong data-k="ug"></strong>
      </p>

      <!-- 1. IDENTIFICAÇÃO -->
      <section class="term-section avoid-break">
        <h2><br>1. IDENTIFICAÇÃO DO ENTE FEDERATIVO E DA UNIDADE GESTORA</h2>

        <h3><span class="label">1.1 Esfera de Governo</span></h3>
        <div class="linha">
          <div class="titulo"></div>
          <div class="valor" data-esfera></div>
        </div>

        <h3><strong>1.2 Ente Federativo</strong></h3>
        <div class="grid grid-num">
          <div class="field"><span class="label"><strong>1.2.1 Ente</strong></span><span class="value" data-k="ente"></span></div>
          <div class="field"><span class="label"><strong>1.2.2 CNPJ</strong></span><span class="value" data-k="cnpj_ente"></span></div>
          <div class="field"><span class="label"><strong>1.2.3 E-mail oficial</strong></span><span class="value" data-k="email_ente"></span></div>
        </div>

        <h3><strong>1.3 Regime Próprio de Previdência Social (RPPS)</strong></h3>
        <div class="grid grid-num">
          <div class="field"><span class="label"><strong>1.3.1 Unidade Gestora</strong></span><span class="value" data-k="ug"></span></div>
          <div class="field"><span class="label"><strong>1.3.2 CNPJ</strong></span><span class="value" data-k="cnpj_ug"></span></div>
          <div class="field"><span class="label"><strong>1.3.3 E-mail oficial</strong></span><span class="value" data-k="email_ug"></span></div>
          <div class="field"><span class="label"><strong>1.3.4 Órgão de vinculação da UG</strong></span><span class="value" data-k="ORGAO_VINCULACAO_UG"></span></div>
        </div>
      </section>

      <!-- 2. IDENTIFICAÇÃO DOS RESPONSÁVEIS -->
      <section class="term-section avoid-break">
        <h2>2. IDENTIFICAÇÃO DOS RESPONSÁVEIS</h2>

        <h3><strong>2.1 Representante legal do ente federativo</strong></h3>
        <div class="grid grid-num">
          <div class="field"><span class="label"><strong>2.1.1 Nome</strong></span><span class="value" data-k="nome_rep_ente"></span></div>
          <div class="field"><span class="label"><strong>2.1.2 Cargo/Função</strong></span><span class="value" data-k="cargo_rep_ente"></span></div>
          <div class="field"><span class="label"><strong>2.1.3 CPF</strong></span><span class="value" data-k="cpf_rep_ente"></span></div>
          <div class="field"><span class="label"><strong>2.1.4 E-mail</strong></span><span class="value" data-k="email_rep_ente"></span></div>
          <div class="field"><span class="label"><strong>2.1.5 Telefone</strong></span><span class="value" data-k="tel_rep_ente"></span></div>
        </div>

        <h3>2.2 Representante legal do RPPS</h3>
        <div class="grid grid-num">
          <div class="field"><span class="label"><strong>2.2.1 Nome</strong></span><span class="value" data-k="nome_rep_ug"></span></div>
          <div class="field"><span class="label"><strong>2.2.2 Cargo/Função</strong></span><span class="value" data-k="cargo_rep_ug"></span></div>
          <div class="field"><span class="label"><strong>2.2.3 CPF</strong></span><span class="value" data-k="cpf_rep_ug"></span></div>
          <div class="field"><span class="label"><strong>2.2.4 E-mail</strong></span><span class="value" data-k="email_rep_ug"></span></div>
          <div class="field"><span class="label"><strong>2.2.5 Telefone</strong></span><span class="value" data-k="tel_rep_ug"></span></div>
        </div>
      </section>
      <!-- 3. SITUAÇÃO RELATIVA AO CRP -->
      <section class="term-section avoid-break page-break" id="sec-3">
        <h2>3. SITUAÇÃO RELATIVA AO CERTIFICADO DE REGULARIDADE PREVIDENCIÁRIA (CRP)</h2>

        <!-- 3.1 -->
        <div class="grid grid-num">
          <div class="field">
            <span class="label"><strong>3.1 Data de vencimento do último CRP</strong></span>
            <span class="value" data-k="venc_ult_crp"></span>
          </div>
        </div>

        <!-- 3.2 -->
        <div class="grid grid-num">
          <div class="field">
            <span class="label"><strong>3.2 Tipo de emissão do último CRP</strong></span>
            <span class="value" data-k="tipo_emissao_ult_crp"></span>
          </div>
        </div>

        <!-- 3.3 -->
        <h3>3.3 Critério(s) atualmente irregular(es) no extrato previdenciário</h3>
        <p class="small">Selecione todos os itens apontados como irregulares no extrato.</p>
        <ul id="criterios-list"></ul>

        <h3>3.4 Solicitação de Prazo Adicional</h3>
        <p class="small no-print">Será exibida apenas a alternativa selecionada no formulário.</p>

        <ul id="opt-3-4">
          <li data-prz="3.4.1"><strong>3.4.1 Manutenção da conformidade</strong></li>
          <li data-prz="3.4.2"><strong>3.4.2 Equacionamento do déficit atuarial (ou necessidade de prazo adicional para implementar)</strong></li>
          <li data-prz="3.4.3"><strong>3.4.3 Organização do RPPS conforme critérios estruturantes (inclui art. 40, § 20, CF)</strong></li>
          <li data-prz="3.4.4"><strong>3.4.4 Outro critério que apresente (ou possa apresentar) maior complexidade</strong></li>
        </ul>


        <!-- Opcional: espaço para inserir o texto exato do rádio selecionado (PRAZO_ADICIONAL_TEXTO) -->
        <p id="prz_3_4_escolha"></p>

      </section>


      <!-- 4. FASE DO PROGRAMA -->
      <section class="term-section avoid-break">
        <h2>4. IDENTIFICAÇÃO DA FASE DO PROGRAMA DE REGULARIDADE PREVIDENCIÁRIA</h2>
        <p class="small">Fase selecionada: <strong data-k="fase_programa"></strong></p>

        <!-- 4.1 -->
        <div class="avoid-break" id="fase-41" hidden>
          <h3>4.1 Fase Geral/Introdutória – 1º CRP Emergencial</h3>
          <ul id="f41-itens"></ul>
        </div>

        <!-- 4.2 -->
        <div class="avoid-break" id="fase-42" hidden>
          <h3>4.2 Fase Geral/Introdutória – 2º CRP Emergencial</h3>
          <p class="small">Condições declaradas:</p>
          <ul id="f42-itens"></ul>
        </div>

        <!-- 4.3 -->
        <div class="avoid-break" id="fase-43" hidden>
          <h3>4.3 Fase Intermediária/Preparatória – 3º CRP Emergencial</h3>
          <ul id="f43-itens"></ul>
          <p class="small mt"><strong>4.3.10 Justificativas/Informações adicionais:</strong></p>
          <p data-k="f43_just"></p>
          <p class="small mt"><strong>4.3.11 Inclusões sugeridas nos Planos de Ação da Fase Específica:</strong></p>
          <p data-k="f43_plano"></p>
          
        </div>
        <!-- 4.4 -->
        <div class="avoid-break" id="fase-44" hidden>
          <h3>4.4 Fase Específica/Focalizada – 4º CRP Emergencial</h3>
          <p class="small"><strong>4.4.1 Critério(s) do extrato objeto do(s) Plano(s) de Ação:</strong></p>
          <ul id="f44-criterios"></ul>

          <p class="small mt"><strong>4.4.2 Declarações:</strong></p>
          <ul id="f44-decls"></ul>

          <p class="small mt"><strong>4.4.3 Finalidade do(s) Plano(s) de Ação:</strong></p>
          <ul id="f44-finalidades"></ul>
          <p class="small mt"><strong>4.4.1(d) Legislação:</strong> <span data-k="f441_legislacao"></span></p>

          <p class="small mt"><strong>4.4.6 Documentos:</strong></p>
          <div id="f446-docs"></div>

          <p class="small mt"><strong>4.4.6 Execução/Resultados:</strong></p>
          <div id="f446-exec"></div>

          <p class="small mt"><strong>4.4.4 Anexos:</strong></p>
          <div id="f44-anexos"></div>
        </div>

        <!-- 4.5 -->
        <div class="avoid-break" id="fase-45" hidden>
          <h3>4.5 Fase Específica/Focalizada – 5º CRP Emergencial</h3>
          <ul id="f45-decls"></ul>
          <p class="small mt"><strong>4.5.2/4.5.3 Documentos:</strong></p>
          <div id="f45-docs"></div>
          <p class="small mt"><strong>4.5.4 Justificativas:</strong></p>
          <div id="f45-just"></div>
        </div>

        <!-- 4.6 -->
        <div class="avoid-break" id="fase-46" hidden>
          <h3>4.6 Fase de Manutenção da Conformidade</h3>
          <p class="small"><strong>4.6.1 Critério(s) objeto do(s) Plano(s) de Ação:</strong></p>
          <ul id="f46-criterios"></ul>

          <p class="small mt"><strong>4.6.2 Declarações e informações:</strong></p>
          <ul id="f46-decls"></ul>

          <p class="small mt"><strong>4.6.2(f) Critérios:</strong></p>
          <ul id="f462f-criterios"></ul>

          <p class="small mt"><strong>Documentos adicionais (4.6):</strong></p>
          <div id="f466-docs"></div>

          <p class="small mt"><strong>Execução/Resultados adicionais (4.6):</strong></p>
          <div id="f466-exec"></div>


          <p class="small mt"><strong>4.6.3 Finalidade do(s) Plano(s) de Ação:</strong></p>
          <ul id="f46-finalidades"></ul>

          <p class="small mt"><strong>4.6.4 Anexos:</strong></p>
          <div id="f46-anexos"></div>

          <p class="small mt"><strong>4.6.5 Justificativas quanto ao(s) Plano(s) de Ação:</strong></p>
          <div id="f46-just-planos"></div>
        </div>
      </section>

      <!-- 5. JUSTIFICATIVAS GERAIS -->
      <section class="term-section avoid-break">
        <h2>5. JUSTIFICATIVAS / INFORMAÇÕES ADICIONAIS</h2>
        <p data-k="justificativas_gerais"></p>
      </section>

      <!-- Força página nova antes das assinaturas -->
      <div class="break-before"></div>

      <!-- Assinaturas -->
      <footer class="term-footer">
        <p class="place-date"><span data-k="ente"></span>/<span data-k="uf"></span>, <span data-k="data_termo"></span>.</p>

        <div class="signature-block">
          <div class="signature-line" aria-hidden="true"></div>
          <p class="signature-caption">
            <strong><span data-k="nome_rep_ente"></span></strong><br>
            <span id="sig-cap-ente">Representante legal do Município de <span data-k="ente"></span>/<span data-k="uf"></span></span>
          </p>
        </div>

        <div class="signature-block">
          <div class="signature-line" aria-hidden="true"></div>
          <p class="signature-caption">
            <strong><span data-k="nome_rep_ug"></span></strong><br>
            Representante legal do <span data-k="ug"></span>
          </p>
        </div>
      </footer>
    </main>
  </div>

  <!-- Modal "Gerando PDF…" -->
  <div id="pdf-modal" class="pdf-modal" aria-hidden="true">
    <div class="pdf-modal__backdrop"></div>
    <div class="pdf-modal__box" role="dialog" aria-modal="true" aria-label="Gerando PDF">
      <div class="pdf-modal__header">Gerando PDF…</div>
      <div class="pdf-modal__body">
        <p>Aguarde, preparando o arquivo.</p>
        <div class="spinner" aria-hidden="true"></div>
      </div>
    </div>
  </div>


  <!-- Script embutido (mantido e INALTERADO em lógica) -->
  <script>
    (function () {
      const $  = (s, r=document) => r.querySelector(s);
      const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));
      /* ===== Fallbacks “Não informado” ===== */
      const __NA_LABEL__ = () =>
        String((window.__TERMO_DATA__ && window.__TERMO_DATA__.__NA_LABEL) || 'Não informado');
      const __NA_ALL__ = () => {
        const d = window.__TERMO_DATA__;
        return (d && Object.prototype.hasOwnProperty.call(d, '__NA_ALL'))
          ? !!d.__NA_ALL : true;
      };
      function fillText(key, val){
        const raw = (val == null) ? '' : String(val);
        const trimmed = raw.trim();
        const s = trimmed || (__NA_ALL__() ? __NA_LABEL__() : '');
        $$('[data-k="'+key+'"]').forEach(el => { el.textContent = s; });
      }
      /* ===== Utilitários ===== */
      function escapeHtml(s){ return String(s||'').replace(/[&<>\"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]); }
      
      function asArr(v){
        if (Array.isArray(v)) return v;
        if (v == null || v === '') return [];
        if (typeof v === 'string') return v.split(/[;,]\s*|\n+/).map(s=>s.trim()).filter(Boolean);
        return [String(v)].filter(Boolean);
      }
      
      function splitLines(s){ return String(s||'').split(/\r?\n/).map(t=>t.trim()).filter(Boolean); }
      
      function liList(sel, arr){
        const ul = document.querySelector(sel);
        if (!ul) return;
        const a = asArr(arr);
        ul.innerHTML = a.length ? a.map(x=>`<li>${x}</li>`).join('') : '<li>Não informado</li>';
      }
      // Helpers "sim/não" → boolean
      function asYes(v){ return ['sim','s','true','1','yes','y'].includes(String(v ?? '').trim().toLowerCase()); }
      function asNo(v){  return ['nao','não','n','false','0','no'].includes(String(v ?? '').trim().toLowerCase()); }

      /* ===== Normalização do payload ===== */
      function normalizePayload(p0){
        const p = Object.assign({}, p0);

        // ===== Mapeamentos básicos
        p.ENTE = p.ENTE ?? p.ente; p.UF = p.UF ?? p.uf; p.UG = p.UG ?? p.ug;
        p.CNPJ_ENTE = p.CNPJ_ENTE ?? p.cnpj_ente; p.CNPJ_UG = p.CNPJ_UG ?? p.cnpj_ug;
        p.EMAIL_ENTE = p.EMAIL_ENTE ?? p.email_ente; p.EMAIL_UG = p.EMAIL_UG ?? p.email_ug;
        p.SEI_PROCESSO = p.SEI_PROCESSO ?? p.sei_processo ?? p.PROC_SEI ?? p.proc_sei ?? '';
        p.PORTARIA_SRPC = p.PORTARIA_SRPC ?? p.portaria_srpc ?? p.PORTARIA_SRPC_MPS ?? '2.024/2025';
        p.ORGAO_VINCULACAO_UG = p.ORGAO_VINCULACAO_UG || p.orgao_vinculacao_ug || p.orgao_vinc_ug || '';

        p.NOME_REP_ENTE = p.NOME_REP_ENTE ?? p.nome_rep_ente;
        p.CARGO_REP_ENTE = p.CARGO_REP_ENTE ?? p.cargo_rep_ente;
        p.CPF_REP_ENTE   = p.CPF_REP_ENTE   ?? p.cpf_rep_ente;
        p.EMAIL_REP_ENTE = p.EMAIL_REP_ENTE ?? p.email_rep_ente;
        p.TEL_REP_ENTE   = p.TEL_REP_ENTE   ?? p.tel_rep_ente;

        p.NOME_REP_UG = p.NOME_REP_UG ?? p.nome_rep_ug;
        p.CARGO_REP_UG = p.CARGO_REP_UG ?? p.cargo_rep_ug;
        p.CPF_REP_UG   = p.CPF_REP_UG   ?? p.cpf_rep_ug;
        p.EMAIL_REP_UG = p.EMAIL_REP_UG ?? p.email_rep_ug;
        p.TEL_REP_UG   = p.TEL_REP_UG   ?? p.tel_rep_ug;
        
        // ===== (3.1 e 3.2) Prefill a partir de p.crp / p.CRP
        const crp = p.crp || p.CRP || {};

        // 3.1 - aceitar várias variantes de nome/formatos de data que o form pode enviar
        p.DATA_VENC_ULTIMO_CRP = p.DATA_VENC_ULTIMO_CRP
          ?? p.data_vencimento_ultimo_crp
          ?? p.data_venc_ult_crp
          ?? crp.data_venc
          ?? crp.data_validade
          ?? crp.DATA_VALIDADE_DMY
          ?? crp.DATA_VALIDADE_ISO
          ?? crp.DATA_VALIDADE
          ?? crp.validade
          ?? crp.vencimento
          ?? '';

        // 3.2 Tipo de emissão - normalizar a partir de várias chaves possíveis
        p.TIPO_EMISSAO_ULTIMO_CRP = (p.TIPO_EMISSAO_ULTIMO_CRP || p.tipo_emissao_ultimo_crp || p.tipo_emissao_ult_crp || p.tipo_emissao || '').trim();
        if (!p.TIPO_EMISSAO_ULTIMO_CRP) {
          const flag = crp.e_judicial ?? crp.tipo_simnao ?? p.CRP_E_JUDICIAL ?? p.CRP_TIPO_SIMNAO ?? crp.emissao ?? crp.tipo_emissao ?? '';
          if (asYes(flag))      p.TIPO_EMISSAO_ULTIMO_CRP = 'Judicial';
          else if (asNo(flag))  p.TIPO_EMISSAO_ULTIMO_CRP = 'Administrativa';
          else {
            // fallback textual
            const txt = String(crp.tipo || crp.emissao || p.tipo || '').trim();
            if (txt) p.TIPO_EMISSAO_ULTIMO_CRP = txt;
          }
        }

        // Mantém compat anterior do 3.1 no template (data-k="venc_ult_crp")
        p.venc_ult_crp = p.venc_ult_crp
          ?? p.DATA_VENC_ULTIMO_CRP
          ?? p.DATA_VENCIMENTO_ULTIMO_CRP
          ?? '';

        // ===== 3.2 (opção textual antiga, se usada)
        p.OPT_3_2 = (p.OPT_3_2 || p.opt_3_2 || '').trim();
        if (!p.OPT_3_2){
          const yes = v => String(v||'').toUpperCase() === 'SIM';
          if (yes(p.FIN_3_2_MANUTENCAO_CONFORMIDADE))   p.OPT_3_2 = '3.2.1';
          else if (yes(p.FIN_3_2_DEFICIT_ATUARIAL))     p.OPT_3_2 = '3.2.2';
          else if (yes(p.FIN_3_2_CRITERIOS_ESTRUTURANTES)) p.OPT_3_2 = '3.2.3';
          else if (yes(p.FIN_3_2_OUTRO_CRITERIO_COMPLEXO)) p.OPT_3_2 = '3.2.4';
        }

        // ===== 3.4 (novo) – código único vindo do form 2 (agora com detecção extra)
        // aceita tanto 3.4.x (novo) quanto 3.2.x (legado) e diversas variantes de chave/valor
        const _rawPrazo = String(
          p.PRAZO_ADICIONAL_COD
          || p.prazo_adicional_cod
          || p.prazo_adicional
          || p.prazo
          || p.OPT_3_4
          || p.opt_3_4
          || p.OPT_3_2
          || ''
        ).trim();

        let _prazo = _rawPrazo || '';

        // se vazio, varre chaves/valores do payload procurando um código 3.4.x ou 3.2.x
        if (!_prazo) {
          for (const k of Object.keys(p0 || p)) {
            const v = String((p0[k] ?? p[k] ?? '')).trim();
            // valor contendo "3.4.1" etc
            const mv = v.match(/(3\.[24]\.\d)/);
            if (mv) { _prazo = mv[1]; break; }
            // chave contendo 3.4.1 ou patterns tipo 3_4_1 ou fPrazo_3_4_1
            const mk = k.match(/(3[._-]?(?:2|4)[._-]?\d|3_4_\d|3_2_\d)/i);
            if (mk) {
              const codeFromKey = mk[0].replace(/_/g, '.').replace(/([^
\d.])/g,'').replace(/\.\{2,}/g,'.');
              // normalizar 3.2.x → 3.4.x
              _prazo = codeFromKey.replace(/^3\.2\.(\d)$/, '3.4.$1');
              break;
            }
            // se valor for número 1..4 assumir 3.4.x (caso legacy envie só '1'..'4')
            if (/^[1-9]$/.test(v)) { _prazo = '3.4.' + v; break; }
          }
        }
        p.PRAZO_ADICIONAL_COD = (_prazo || '').replace(/^3\.2\.(\d)$/, '3.4.$1');
        p.PRAZO_ADICIONAL_TEXTO = p.PRAZO_ADICIONAL_TEXTO || p.prazo_adicional_texto || p.prazo_adicional_desc || '';

        // ===== Critérios irregulares (3.3)
        const candCriterios = (p.CRITERIOS_IRREGULARES || p.CRITERIOS_LIST || p.CRIT_IRREGULARES || p.CRITERIOS || p.CODIGOS_CRITERIOS || p.codigos_criterios || '');
        p.__CRITERIOS_ARR__ = asArr(candCriterios);

        // ===== Fase / demais campos
        p.__FASE_SEL__ = String(
          p.FASE_PROGRAMA
          || p.fase_programa
          || p.FASE
          || p.fase
          || p.fase_selecionada
          || p.fase_codigo
          || p.fase_sel
          || ''
        ).trim();

        // normaliza F41 (remove espaços, acentos e coloca em minúsculas para os testes textuais)
        p.F41_OPCAO = String(p.F41_OPCAO || p.f41_opcao || '').trim();

        // mantém como array (aceita string "A, B, C" ou array nativo)
        p.F42_LISTA = asArr(p.F42_LISTA || p.f42_itens || p.fase42_itens || '');
        p.F43_LISTA = asArr(p.F43_LISTA || p.f43_itens || p.fase43_itens || '');


        p.F44_CRITERIOS   = asArr(p.F44_CRITERIOS   || p.f44_criterios   || p.fase44_criterios   || '');
        p.F44_DECLS       = asArr(p.F44_DECLS       || p.f44_decls       || p.fase44_decls       || '');
        p.F44_FINALIDADES = asArr(p.F44_FINALIDADES || p.f44_finalidades || p.fase44_finalidades || '');
        p.F44_ANEXOS      = p.F44_ANEXOS || p.f44_anexos || p.fase44_anexos || '';

        p.F45_DECLS = asArr(p.F45_DECLS || p.f45_decls || '');
        p.F45_DOCS  = p.F45_DOCS  || p.f45_docs  || '';
        p.F45_JUST  = p.F45_JUST  || p.f45_just  || '';
        p.F45_OK451 = p.F45_OK451 || p.f45_ok451 || false;

        p.F46_CRITERIOS   = asArr(p.F46_CRITERIOS   || p.f46_criterios   || '');
        p.F46_DECLS       = asArr(p.F46_DECLS       || p.f46_decls       || '');
        p.F46_FINALIDADES = asArr(p.F46_FINALIDADES || p.f46_finalidades || '');
        p.F46_ANEXOS      = p.F46_ANEXOS      || p.f46_anexos      || '';
        p.F46_COMP_CUMPR  = p.F46_COMP_CUMPR  || p.f46_comp_cumpr  || '';
        p.F46_JUST_PLANOS = p.F46_JUST_PLANOS || p.f46_just_planos || '';
        p.F46_PROGESTAO = p.F46_PROGESTAO || p.f46_progestao;
        p.F46_PORTE     = p.F46_PORTE     || p.f46_porte;
        p.F46_JUST_D    = p.F46_JUST_D    || p.f46_just_d;
        p.F46_DOCS_D    = p.F46_DOCS_D    || p.f46_docs_d;
        p.F46_JUST_E    = p.F46_JUST_E    || p.f46_just_e;
        p.F46_DOCS_E    = p.F46_DOCS_E    || p.f46_docs_e;

         p.DATA_TERMO_GERADO = p.DATA_TERMO_GERADO || p.DATA || p.DATA_SOLIC_GERADA || '';

        // ===== Fallbacks para 4.1 quando o valor vier em texto compat
        if (!p.F41_OPCAO) {
          const c = String(p.CELEBRACAO_TERMO_PARCELA_DEBITOS || '').trim();
          if (/4\.1\.1/.test(c) || /60\s*parcelas/i.test(c)) p.F41_OPCAO = '4.1.1';
          else if (/4\.1\.2/.test(c) || /(300\s*parcelas|nao possui|não possui)/i.test(c)) p.F41_OPCAO = '4.1.2';
        }

        // --- Fallbacks extras para Fase 4 (quando vierem só campos "compat")
        if (!p.F41_OPCAO) {
          const s = String(p.CELEBRACAO_TERMO_PARCELA_DEBITOS || p.celebracao_termo_parcela_debitos || '').toLowerCase();
          if (s.includes('4.1.1') || s.includes('até 60'))  p.F41_OPCAO = '4.1.1';
          if (s.includes('4.1.2') || s.includes('até 300')) p.F41_OPCAO = '4.1.2';
        }

        // Strings com códigos separadas por “; ” ou linhas → arrays
        const _split = v => Array.isArray(v) ? v : String(v||'').split(/[;\n\r]+/).map(s => s.trim()).filter(Boolean);

        if (!p.F42_LISTA?.length) p.F42_LISTA = _split(p.REGULARIZACAO_PENDEN_ADMINISTRATIVA || p.reg_penden_admin || '');
        if (!p.F43_LISTA?.length) p.F43_LISTA = _split(p.DEFICIT_ATUARIAL || p.deficit_atuarial || '');
        if (!p.F44_CRITERIOS?.length) p.F44_CRITERIOS = _split(p.CRITERIOS_ESTRUT_ESTABELECIDOS || p.criterios_estrut || '');
        if (!p.F46_CRITERIOS?.length) p.F46_CRITERIOS = _split(p.MANUTENCAO_CONFORMIDADE_NORMAS_GERAIS || p.man_conformidade || '');


        // Garante arrays para as fases – evita "Não informado" indevido
        ['F42_LISTA','F43_LISTA','F44_CRITERIOS','F44_DECLS','F44_FINALIDADES',
         'F45_DECLS','F46_CRITERIOS','F46_DECLS','F46_FINALIDADES','F462F_CRITERIOS']
          .forEach(k => { p[k] = asArr(p[k] || p[k.toLowerCase()] || ''); });

        return p;
      }

      function hojeBR_robusto(){
        try{
          const s = new Date().toLocaleDateString('pt-BR');
          if (s && /\d{2}\/:\d{2}\/:\d{4}/.test(s)) return s;
        }catch(_){ }
        const d = new Date();
        const dd = String(d.getDate()).padStart(2,'0');
        const mm = String(d.getMonth()+1).padStart(2,'0');
        const yyyy = String(d.getFullYear());
        return `${dd}/${mm}/${yyyy}`;
      }
      function normalizarEsfera(txt){
        const t = String(txt||'').toLowerCase();
        if (t.includes('estadual') || t.includes('distrit')) return '1.1.2 RPPS Estadual/Distrital';
        if (t.includes('municip')) return '1.1.1 RPPS Municipal';
        return (typeof __NA_ALL__==='function' && __NA_ALL__()) ? __NA_LABEL__() : '—';
      }
      function show(id, v){ const el=document.getElementById(id); if(el) el.hidden=!v; }
      function showOnlyPhase(code){
        const ids = { '4.1':'fase-41','4.2':'fase-42','4.3':'fase-43','4.4':'fase-44','4.5':'fase-45','4.6':'fase-46' };
        Object.values(ids).forEach(id => show(id,false));
        if (ids[code]) show(ids[code], true);
      }
      // segunda função
      function run(payload){
        const p = normalizePayload(payload || {});

        /* 1) Cabeçalho/meta */
        fillText('ente', p.ENTE); fillText('uf', p.UF); fillText('ug', p.UG);
        fillText('cnpj_ente', p.CNPJ_ENTE); fillText('cnpj_ug', p.CNPJ_UG);
        fillText('email_ente', p.EMAIL_ENTE); fillText('email_ug', p.EMAIL_UG);
        fillText('N_GESCON', p.N_GESCON || p.n_gescon || '');
        fillText('DATA_ENC_VIA_GESCON', p.DATA_ENC_VIA_GESCON || p.data_enc_via_gescon || '');
        fillText('SEI_PROCESSO', p.SEI_PROCESSO); fillText('PORTARIA_SRPC', p.PORTARIA_SRPC);

        /* 2) Responsáveis */
        fillText('nome_rep_ente',  p.NOME_REP_ENTE);
        fillText('cargo_rep_ente', p.CARGO_REP_ENTE);
        fillText('cpf_rep_ente',   p.CPF_REP_ENTE);
        fillText('email_rep_ente', p.EMAIL_REP_ENTE);
        fillText('tel_rep_ente',   p.TEL_REP_ENTE);

        fillText('nome_rep_ug',  p.NOME_REP_UG);
        fillText('cargo_rep_ug', p.CARGO_REP_UG);
        fillText('cpf_rep_ug',   p.CPF_REP_UG);
        fillText('email_rep_ug', p.EMAIL_REP_UG);
        fillText('tel_rep_ug',   p.TEL_REP_UG);

        /* 3) CRP */

        fillText('venc_ult_crp', p.venc_ult_crp || '');
        fillText('tipo_emissao_ultimo_crp', p.TIPO_EMISSAO_ULTIMO_CRP || '');

        // 3.1
        fillText('data_vencimento_ultimo_crp',
          p.DATA_VENC_ULTIMO_CRP || p.DATA_VENCIMENTO_ULTIMO_CRP || p.venc_ult_crp || ''
        );

        // 3.2
        fillText('tipo_emissao_ultimo_crp',
          p.TIPO_EMISSAO_ULTIMO_CRP || p.tipo_emissao_ult_crp || p.tipo || ''
        );

        // 3.4 — mostrar somente a alternativa selecionada (USAR APENAS O CÓDIGO, NÃO A FLAG)
        const __prz = String(p.PRAZO_ADICIONAL_COD || '').trim();
        function showOnlyPrazo(code){
          // Mostrar/ocultar com base no atributo data-prz (não removemos elementos)
          document.querySelectorAll('[data-prz]').forEach(n => {
            try {
              n.style.display = (code && (n.getAttribute('data-prz') === code)) ? '' : 'none';
            } catch(e) { /* safe */ }
          });
        }
        // aplica
        showOnlyPrazo(__prz);
        // campo textual opcional do 3.4
        fillText('prz_3_4_escolha', p.PRAZO_ADICIONAL_TEXTO || '');


        // 3.2 (opção antiga "motivo principal", se usar ul#opt-3-2)
        (function(){
          const ul = document.getElementById('opt-3-2'); if (!ul) return;
          const code = (p.OPT_3_2 || '').trim();
          if (code) {
            [...ul.children].forEach(li => { if (li.getAttribute('data-code') !== code) li.remove(); });
          } else {
            ul.innerHTML = '';
            const li = document.createElement('li');
            li.textContent = __NA_LABEL__();
            ul.appendChild(li);
          }
        })();
        
        // 3.4 (novo) – mantém os LIs no DOM e oculta os não selecionados
        (function(){
          const ul = document.getElementById('opt-3-4'); if (!ul) return;
          const code = String(p.PRAZO_ADICIONAL_COD || '').trim(); // ex.: "3.4.1"
          [...ul.children].forEach(li => {
            const attr = (li.getAttribute('data-prz') || li.getAttribute('data-code') || '').trim();
            li.style.display = (code && attr === code) ? '' : 'none';
          });
          // fallback "Não informado" se nenhum visível
          const anyVisible = [...ul.children].some(li => li.style.display === '');
          if (!anyVisible) {
            ul.innerHTML = '';
            const li = document.createElement('li');
            li.textContent = (typeof __NA_LABEL__ === 'function' ? __NA_LABEL__() : 'Não informado');
            ul.appendChild(li);
          }
        })();

        // Helpers
        const listify = v => Array.isArray(v) ? v.filter(Boolean).join('; ') : (v || '');

        // 4. Identificação da fase
        fillText('fase_selecionada', p.FASE_PROGRAMA || p.FASE || '');

        // 4.1 / 4.2 / 4.4 — conteúdos vindos dos modais
        fillText('f41_opcao', p.F41_OPCAO || '');
        fillText('f42_lista', listify(p.F42_LISTA));
        fillText('f43_lista', listify(p.F43_LISTA));
        fillText('f44_criterios', listify(p.F44_CRITERIOS));
        fillText('f44_decls', listify(p.F44_DECLS));
        fillText('f44_finalidades', listify(p.F44_FINALIDADES));

        // Opcional: se vier vazio, esconda o bloco “Não informado"
        ['f41_opcao','f42_lista','f43_lista','f44_criterios','f44_decls','f44_finalidades'].forEach(id=>{
          const el = document.getElementById(id);
          if (el && !el.textContent.trim()) {
            const wrap = el.closest('.termo-bloco, .linha, li, p') || el;
            wrap.style.display = 'none';
          }
        });

        // 3.3
        liList('#criterios-list', p.__CRITERIOS_ARR__);

        /* 4) Fase */
        const faseSel = p.__FASE_SEL__; fillText('fase_programa', faseSel || '—'); showOnlyPhase(faseSel);
        switch (faseSel) {
          case '4.1': {
            const it = [];
            const code = String(p.F41_OPCAO || '').trim(); // "4.1.1" ou "4.1.2"
            if (code === '4.1.1') it.push('4.1.1 Incluiu todos os débitos (Cadprev).');
            if (code === '4.1.2') it.push('4.1.2 Não possui débitos ou já regularizados.');
            liList('#f41-itens', it);
            break;
          }
          case '4.2': liList('#f42-itens', p.F42_LISTA); break;
          case '4.3': {
            liList('#f43-itens', p.F43_LISTA);
            fillText('f43_just',  p.F43_JUST  || '');
            fillText('f43_plano', p.F43_PLANO || '');

            (function(){
              const box = document.getElementById('f4310'); if(!box) return;
              const items = [];
              if (p.F4310_OPCAO)      items.push('Opção: ' + p.F4310_OPCAO);
              if (p.F4310_LEGISLACAO) items.push('Legislação: ' + p.F4310_LEGISLACAO);
              if (p.F4310_DOCS)       items.push('Docs: ' + p.F4310_DOCS);
              liList('#f4310', items);
            })();

            liList('#f43-incluir', p.F43_INCLUIR);
            break;
          }
          case '4.4': {
            liList('#f44-criterios',   p.F44_CRITERIOS);
            liList('#f44_decls',       p.F44_DECLS);
            liList('#f44-finalidades', p.F44_FINALIDADES);

            const ax = splitLines(p.F44_ANEXOS || '');
            const box = document.getElementById('f44-anexos');
            if (box) box.innerHTML = ax.length ? '<ul>'+ax.map(a=>'<li>'+escapeHtml(a)+'</li>').join('')+'</ul>' : `<span class="muted">${__NA_ALL__() ? escapeHtml(__NA_LABEL__()) : '—'}</span>`;

            fillText('f441_legislacao', p.F441_LEGISLACAO || '');

            (function(){
              const d = splitLines(p.F446_DOCS || '');
              const e = splitLines(p.F446_EXEC_RES || '');
              const dBox = document.getElementById('f446-docs');
              const eBox = document.getElementById('f446-exec');
              if (dBox) dBox.innerHTML = d.length ? '<ul>'+d.map(a=>'<li>'+escapeHtml(a)+'</li>').join('')+'</ul>' : `<span class="muted">${__NA_ALL__()?escapeHtml(__NA_LABEL__()):'—'}</span>`;
              if (eBox) eBox.innerHTML = e.length ? '<ul>'+e.map(a=>'<li>'+escapeHtml(a)+'</li>').join('')+'</ul>' : `<span class="muted">${__NA_ALL__()?escapeHtml(__NA_LABEL__()):'—'}</span>`;
            })();
            break;
          }
          case '4.5': {
            const decls = p.F45_OK451 ? ['4.5.1 Mantida a regularidade das fases anteriores.'] : [];
            liList('#f45-decls', decls);
            const d = splitLines(p.F45_DOCS || '');
            const j = splitLines(p.F45_JUST || '');
            const docsBox = document.getElementById('f45-docs');
            const justBox = document.getElementById('f45-just');
            if (docsBox) docsBox.innerHTML = d.length ? '<ul>'+d.map(a=>'<li>'+escapeHtml(a)+'</li>').join('')+'</ul>' : `<span class="muted">${__NA_ALL__ ? escapeHtml(__NA_LABEL__()) : '—'}</span>`;
            if (justBox) justBox.innerHTML = j.length ? '<ul>'+j.map(a=>'<li>'+escapeHtml(a)+'</li>').join('')+'</ul>' : `<span class="muted">${__NA_ALL__() ? escapeHtml(__NA_LABEL__()) : '—'}</span>`;
            break;
          }
          case '4.6': {
            liList('#f46-criterios',   p.F46_CRITERIOS);
            const decls = [];
            if (Array.isArray(p.F46_DECLS)) decls.push(...p.F46_DECLS);
            if (p.F46_PROGESTAO) decls.push('Nível Pró-Gestão RPPS: ' + p.F46_PROGESTAO);
            if (p.F46_PORTE)     decls.push('Grupo de Porte (ISP-RPPS): ' + p.F46_PORTE);
            if (p.F46_JUST_D)    decls.push('(d) Justificativas: ' + p.F46_JUST_D);
            if (p.F46_DOCS_D)    decls.push('(d) Documentos: ' + p.F46_DOCS_D);
            if (p.F46_JUST_E)    decls.push('(e) Justificativas: ' + p.F46_JUST_E);
            if (p.F46_DOCS_E)    decls.push('(e) Documentos: ' + p.F46_DOCS_E);
            liList('#f46-decls', decls);

            liList('#f46-finalidades', p.F46_FINALIDADES);

            const ax = splitLines(p.F46_ANEXOS || '');
            const axBox = document.getElementById('f46-anexos');
            if (axBox) axBox.innerHTML = ax.length ? '<ul>'+ax.map(a=>'<li>'+escapeHtml(a)+'</li>').join('')+'</ul>' : `<span class="muted">${__NA_ALL__() ? escapeHtml(__NA_LABEL__()) : '—'}</span>`;

            const jp = document.getElementById('f46-just-planos');
            const cc = document.getElementById('f46-comp-cumpr');
            if (jp) jp.textContent = (p.F46_JUST_PLANOS || '') || (__NA_ALL__() ? __NA_LABEL__() : '—');
            if (cc) cc.textContent = (p.F46_COMP_CUMPR  || '') || (__NA_ALL__() ? __NA_LABEL__() : '—');

            liList('#f462f-criterios', p.F462F_CRITERIOS);

            (function(){
              const d = splitLines(p.F466_DOCS || '');
              const e = splitLines(p.F466_EXEC_RES || '');
              const dBox = document.getElementById('f466-docs');
              const eBox = document.getElementById('f466-exec');
              if (dBox) dBox.innerHTML = d.length ? '<ul>'+d.map(a=>'<li>'+escapeHtml(a)+'</li>').join('')+'</ul>' : `<span class="muted">${__NA_ALL__()?escapeHtml(__NA_LABEL__()):'—'}</span>`;
              if (eBox) eBox.innerHTML = e.length ? '<ul>'+e.map(a=>'<li>'+escapeHtml(a)+'</li>').join('')+'</ul>' : `<span class="muted">${__NA_ALL__()?escapeHtml(__NA_LABEL__()):'—'}</span>`;
            })();
            break;
          }
        }

        /* 5) Justificativas gerais */
        fillText('justificativas_gerais', p.JUSTIFICATIVAS_GERAIS || '');

        /* 6) Data/assinaturas */
        const preferida = (p.DATA_TERMO_GERADO || '').trim();
        fillText('data_termo', preferida || hojeBR_robusto());
        const dataNode = document.querySelector('[data-k="data_termo"]');
        if (dataNode && !dataNode.textContent.trim()) dataNode.textContent = hojeBR_robusto();

        /* 7) Esfera 1.1 + legenda assinatura dinâmica */
        const esferaTxt = normalizarEsfera(p.ESFERA || p.ESFERA_GOVERNO || p.ESFERA_SUGERIDA || p.fase_esfera);
        const esferaNode = document.querySelector('[data-esfera]');
        if (esferaNode) esferaNode.textContent = esferaTxt;
        const esferaTitulo = document.querySelector('h3 .label');
        if (esferaTitulo) esferaTitulo.textContent = '1.1 Esfera de Governo';
        (function(){
          const sig = document.getElementById('sig-cap-ente');
          if (sig) {
            const isEstDistr = /Estadual\/Distrital/i.test(esferaTxt);
            sig.innerHTML = isEstDistr
              ? 'Representante legal do Estado/Distrito de <span data-k="ente"></span>/<span data-k="uf"></span>'
              : 'Representante legal do Município de <span data-k="ente"></span>/<span data-k="uf"></span>';
            fillText('ente', p.ENTE); fillText('uf', p.UF);
          }
        })();

        /* pronto para imprimir */
        try{
          if (!window.__TERMO_READY_FIRED__) {
            window.__TERMO_READY_FIRED__ = true;
            const fontsReady = (document.fonts && document.fonts.ready) ? document.fonts.ready : Promise.resolve();
            const maxWait = new Promise(r => setTimeout(r, 1500));
            Promise.race([fontsReady, maxWait]).finally(() => {
              requestAnimationFrame(() => {
                window.__TERMO_PRINT_READY__ = true;
                document.dispatchEvent(new CustomEvent('TERMO_PRINT_READY'));
              });
            });
          }
        }catch(_){ }
      }

      /* Modal PDF (abrir/fechar) */
      window.ModalPDF = {
        open(){ document.getElementById('pdf-modal')?.classList.add('pdf-modal--open'); },
        close(){ document.getElementById('pdf-modal')?.classList.remove('pdf-modal--open'); }
      };
      /* Exposição pública */
      window.__TERMO_RUN__ = run;
      /* Injeções de dados */
      (function injectFromQueryIfPresent(){
        try{
          const qs = new URLSearchParams(window.location.search || '');
          if ([...qs.keys()].length) {
            const obj = {}; qs.forEach((v,k)=>{ obj[k]=v; });
            window.__TERMO_DATA__ = Object.assign({}, window.__TERMO_DATA__ || {}, obj);
            try { run(window.__TERMO_DATA__); } catch(_){ }
          }
        }catch(_){ }
      })();
      if (window.__TERMO_DATA__) { try { run(window.__TERMO_DATA__); } catch {} }
      document.addEventListener('TERMO_DATA_READY', () => { try { run(window.__TERMO_DATA__ || {}); } catch {} });
      document.addEventListener('TERMO_DATA',       () => { try { run(window.__TERMO_DATA__ || {}); } catch {} });
      window.addEventListener('message', (ev) => {
          const d = ev && ev.data;
          if (!d) return;
          // aceita os tipos que o gerador pode enviar
          if (d.type === 'TERMO_DATA' || d.type === 'TERMO_DATA_READY' || d.type === 'TERMO_PREVIEW_DATA') {
            try { run(d.payload || {}); } catch (_) {}
          }
        });
      (function spinWait(maxMs=4000, step=120){
        const t0 = Date.now();
        const iv = setInterval(() => {
          if (window.__TERMO_DATA__) {
            try { run(window.__TERMO_DATA__); } catch {}
            clearInterval(iv);
          } else if (Date.now() - t0 > maxMs) {
            clearInterval(iv);
          }
        }, step);
      })();
    })();
  </script>


  <!-- Força fallback “Não informado” também no preview local -->
  <script>
    window.__TERMO_DATA__ = Object.assign({ __NA_ALL: true, __NA_LABEL: 'Não informado' }, window.__TERMO_DATA__ || {});
  </script>

  <script>
    /* MARCADOR: REMOVED_DUPLICATE_PRZ_TOGGLE */
    /* Removido: toggle duplicado que conflituava com a lógica principal de exibição de #opt-3-4.
       Lógica centralizada em run() acima. */
  </script>


</body>
</html>